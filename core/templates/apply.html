{% extends "core_base.html" %}
{% block core_content %}
{% load static %}

<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Cropper.js CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" integrity="sha512-0SPWAwpC/17yYyZ/4HSllgaK7/gg9OlVozq8K7rf3J8LvCjYEEIfzzpnA2/SSjpGIunCSD18r3UhvDcu/xncJAA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Bootstrap CSS (assumed in core_base.html, added explicitly for clarity) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

<style>
    :root {
        --primary: #D27328;
        --light: #fff5ee;
        --dark: #181d38;
    }
    .admission-step {
        border-left: 4px solid var(--primary);
        padding-left: 15px;
        margin-bottom: 30px;
    }
    .program-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: all 0.3s;
        margin-bottom: 15px;
    }
    .program-card:hover {
        border-color: var(--primary);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .program-card.active {
        border-color: var(--primary);
        background-color: rgba(210, 115, 40, 0.05);
    }
    .nav-pills .nav-link.active {
        background-color: var(--primary);
    }
    .form-section {
        display: none;
    }
    .form-section.active {
        display: block;
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .badge-open {
        background-color: #28a745;
    }
    .faculty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    .error {
        color: #dc3545 !important;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    .is-invalid {
        border-color: #dc3545 !important;
    }
    .form-control-lg, .form-select-lg {
        padding: 0.5rem 1rem;
        font-size: 1.1rem;
    }
    .photo-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
        display: none;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .crop-modal .modal-dialog {
        max-width: 800px;
    }
    .crop-modal .img-container {
        max-height: 400px;
        width: 100%;
        overflow: hidden;
    }
    .crop-modal .img-container img {
        max-width: 100%;
        display: block;
    }
</style>

<!-- Navbar Start -->
<nav class="navbar navbar-expand-lg bg-white navbar-light shadow sticky-top p-0">
    <!-- User Icon and Name -->
    <div class="d-flex align-items-center me-auto px-4">
        <i class="fa fa-user fa-lg me-2 text-primary"></i>
        <span class="fw-bold">{{ request.user.get_full_name|default:request.user.first_name }} {{ request.user.last_name }}</span>
    </div>

    <!-- Toggle Button for Mobile -->
    <button class="navbar-toggler me-4" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar Links -->
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <div class="navbar-nav ms-auto">
            <a href="{% url 'my_applications' %}" class="nav-item nav-link {% if request.path == '/apply/my-applications/' %}active{% endif %}">My Applications</a>
            <a href="{% url 'apply' %}" class="nav-item nav-link {% if request.path == '/apply/' %}active{% endif %}">Application Form</a>
            <a href="{% url 'home' %}" class="btn btn-primary py-4 px-lg-5 d-none d-lg-block">
                Go Back<i class="fa fa-arrow-right ms-3"></i>
            </a>
            <!-- Mobile version of Go Back button -->
            <a href="{% url 'home' %}" class="nav-item nav-link d-lg-none">Go Back</a>
        </div>
    </div>
</nav>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="text-center mb-4">Online Admission Portal</h2>

            {% if not user.is_authenticated %}
                <div class="alert alert-warning text-center">
                    <h4>Please Log In</h4>
                    <p>You must be logged in to submit an application.</p>
                    <a href="{% url 'login' %}?next={% url 'apply' %}" class="btn btn-primary">Log In</a>
                </div>
            {% else %}

            <!-- Progress Steps -->
            <ul class="nav nav-pills mb-4 justify-content-center" id="progressSteps">
                <li class="nav-item">
                    <a class="nav-link nv-pill active" id="step1-tab" data-bs-toggle="pill" href="#step1">1. Faculty</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nv-pill disabled" id="step2-tab" data-bs-toggle="pill" href="#step2">2. Department</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nv-pill disabled" id="step3-tab" data-bs-toggle="pill" href="#step3">3. Program</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link nv-pill disabled" id="step4-tab" data-bs-toggle="pill" href="#step4">4. Application</a>
                </li>
            </ul>

            <!-- Form Sections -->
            <div class="tab-content">
                <!-- Step 1: Faculty Selection -->
                <div class="tab-pane fade show active" id="step1">
                    <div class="admission-step">
                        <h4><i class="fas fa-university me-2"></i>Select Faculty</h4>
                        <p class="text-muted">Choose the faculty that offers your desired program</p>
                        <div class="row mt-4" id="facultyContainer">
                            {% for faculty in faculties %}
                            <div class="col-md-4 mb-3">
                                <div class="card program-card" data-faculty="{{ faculty.id }}"
                                     data-faculty-name="{{ faculty.name }}">
                                    <div class="card-body text-center">
                                        <i class="fas {{ faculty.icon|default:'fa-building' }} faculty-icon text-primary"></i>
                                        <h5>{{ faculty.name }}</h5>
                                        <p class="text-muted">{{ faculty.description|truncatechars:50 }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="text-end mt-4">
                        <button class="btn btn-primary" id="toStep2" disabled>Next <i
                                class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 2: Department Selection -->
                <div class="tab-pane fade" id="step2">
                    <div class="admission-step">
                        <h4><i class="fas fa-building me-2"></i>Select Department</h4>
                        <p class="text-muted" id="selectedFacultyText">Faculty: <span id="displayFaculty"></span></p>
                        <div class="row mt-4" id="departmentContainer">
                            <!-- Departments will be loaded here via AJAX -->
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary" id="backToStep1"><i
                                class="fas fa-arrow-left me-2"></i> Back</button>
                        <button class="btn btn-primary" id="toStep3" disabled>Next <i
                                class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 3: Program Selection -->
                <div class="tab-pane fade" id="step3">
                    <div class="admission-step">
                        <h4><i class="fas fa-graduation-cap me-2"></i>Select Program</h4>
                        <p class="text-muted" id="selectedDeptText">Department: <span id="displayDepartment"></span></p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Only programs with open admissions are shown
                        </div>
                        <div class="row mt-4" id="programContainer">
                            <!-- Programs will be loaded here via AJAX -->
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary" id="backToStep2"><i
                                class="fas fa-arrow-left me-2"></i> Back</button>
                        <button class="btn btn-primary" id="toStep4" disabled>Next <i
                                class="fas fa-arrow-right ms-2"></i></button>
                    </div>
                </div>

                <!-- Step 4: Application Form -->
                <div class="tab-pane fade" id="step4">
                    <div class="admission-step">
                        <h4><i class="fas fa-file-alt me-2"></i>Admission Form</h4>
                        <p class="text-muted" id="selectedProgramText">Applying for: <span id="displayProgram"></span></p>
                        <form id="admissionForm" method="POST" enctype="multipart/form-data" action="{% url 'submit_application' %}">
                            {% csrf_token %}
                            <input type="hidden" id="selectedFacultyId" name="faculty">
                            <input type="hidden" id="selectedDepartmentId" name="department">
                            <input type="hidden" id="selectedProgramId" name="program">

                            <!-- Applicant Details Section -->
                            <div class="card mb-4 border-0">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0 text-white">Applicant Details</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <label for="applicantPhoto" class="form-label text-dark">Recent Photograph</label>
                                            <input type="file" class="form-control form-control-lg" id="applicantPhoto"
                                                   name="applicant_photo" accept="image/*" required>
                                            <img id="photoPreview" class="photo-preview" alt="Photo Preview">
                                            <button type="button" class="btn btn-primary mt-2" id="cropPhotoButton" style="display: none;">Crop Photo</button>
                                        </div>
                                    </div>
                                    <div class="row mb-4 g-3">
                                        <div class="col-md-4">
                                            <label for="fullName" class="form-label text-dark">Full Name</label>
                                            <input type="text" class="form-control form-control-lg" id="fullName"
                                                   name="full_name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="religion" class="form-label text-dark">Religion</label>
                                            <input type="text" class="form-control form-control-lg" id="religion"
                                                   name="religion" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="caste" class="form-label text-dark">Caste</label>
                                            <input type="text" class="form-control form-control-lg" id="caste"
                                                   name="caste" required>
                                        </div>
                                    </div>
                                    <div class="row mb-4 g-3">
                                        <div class="col-md-4">
                                            <label for="cnic" class="form-label text-dark">CNIC No.</label>
                                            <input type="text" class="form-control form-control-lg" id="cnic"
                                                   name="cnic" placeholder="XXXXX-XXXXXXX-X" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="dob" class="form-label text-dark">Date of Birth</label>
                                            <input type="date" class="form-control form-control-lg" id="dob" name="dob"
                                                   required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="contactNo" class="form-label text-dark">Contact No.</label>
                                            <input type="tel" class="form-control form-control-lg" id="contactNo"
                                                   name="contact_no" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="identificationMark" class="form-label text-dark">Identification Mark</label>
                                            <textarea class="form-control form-control-lg" id="identificationMark"
                                                      name="identification_mark" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Father/Guardian Details Section -->
                            <div class="card mb-4 border-0">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0 text-white">Father/Guardian Details</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-4 g-3">
                                        <div class="col-md-4">
                                            <label for="fatherName" class="form-label text-dark">Full Name</label>
                                            <input type="text" class="form-control form-control-lg" id="fatherName"
                                                   name="father_name" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="fatherOccupation" class="form-label text-dark">Occupation</label>
                                            <input type="text" class="form-control form-control-lg" id="fatherOccupation"
                                                   name="father_occupation" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="fatherCnic" class="form-label text-dark">CNIC No.</label>
                                            <input type="text" class="form-control form-control-lg" id="fatherCnic"
                                                   name="father_cnic" placeholder="XXXXX-XXXXXXX-X" required>
                                        </div>
                                    </div>
                                    <div class="row mb-4 g-3">
                                        <div class="col-md-6">
                                            <label for="monthlyIncome" class="form-label text-dark">Monthly Income</label>
                                            <input type="number" class="form-control form-control-lg" id="monthlyIncome"
                                                   name="monthly_income" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="relationship" class="form-label text-dark">Relationship with Applicant</label>
                                            <select class="form-select form-select-lg" id="relationship"
                                                    name="relationship" required>
                                                <option value="">Select</option>
                                                <option value="father">Father</option>
                                                <option value="guardian">Guardian</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label for="permanentAddress" class="form-label text-dark">Permanent Address</label>
                                            <textarea class="form-control form-control-lg" id="permanentAddress"
                                                      name="permanent_address" rows="3" required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Academic Qualifications Section -->
                            <div class="card mb-4 border-0">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0 text-white">Academic Qualifications</h4>
                                </div>
                                <div class="card-body">
                                    <div id="academicQualificationsContainer">
                                        <!-- Initial row for academic qualification -->
                                        <div class="academic-qualification-row mb-4" data-index="0">
                                            <input type="hidden" name="academic_levels[]" value="">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label for="academic_degree_0" class="form-label text-dark">Degree Name</label>
                                                    <input type="text" class="form-control form-control-lg" id="academic_degree_0" name="academic_degree[]" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="academic_board_0" class="form-label text-dark">Board/University</label>
                                                    <input type="text" class="form-control form-control-lg" id="academic_board_0" name="academic_board[]" required>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="academic_passing_year_0" class="form-label text-dark">Passing Year</label>
                                                    <input type="number" class="form-control form-control-lg" id="academic_passing_year_0" name="academic_passing_year[]" required>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="academic_total_marks_0" class="form-label text-dark">Total Marks</label>
                                                    <input type="number" class="form-control form-control-lg" id="academic_total_marks_0" name="academic_total_marks[]" required>
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="academic_marks_obtained_0" class="form-label text-dark">Marks Obtained</label>
                                                    <input type="number" class="form-control form-control-lg" id="academic_marks_obtained_0" name="academic_marks_obtained[]" required>
                                                </div>
                                            </div>
                                            <div class="row g-3 mt-3">
                                                <div class="col-md-3">
                                                    <label for="academic_grade_0" class="form-label text-dark">Grade/Division/CGPA</label>
                                                    <input type="text" class="form-control form-control-lg" id="academic_grade_0" name="academic_grade[]" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="academic_major_0" class="form-label text-dark">Major Subject</label>
                                                    <input type="text" class="form-control form-control-lg" id="academic_major_0" name="academic_major[]" required>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-danger mt-4 remove-academic-row" style="display: none;">Remove</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary mt-3" id="addAcademicRow">Add Another Qualification</button>
                                </div>
                            </div>

                            <!-- Extra Curricular Activities Section -->
                            <div class="card mb-4 border-0">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0 text-white">Extra Curricular Activities</h4>
                                </div>
                                <div class="card-body">
                                    <div id="extraActivitiesContainer">
                                        <!-- Initial row for extra-curricular activity -->
                                        <div class="extra-activity-row mb-4" data-index="0">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label for="activity_0" class="form-label text-dark">Activity</label>
                                                    <input type="text" class="form-control form-control-lg" id="activity_0" name="activity[]">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="position_0" class="form-label text-dark">Position/Role</label>
                                                    <input type="text" class="form-control form-control-lg" id="position_0" name="position[]">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="achievement_0" class="form-label text-dark">Achievements</label>
                                                    <input type="text" class="form-control form-control-lg" id="achievement_0" name="achievement[]">
                                                </div>
                                                <div class="col-md-2">
                                                    <label for="activity_year_0" class="form-label text-dark">Year</label>
                                                    <input type="number" class="form-control form-control-lg" id="activity_year_0" name="activity_year[]">
                                                </div>
                                                <div class="col-md-1">
                                                    <button type="button" class="btn btn-danger mt-4 remove-activity-row" style="display: none;">Remove</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary mt-3" id="addActivityRow">Add Another Activity</button>
                                </div>
                            </div>

                            <!-- Declaration Section -->
                            <div class="form-check mb-4">
                                <input class="form-check-input" type="checkbox" id="declaration" name="declaration" required>
                                <label class="form-check-label text-dark" for="declaration">
                                    I declare that all information provided is correct and complete. I understand that
                                    providing false information may result in cancellation of admission.
                                </label>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg py-3">Submit Application</button>
                            </div>
                        </form>
                    </div>
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-secondary" id="backToStep3"><i
                                class="fas fa-arrow-left me-2"></i> Back</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Crop Modal -->
<div class="modal fade crop-modal" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cropModalLabel">Crop Photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="img-container" style="max-height: 400px; width: 100%;">
                    <img id="imageToCrop" src="" alt="Image to crop" style="max-width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="cropImage">Crop and Save</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<!-- Cropper.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js" integrity="sha512-ooSWpxN3pVf6SXpYV6G5D5oH2L5QKHcLaVex0qolz3zrlgL66uO2qBP5oRN2sCxfuK2kS5gS6nK+0x8DJHL+g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Define the submit URL using Django's URL template tag
const submitUrl = "{% url 'submit_application' %}";

// Current selection tracking
let currentSelection = {
    faculty: null,
    facultyName: null,
    department: null,
    departmentName: null,
    program: null,
    programName: null
};

// Cropper instance
let cropper;
let croppedImageBlob;

// Function to update the visible step
function showStep(stepId, stepTabId) {
    $('.tab-pane').removeClass('show active');
    $(`#${stepId}`).addClass('show active');
    $('.nv-pill').removeClass('active completed').addClass('disabled');
    $(`#${stepTabId}`).removeClass('disabled').addClass('active');
    for (let i = 1; i < parseInt(stepId.replace('step', '')); i++) {
        $(`#step${i}-tab`).removeClass('disabled').addClass('completed');
    }
}

// Function to show step without updating URL
function navigateToStep(stepId, stepTabId, urlPath) {
    showStep(stepId, stepTabId);
    if (window.location.protocol !== 'about:' && window.location.origin) {
        try {
            history.replaceState({ stepId, stepTabId }, '', urlPath);
        } catch (e) {
            console.warn('History state update failed:', e.message);
        }
    }
}

// Photo preview and crop functionality
$('#applicantPhoto').on('change', function(e) {
    console.log('Photo input changed at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));
    const file = e.target.files[0];
    if (file) {
        if (!file.type.startsWith('image/')) {
            console.error('Invalid file type:', file.type);
            alert('Please upload a valid image file (e.g., JPG, PNG).');
            this.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            console.log('Image loaded for preview, data URL length:', e.target.result.length);
            $('#photoPreview').attr('src', e.target.result).show();
            $('#cropPhotoButton').show();
            $('#imageToCrop').attr('src', e.target.result);
        };
        reader.onerror = function(e) {
            console.error('Error reading file:', e);
            alert('Failed to read the image file. Please try another image.');
        };
        reader.readAsDataURL(file);
    } else {
        console.log('No file selected');
        $('#photoPreview').hide();
        $('#cropPhotoButton').hide();
        $('#imageToCrop').attr('src', '');
    }
});

$('#cropPhotoButton').on('click', function() {
    console.log('Crop Photo button clicked');
    if (!$('#imageToCrop').attr('src') || $('#imageToCrop').attr('src') === window.location.href) {
        console.error('No valid image source for cropping');
        alert('Please upload an image first.');
        return;
    }
    $('#cropModal').modal('show');
});

$('#cropModal').on('shown.bs.modal', function() {
    console.log('Crop modal shown, initializing Cropper at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));
    const image = document.getElementById('imageToCrop');
    if (!image.src || image.src === window.location.href) {
        console.error('No valid image source for Cropper');
        alert('No image available to crop.');
        $('#cropModal').modal('hide');
        return;
    }
    if (cropper) {
        cropper.destroy();
        console.log('Previous Cropper instance destroyed');
    }
    try {
        cropper = new Cropper(image, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 0.8,
            responsive: true,
            background: false,
            zoomable: true,
            scalable: true,
            rotatable: true,
            ready: function() {
                console.log('Cropper initialized successfully');
            },
            error: function(e) {
                console.error('Cropper error:', e);
            }
        });
    } catch (e) {
        console.error('Cropper initialization failed:', e);
        alert('Failed to initialize image cropper. Please try again.');
        $('#cropModal').modal('hide');
    }
});

$('#cropImage').on('click', function() {
    console.log('Crop and Save button clicked at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));
    if (!cropper) {
        console.error('Cropper not initialized');
        alert('Cropper is not initialized. Please try again.');
        return;
    }
    try {
        cropper.getCroppedCanvas({
            width: 200,
            height: 200,
            imageSmoothingQuality: 'high'
        }).toBlob(function(blob) {
            if (!blob) {
                console.error('Failed to generate cropped image blob');
                alert('Failed to crop the image. Please try again.');
                return;
            }
            console.log('Cropped image blob generated, size:', blob.size, 'bytes');
            croppedImageBlob = blob;

            // Update preview with cropped image
            const url = URL.createObjectURL(blob);
            $('#photoPreview').attr('src', url).show();
            console.log('Preview updated with cropped image');

            // Create a new file from blob for form submission
            const file = new File([blob], 'cropped_photo.jpg', { type: 'image/jpeg', lastModified: Date.now() });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            const photoInput = document.getElementById('applicantPhoto');
            photoInput.files = dataTransfer.files;
            console.log('File input updated, files:', photoInput.files.length, 'file name:', photoInput.files[0]?.name);

            $('#cropModal').modal('hide');
            console.log('Crop modal closed');
        }, 'image/jpeg', 0.95);
    } catch (e) {
        console.error('Error during cropping:', e);
        alert('Error cropping image. Please try again.');
    }
});

$('#cropModal').on('hidden.bs.modal', function() {
    console.log('Crop modal hidden');
    if (cropper) {
        cropper.destroy();
        cropper = null;
        console.log('Cropper destroyed on modal hide');
    }
});

// Step 1: Faculty Selection
$('.program-card[data-faculty]').click(function () {
    $('.program-card').removeClass('active');
    $(this).addClass('active');
    currentSelection.faculty = $(this).data('faculty');
    currentSelection.facultyName = $(this).data('faculty-name');
    $('#toStep2').prop('disabled', false);
});

// Step 2: Department Selection
$('#toStep2').click(function () {
    if (!currentSelection.faculty) return;
    $('#displayFaculty').text(currentSelection.facultyName);
    $('#selectedFacultyId').val(currentSelection.faculty);

    $.ajax({
        url: "{% url 'get_departments' %}",
        method: 'GET',
        data: { faculty_id: currentSelection.faculty },
        success: function (response) {
            let departmentsHtml = '';
            response.departments.forEach(dept => {
                departmentsHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card program-card department-card" 
                             data-dept="${dept.id}" 
                             data-dept-name="${dept.name}">
                            <div class="card-body">
                                <h5>${dept.name}</h5>
                                <p class="text-muted">${dept.program_count} program(s)</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#departmentContainer').html(departmentsHtml);

            $('.department-card').click(function () {
                $('.department-card').removeClass('active');
                $(this).addClass('active');
                currentSelection.department = $(this).data('dept');
                currentSelection.departmentName = $(this).data('dept-name');
                $('#toStep3').prop('disabled', false);
            });
        },
        error: function (xhr) {
            console.error('Department AJAX error:', xhr);
            alert("Error loading departments: " + (xhr.responseJSON?.message || "Please try again."));
        }
    });

    navigateToStep('step2', 'step2-tab', '/apply/department/');
});

// Step 3: Program Selection
$('#toStep3').click(function () {
    if (!currentSelection.department) {
        alert("Please select a department before proceeding.");
        return;
    }
    $('#displayDepartment').text(currentSelection.departmentName);
    $('#selectedDepartmentId').val(currentSelection.department);

    $.ajax({
        url: "{% url 'get_programs' %}",
        method: 'GET',
        data: { department_id: currentSelection.department },
        success: function (response) {
            let programsHtml = '';
            if (response.length === 0) {
                programsHtml = '<div class="col-12"><p class="text-muted">No programs available for this department.</p></div>';
                $('#toStep4').prop('disabled', true);
            } else {
                response.forEach(program => {
                    if (program.is_open) {
                        programsHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card program-card program-option" 
                                     data-program="${program.id}" 
                                     data-program-name="${program.name}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <h5>${program.name}</h5>
                                            <span class="badge badge-open">Open</span>
                                        </div>
                                        <p class="text-muted mt-2">${program.duration || '4-year'} degree program</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            $('#programContainer').html(programsHtml);

            $('#programContainer').off('click', '.program-option').on('click', '.program-option', function () {
                $('.program-option').removeClass('active');
                $(this).addClass('active');
                currentSelection.program = $(this).data('program');
                currentSelection.programName = $(this).data('program-name');
                $('#toStep4').prop('disabled', false);
                console.log('Selected Program:', currentSelection.program, currentSelection.programName);
            });

            $('#toStep4').prop('disabled', true);
        },
        error: function (xhr) {
            console.error('Program AJAX error:', xhr);
            alert("Error loading programs: " + (xhr.responseJSON?.message || "Please try again."));
            $('#programContainer').html('<div class="col-12"><p class="text-danger">Failed to load programs.</p></div>');
            $('#toStep4').prop('disabled', true);
        }
    });

    navigateToStep('step3', 'step3-tab', '/apply/program/');
});

// Step 4: Application Form
$('#toStep4').click(function () {
    if (!currentSelection.program) return;
    $('#displayProgram').text(currentSelection.programName);
    $('#selectedProgramId').val(currentSelection.program);
    navigateToStep('step4', 'step4-tab', '/apply/form/');
});

// Back buttons
$('#backToStep1').click(function () {
    navigateToStep('step1', 'step1-tab', '/apply/faculty/');
});

$('#backToStep2').click(function () {
    navigateToStep('step2', 'step2-tab', '/apply/department/');
});

$('#backToStep3').click(function () {
    navigateToStep('step3', 'step3-tab', '/apply/program/');
});

// Handle browser back/forward navigation
window.addEventListener('popstate', function (event) {
    if (event.state && event.state.stepId && event.state.stepTabId) {
        showStep(event.state.stepId, event.state.stepTabId);
    } else {
        showStep('step1', 'step1-tab');
    }
});

// Initialize URL on page load
if (window.location.protocol !== 'about:' && window.location.origin) {
    try {
        history.replaceState({ stepId: 'step1', stepTabId: 'step1-tab' }, '', '/apply/');
    } catch (e) {
        console.warn('Initial history state update failed:', e.message);
    }
}

// Dynamic Academic Qualifications
let academicIndex = 0;
$('#addAcademicRow').click(function () {
    academicIndex++;
    const newRow = `
        <div class="academic-qualification-row mb-4" data-index="${academicIndex}">
            <input type="hidden" name="academic_levels[]" value="">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="academic_degree_${academicIndex}" class="form-label text-dark">Degree Name</label>
                    <input type="text" class="form-control form-control-lg" id="academic_degree_${academicIndex}" name="academic_degree[]" required>
                </div>
                <div class="col-md-3">
                    <label for="academic_board_${academicIndex}" class="form-label text-dark">Board/University</label>
                    <input type="text" class="form-control form-control-lg" id="academic_board_${academicIndex}" name="academic_board[]" required>
                </div>
                <div class="col-md-2">
                    <label for="academic_passing_year_${academicIndex}" class="form-label text-dark">Passing Year</label>
                    <input type="number" class="form-control form-control-lg" id="academic_passing_year_${academicIndex}" name="academic_passing_year[]" required>
                </div>
                <div class="col-md-2">
                    <label for="academic_total_marks_${academicIndex}" class="form-label text-dark">Total Marks</label>
                    <input type="number" class="form-control form-control-lg" id="academic_total_marks_${academicIndex}" name="academic_total_marks[]" required>
                </div>
                <div class="col-md-2">
                    <label for="academic_marks_obtained_${academicIndex}" class="form-label text-dark">Marks Obtained</label>
                    <input type="number" class="form-control form-control-lg" id="academic_marks_obtained_${academicIndex}" name="academic_marks_obtained[]" required>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-3">
                    <label for="academic_grade_${academicIndex}" class="form-label text-dark">Grade/Division/CGPA</label>
                    <input type="text" class="form-control form-control-lg" id="academic_grade_${academicIndex}" name="academic_grade[]" required>
                </div>
                <div class="col-md-3">
                    <label for="academic_major_${academicIndex}" class="form-label text-dark">Major Subject</label>
                    <input type="text" class="form-control form-control-lg" id="academic_major_${academicIndex}" name="academic_major[]" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger mt-4 remove-academic-row">Remove</button>
                </div>
            </div>
        </div>
    `;
    $('#academicQualificationsContainer').append(newRow);
    if ($('.academic-qualification-row').length > 1) {
        $('.remove-academic-row').show();
    }
});

$(document).on('click', '.remove-academic-row', function () {
    $(this).closest('.academic-qualification-row').remove();
    if ($('.academic-qualification-row').length <= 1) {
        $('.remove-academic-row').hide();
    }
});

// Dynamic Extra Activities
let activityIndex = 0;
$('#addActivityRow').click(function () {
    activityIndex++;
    const newRow = `
        <div class="extra-activity-row mb-4" data-index="${activityIndex}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="activity_${activityIndex}" class="form-label text-dark">Activity</label>
                    <input type="text" class="form-control form-control-lg" id="activity_${activityIndex}" name="activity[]">
                </div>
                <div class="col-md-3">
                    <label for="position_${activityIndex}" class="form-label text-dark">Position/Role</label>
                    <input type="text" class="form-control form-control-lg" id="position_${activityIndex}" name="position[]">
                </div>
                <div class="col-md-3">
                    <label for="achievement_${activityIndex}" class="form-label text-dark">Achievements</label>
                    <input type="text" class="form-control form-control-lg" id="achievement_${activityIndex}" name="achievement[]">
                </div>
                <div class="col-md-2">
                    <label for="activity_year_${activityIndex}" class="form-label text-dark">Year</label>
                    <input type="number" class="form-control form-control-lg" id="activity_year_${activityIndex}" name="activity_year[]">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger mt-4 remove-activity-row">Remove</button>
                </div>
            </div>
        </div>
    `;
    $('#extraActivitiesContainer').append(newRow);
    if ($('.extra-activity-row').length > 1) {
        $('.remove-activity-row').show();
    }
});

$(document).on('click', '.remove-activity-row', function () {
    $(this).closest('.extra-activity-row').remove();
    if ($('.extra-activity-row').length <= 1) {
        $('.remove-activity-row').hide();
    }
});

// Custom CNIC validation method
$.validator.addMethod("cnicFormat", function(value, element) {
    return this.optional(element) || /^[0-9]{5}-[0-9]{7}-[0-9]$/.test(value);
}, "Please enter a valid CNIC (XXXXX-XXXXXXX-X)");

// Form validation
$("#admissionForm").validate({
    errorClass: "error",
    validClass: "is-valid",
    errorElement: "span",
    highlight: function (element) {
        $(element).addClass("is-invalid").removeClass("is-valid");
    },
    unhighlight: function (element) {
        $(element).removeClass("is-invalid").addClass("is-valid");
    },
    rules: {
        full_name: "required",
        religion: "required",
        caste: "required",
        cnic: {
            required: true,
            cnicFormat: true
        },
        dob: "required",
        contact_no: {
            required: true,
            pattern: /^\d{11,15}$/
        },
        father_name: "required",
        father_occupation: "required",
        father_cnic: {
            required: true,
            cnicFormat: true
        },
        monthly_income: {
            required: true,
            number: true,
            min: 0
        },
        relationship: "required",
        permanent_address: "required",
        applicant_photo: {
            required: true
        },
        declaration: "required",
        "academic_degree[]": {
            required: true
        },
        "academic_board[]": {
            required: true
        },
        "academic_passing_year[]": {
            required: true,
            digits: true,
            min: 1950,
            max: new Date().getFullYear()
        },
        "academic_total_marks[]": {
            required: true,
            number: true,
            min: 0
        },
        "academic_marks_obtained[]": {
            required: true,
            number: true,
            min: 0
        },
        "academic_grade[]": {
            required: true
        },
        "academic_major[]": {
            required: true
        }
    },
    messages: {
        cnic: {
            cnicFormat: "Please enter a valid CNIC (XXXXX-XXXXXXX-X)"
        },
        father_cnic: {
            cnicFormat: "Please enter a valid CNIC (XXXXX-XXXXXXX-X)"
        },
        contact_no: {
            pattern: "Contact number must be 11-15 digits"
        }
    },
    submitHandler: function (form, event) {
        event.preventDefault();
        console.log('Form submission triggered at', new Date().toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));
        const formData = new FormData(form);
        console.log('Form Data entries:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}:`, value instanceof File ? `File(${value.name}, ${value.size} bytes)` : value);
        }
        const $submitButton = $('button[type="submit"]');
        $submitButton.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        $submitButton.prop('disabled', true);

        $.ajax({
            url: submitUrl,
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function (response) {
                console.log('Submission success:', response);
                if (response.success) {
                    window.location.href = "{% url 'application_success' %}";
                } else {
                    alert(response.message || "Error submitting application");
                    $submitButton.html('Submit Application').prop('disabled', false);
                }
            },
            error: function (xhr) {
                console.error('Submission error:', xhr);
                alert("Error: " + (xhr.responseJSON?.message || xhr.statusText || "Submission failed"));
                $submitButton.html('Submit Application').prop('disabled', false);
            }
        });
    }
});

// CNIC input formatting
$('input[name="cnic"], input[name="father_cnic"]').on('input', function () {
    let value = $(this).val().replace(/\D/g, '');
    if (value.length > 5) value = value.slice(0, 5) + '-' + value.slice(5);
    if (value.length > 13) value = value.slice(0, 13) + '-' + value.slice(13);
    $(this).val(value.slice(0, 15));
});

// Phone number formatting
$('input[name="contact_no"]').on('input', function () {
    $(this).val($(this).val().replace(/\D/g, '').slice(0, 15));
});

// Date validation (minimum age 16 years as of May 17, 2025)
$('input[name="dob"]').on('change', function () {
    const dob = new Date($(this).val());
    const today = new Date('2025-05-17T09:07:00+05:00'); // Current date/time in PKT
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    if (age < 16) {
        $(this).val('');
        alert('Applicant must be at least 16 years old as of May 17, 2025.');
    }
});
</script>

{% endblock core_content %}