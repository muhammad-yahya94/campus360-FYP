{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Attendance{% endblock %}

{% block content %}
<style>
    /* Existing styles */
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .table th {
        background-color: #e9ecef;
        color: #343a40;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .select2-container {
        width: 100% !important;
    }
    .error {
        color: red;
    }
    .radio-group {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .radio-group input {
        margin-right: 5px;
    }
    .table th, .table td {
        white-space: nowrap;
        text-align: center;
    }
    .status-check {
        color: green;
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <!-- Hero Section -->
    <div class="hero bg-gradient-to-r from-primary to-secondary text-primary-content rounded-xl">
        <div class="hero-content text-center py-8">
            <div>
                <h1 class="text-4xl font-bold mb-2">Attendance</h1>
                <p class="text-lg opacity-90">Manage and track attendance</p>
            </div>
        </div>
    </div>

                            
    {% if is_active_slot %}
    <!-- Record Attendance Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Record Attendance ({{ today_date|date:"F d, Y" }})</h5>
            <form id="record-attendance-form" method="post" action="{% url 'faculty_staff:record_attendance' %}">
                {% csrf_token %}
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label for="course_offering_id" class="form-label">Course Offering</label>
                        {% if course_offering_id %}
                            <p id="course-offering-text" class="form-control-static"></p>
                            <input type="hidden" name="course_offering_id" id="course_offering_id" value="{{ course_offering_id }}">
                        {% else %}
                            <select name="course_offering_id" id="course_offering_id" class="form-select select2" required>
                                <option value="">Search for a course offering...</option>
                            </select>
                        {% endif %}
                        <span id="course-offering-error" class="error"></span>
                    </div>
                    {% if course_shift == 'both' %}
                    <div class="col-md-12">
                        <label for="shift" class="form-label">Shift</label>
                        <select name="shift" id="shift" class="form-select" required>
                            <option value="">Select shift...</option>
                            <option value="morning">Morning</option>
                            <option value="evening">Evening</option>
                            <option value="both">Both</option>
                        </select>
                        <span id="shift-error" class="error"></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Existing Attendance Display -->
                <div class="table-responsive" id="existing-attendance-record-container" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sr</th>
                                <th>Name</th>
                                <th>College Roll No</th>
                                <th>University Roll No</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Leave</th>
                            </tr>
                        </thead>
                        <tbody id="existing-attendance-record-body">
                        </tbody>
                    </table>
                </div>

                <!-- Students Table for New Attendance -->
                <div class="table-responsive" id="students-table-container" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sr</th>
                                <th>Student</th>
                                <th>College Roll No</th>
                                <th>University Roll No</th>
                                <th>Attendance Status</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            {% for student in students %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ student.name }}</td>
                                <td>{{ student.college_roll_no|default:'N/A' }}</td>
                                <td>{{ student.university_roll_no|default:'N/A' }}</td>
                                <td>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="present" {% if is_active_slot %}checked{% else %}disabled{% endif %} required>
                                            Present
                                        </label>
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="absent" {% if not is_active_slot %}disabled{% endif %}>
                                            Absent
                                        </label>
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="leave" {% if not is_active_slot %}disabled{% endif %}>
                                            Leave
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No students found for the selected course.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary" {% if not is_active_slot %}disabled{% endif %}>Submit Attendance</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Attendance Table -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Today’s Attendance ({{ today_date|date:"F d, Y" }})</h5>
            <div class="table-responsive" id="existing-attendance-container" style="display: none;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Sr</th>
                            <th>Student Name</th>
                            <th>College Roll No</th>
                            <th>University Roll No</th>
                            <th>Course</th>
                            <th>Shift</th>
                            <th>Status</th>
                            <th>Recorded By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="existing-attendance-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            {% else %}
        <div class="flex items-center justify-center min-h-screen bg-base-200">
          <div class="card w-full max-w-md shadow-xl bg-white border border-gray-200">       
            <div class="card-body items-center text-center">
                <h2 class="card-title text-error text-xl font-bold">No Lecture at the Moment</h2>
                <p class="text-gray-600 mt-2">There is currently no active lecture slot for this course.</p>
                <div class="mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636L5.636 18.364M6.343 6.343L17.657 17.657" />
                    </svg>
                </div>
            </div>
           </div>
        </div>    
        {% endif %}

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Function to show message card
    function showMessageCard(type, title, message) {
        const card = $('#message-card');
        card.removeClass('bg-success bg-error bg-warning text-success-content text-error-content text-warning-content');
        if (type === 'success') {
            card.addClass('bg-success text-success-content');
        } else if (type === 'error') {
            card.addClass('bg-error text-error-content');
        } else if (type === 'warning') {
            card.addClass('bg-warning text-warning-content');
        }
        card.find('.card-title').text(title);
        card.find('p').text(message);
        card.removeClass('hidden');
    }

    // Function to hide message card
    function hideMessageCard() {
        $('#message-card').addClass('hidden');
    }

    // Initialize Select2 for course offering
    if ($('#course_offering_id').is('select')) {
        $('#course_offering_id').select2({
            ajax: {
                url: "{% url 'faculty_staff:search_course_offerings' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return { q: params.term, page: params.page || 1 };
                },
                processResults: function(data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.results.map(item => ({
                            id: item.id,
                            text: `${item.course_code} - ${item.program_name} (${item.semester_name}, ${item.session_name})`,
                            shift: item.shift
                        })),
                        pagination: { more: data.pagination.more }
                    };
                },
                cache: true
            },
            placeholder: "Search for a course offering...",
            minimumInputLength: 1,
            allowClear: true
        });
    }

    // Function to load students and check existing attendance
    function loadStudentsAndAttendance(courseOfferingId, shift = null) {
        hideMessageCard();
        $.ajax({
            url: "{% url 'faculty_staff:load_attendance' %}",
            type: 'GET',
            data: { course_offering_id: courseOfferingId, date: '{{ today_date|date:"Y-m-d" }}', shift: shift },
            success: function(response) {
                if (response.success) {
                    if (response.is_active_slot) {
                        showMessageCard('success', 'Lecture in Progress', 'You can record attendance for this course now.');
                        $('#record-attendance-form').find('button[type="submit"]').prop('disabled', false);
                    } else {
                        showMessageCard('warning', 'No Active Lecture', 'Attendance cannot be recorded outside of scheduled lecture time.');
                        $('#record-attendance-form').find('button[type="submit"]').prop('disabled', true);
                    }

                    if (response.attendances.length > 0) {
                        let tbody = $('#existing-attendance-record-body');
                        tbody.empty();
                        response.attendances.forEach((attendance, index) => {
                            tbody.append(`
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${attendance.student_name}</td>
                                    <td>${attendance.college_roll_no || 'N/A'}</td>
                                    <td>${attendance.university_roll_no || 'N/A'}</td>
                                    <td>${attendance.status === 'present' ? '<span class="status-check">✔</span>' : ''}</td>
                                    <td>${attendance.status === 'absent' ? '<span class="status-check">✔</span>' : ''}</td>
                                    <td>${attendance.status === 'leave' ? '<span class="status-check">✔</span>' : ''}</td>
                                </tr>
                            `);
                        });
                        $('#existing-attendance-record-container').show();
                        $('#students-table-container').hide();

                        // Update existing attendance table
                        let existingTbody = $('#existing-attendance-body');
                        existingTbody.empty();
                        response.attendances.forEach((attendance, index) => {
                            existingTbody.append(`
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${attendance.student_name}</td>
                                    <td>${attendance.college_roll_no || 'N/A'}</td>
                                    <td>${attendance.university_roll_no || 'N/A'}</td>
                                    <td>${attendance.course_code}</td>
                                    <td>${attendance.shift ? attendance.shift.charAt(0).toUpperCase() + attendance.shift.slice(1) : 'N/A'}</td>
                                    <td>${attendance.status.charAt(0).toUpperCase() + attendance.status.slice(1)}</td>
                                    <td>${attendance.recorded_by}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm edit-attendance"
                                                data-attendance-id="${attendance.id}"
                                                data-student-id="${attendance.student_id}"
                                                data-status="${attendance.status}"
                                                data-shift="${attendance.shift || ''}">Edit</button>
                                    </td>
                                </tr>
                            `);
                        });
                        $('#existing-attendance-container').show();
                    } else {
                        $('#existing-attendance-record-container').hide();
                        // Load students for new attendance
                        $.ajax({
                            url: "{% url 'faculty_staff:load_students_for_course' %}",
                            type: 'GET',
                            data: { course_offering_id: courseOfferingId, shift: shift },
                            success: function(response) {
                                if (response.success) {
                                    let tbody = $('#students-table-body');
                                    tbody.empty();
                                    if (response.students.length > 0) {
                                        response.students.forEach((student, index) => {
                                            tbody.append(`
                                                <tr>
                                                    <td>${index + 1}</td>
                                                    <td>${student.name}</td>
                                                    <td>${student.college_roll_no || 'N/A'}</td>
                                                    <td>${student.university_roll_no || 'N/A'}</td>
                                                    <td>
                                                        <div class="radio-group">
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="present" checked required>
                                                                Present
                                                            </label>
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="absent">
                                                                Absent
                                                            </label>
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="leave">
                                                                Leave
                                                            </label>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `);
                                        });
                                        $('#students-table-container').show();
                                        $('#existing-attendance-container').hide();
                                    } else {
                                        tbody.append('<tr><td colspan="5" class="text-center">No students found for the selected course and shift.</td></tr>');
                                        $('#students-table-container').show();
                                        $('#existing-attendance-container').hide();
                                    }
                                } else {
                                    showMessageCard('error', 'Error', response.message);
                                    $('#students-table-container').hide();
                                    $('#existing-attendance-container').hide();
                                }
                            },
                            error: function(xhr, status, error) {
                                showMessageCard('error', 'Error', 'An error occurred: ' + error);
                                $('#students-table-container').hide();
                                $('#existing-attendance-container').hide();
                            }
                        });
                    }
                } else {
                    showMessageCard('error', 'Error', response.message);
                    $('#existing-attendance-record-container').hide();
                    $('#students-table-container').hide();
                    $('#existing-attendance-container').hide();
                }
            },
            error: function(xhr, status, error) {
                if (xhr.status === 403) {
                    showMessageCard('warning', 'No Active Lecture', 'Attendance cannot be recorded outside of scheduled lecture time.');
                    $('#record-attendance-form').find('button[type="submit"]').prop('disabled', true);
                } else {
                    showMessageCard('error', 'Error', 'An error occurred while fetching attendance: ' + error);
                }
                $('#existing-attendance-record-container').hide();
                $('#students-table-container').hide();
                $('#existing-attendance-container').hide();
            }
        });
    }

    // Load students when course offering is selected
    $('#course_offering_id').on('change', function() {
        if ($(this).is('select')) {
            let courseOfferingId = $(this).val();
            let selectedOption = $(this).find('option:selected').data('select2-result');
            let shift = $('#shift').val() || null;
            if (courseOfferingId) {
                if (selectedOption && selectedOption.shift === 'both' && !shift) {
                    $('#students-table-container').hide();
                    $('#existing-attendance-record-container').hide();
                    $('#existing-attendance-container').hide();
                    $('#shift-error').text('Please select a shift.');
                    showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
                } else {
                    $('#shift-error').text('');
                    loadStudentsAndAttendance(courseOfferingId, shift);
                }
            } else {
                $('#students-table-container').hide();
                $('#existing-attendance-record-container').hide();
                $('#existing-attendance-container').hide();
                hideMessageCard();
            }
        }
    });

    // Load students when shift is selected
    $('#shift').on('change', function() {
        let shift = $(this).val();
        let courseOfferingId = $('#course_offering_id').val();
        if (shift && courseOfferingId) {
            $('#shift-error').text('');
            loadStudentsAndAttendance(courseOfferingId, shift);
        } else if (!shift) {
            $('#shift-error').text('Please select a shift.');
            $('#students-table-container').hide();
            $('#existing-attendance-record-container').hide();
            $('#existing-attendance-container').hide();
            showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
        }
    });

    // Check for course_offering_id in URL on page load
    const urlParams = new URLSearchParams(window.location.search);
    const courseOfferingId = urlParams.get('course_offering_id');
    if (courseOfferingId) {
        $.ajax({
            url: "{% url 'faculty_staff:search_course_offerings' %}",
            type: 'GET',
            data: { id: courseOfferingId },
            success: function(response) {
                if (response.success && response.results.length > 0) {
                    const course = response.results[0];
                    $('#course-offering-text').text(
                        `${course.course_code} - ${course.program_name} (${course.semester_name}, ${course.session_name})`
                    );
                    if (course.shift === 'both') {
                        $('#shift').prop('required', true);
                        $('#shift').show();
                        $('#shift').parent().show();
                        showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
                    } else {
                        loadStudentsAndAttendance(courseOfferingId, course.shift);
                    }
                } else {
                    showMessageCard('error', 'Error', 'Course offering not found.');
                    $('#course-offering-text').text('Course offering not found.');
                }
            },
            error: function(xhr, status, error) {
                showMessageCard('error', 'Error', 'An error occurred while fetching course offering: ' + error);
                $('#course-offering-text').text('Error loading course offering.');
            }
        });
    }

    // Handle attendance form submission
    $('#record-attendance-form').on('submit', function(e) {
        e.preventDefault();
        let formData = $(this).serialize();
        if (!$('#course_offering_id').val()) {
            $('#course-offering-error').text('Course offering is required.');
            showMessageCard('error', 'Error', 'Please select a course offering.');
            return;
        }
        if ($('#shift').is(':visible') && !$('#shift').val()) {
            $('#shift-error').text('Shift is required.');
            showMessageCard('error', 'Error', 'Please select a shift.');
            return;
        }
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    showMessageCard('success', 'Success', response.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessageCard('error', 'Error', response.message);
                }
            },
            error: function(xhr, status, error) {
                if (xhr.status === 403) {
                    showMessageCard('warning', 'No Active Lecture', 'Attendance cannot be recorded outside of scheduled lecture time.');
                } else {
                    showMessageCard('error', 'Error', 'An error occurred: ' + error);
                }
            }
        });
    });

    // Handle edit attendance
    $(document).on('click', '.edit-attendance', function() {
        let attendanceId = $(this).data('attendance-id');
        let studentId = $(this).data('student-id');
        let currentStatus = $(this).data('status');
        let currentShift = $(this).data('shift');
        let newStatus = prompt('Enter new status (present/absent/leave):', currentStatus);
        if (newStatus && ['present', 'absent', 'leave'].includes(newStatus.toLowerCase())) {
            $.ajax({
                url: "{% url 'faculty_staff:edit_attendance' %}",
                type: 'POST',
                data: {
                    attendance_id: attendanceId,
                    student_id: studentId,
                    status: newStatus.toLowerCase(),
                    shift: currentShift,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showMessageCard('success', 'Success', response.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessageCard('error', 'Error', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    showMessageCard('error', 'Error', 'An error occurred: ' + error);
                }
            });
        } else if (newStatus) {
            showMessageCard('error', 'Error', 'Invalid status. Please enter "present", "absent", or "leave".');
        }
    });
});
</script>
{% endblock %}