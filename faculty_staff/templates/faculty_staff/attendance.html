{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Attendance{% endblock %}

{% block content %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .table th {
        background-color: #e9ecef;
        color: #343a40;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .select2-container {
        width: 100% !important;
    }
    .error {
        color: red;
    }
    .radio-group {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .radio-group input {
        margin-right: 5px;
    }
    .table th, .table td {
        white-space: nowrap;
        text-align: center;
    }
    .status-check {
        color: green;
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-xl shadow-lg mb-6">
        <div class="text-center py-6">
            <h1 class="text-4xl font-bold">Attendance</h1>
            <p class="text-lg text-white/80">Manage and track attendance</p>
        </div>
    </div>

    <!-- Message Card for Feedback -->
    <div id="message-card" class="card mb-4 hidden">
        <div class="card-body">
            <h5 class="card-title"></h5>
            <p></p>
        </div>
    </div>

    {% if is_active_slot %}
    <!-- Record Attendance Section -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Record Attendance ({{ today_date|date:"F d, Y" }})</h5>
            <form id="record-attendance-form" method="post" action="{% url 'faculty_staff:record_attendance' %}">
                {% csrf_token %}
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label for="course_offering_id" class="form-label">Course Offering</label>
                        {% if course_offering_id %}
                            <p id="course-offering-text" class="form-control-static"></p>
                            <input type="hidden" name="course_offering_id" id="course_offering_id" value="{{ course_offering_id }}">
                        {% else %}
                            <select name="course_offering_id" id="course_offering_id" class="form-select select2" required>
                                <option value="">Search for a course offering...</option>
                            </select>
                        {% endif %}
                        <span id="course-offering-error" class="error"></span>
                    </div>
                    {% if course_shift == 'both' %}
                    <div class="col-md-12">
                        <label for="shift" class="form-label">Shift</label>
                        <select name="shift" id="shift" class="form-select" required>
                            <option value="">Select shift...</option>
                            <option value="morning">Morning</option>
                            <option value="evening">Evening</option>
                            <option value="both">Both</option>
                        </select>
                        <span id="shift-error" class="error"></span>
                    </div>
                    {% endif %}
                </div>

                <!-- Existing Attendance Display -->
                <div class="table-responsive" id="existing-attendance-record-container" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sr</th>
                                <th>Name</th>
                                <th>College Roll No</th>
                                <th>University Roll No</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Leave</th>
                            </tr>
                        </thead>
                        <tbody id="existing-attendance-record-body">
                        </tbody>
                    </table>
                </div>

                <!-- Students Table for New Attendance -->
                <div class="table-responsive" id="students-table-container" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sr</th>
                                <th>Student</th>
                                <th>College Roll No</th>
                                <th>University Roll No</th>
                                <th>Attendance Status</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            {% for student in students %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ student.name }}
                                    {% if student.role == 'CR' %}
                                        <span class="badge badge-warning ml-1">CR</span>
                                    {% elif student.role == 'GR' %}
                                        <span class="badge badge-secondary ml-1" style="background-color:#f472b6; color:white;">GR</span>
                                    {% endif %}
                                </td>
                                <td>{{ student.college_roll_no|default:'N/A' }}</td>
                                <td>{{ student.university_roll_no|default:'N/A' }}</td>
                                <td>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="present" checked required>
                                            Present
                                        </label>
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="absent">
                                            Absent
                                        </label>
                                        <label>
                                            <input type="radio" name="status_{{ student.id }}" value="leave">
                                            Leave
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No students found for the selected course.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">Submit Attendance</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Attendance Table -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Today’s Attendance ({{ today_date|date:"F d, Y" }})</h5>
            <div class="table-responsive" id="existing-attendance-container" style="display: none;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Sr</th>
                            <th>Student Name</th>
                            <th>College Roll No</th>
                            <th>University Roll No</th>
                            <th>Course</th>
                            <th>Shift</th>
                            <th>Status</th>
                            <th>Recorded By</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="existing-attendance-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="flex items-center justify-center min-h-screen">
        <div class="card w-full max-w-md shadow-xl bg-white border border-gray-200">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-error text-xl font-bold">No Lecture at the Moment</h2>
                <p class="text-gray-600 mt-2">There is currently no active lecture slot for this course.</p>
                <div class="mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636L5.636 18.364M6.343 6.343L17.657 17.657" />
                    </svg>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Global variable for course_offering_id
let courseOfferingId = null;

$(document).ready(function() {
    // Initialize courseOfferingId from URL or template context
    const urlParams = new URLSearchParams(window.location.search);
    courseOfferingId = urlParams.get('course_offering_id') || '{{ course_offering_id|default_if_none:"" }}';
    console.log(`Initialized courseOfferingId: ${courseOfferingId}`);

    // Function to show message card
    function showMessageCard(type, title, message) {
        const card = $('#message-card');
        card.removeClass('bg-success bg-error bg-warning text-success-content text-error-content text-warning-content');
        if (type === 'success') {
            card.addClass('bg-success text-success-content');
        } else if (type === 'error') {
            card.addClass('bg-error text-error-content');
        } else if (type === 'warning') {
            card.addClass('bg-warning text-warning-content');
        }
        card.find('.card-title').text(title);
        card.find('p').text(message);
        card.removeClass('hidden');
        console.log(`Message card shown: Type=${type}, Title=${title}, Message=${message}`);
    }

    // Function to hide message card
    function hideMessageCard() {
        $('#message-card').addClass('hidden');
        console.log("Message card hidden");
    }

    // Initialize Select2 for course offering
    if ($('#course_offering_id').is('select')) {
        $('#course_offering_id').select2({
            ajax: {
                url: "{% url 'faculty_staff:search_course_offerings' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    console.log(`Select2 AJAX data: q=${params.term}, page=${params.page || 1}`);
                    return { q: params.term, page: params.page || 1 };
                },
                processResults: function(data, params) {
                    console.log(`Select2 processResults: results=${JSON.stringify(data.results)}, more=${data.pagination?.more}`);
                    params.page = params.page || 1;
                    return {
                        results: data.results.map(item => ({
                            id: item.id,
                            text: `${item.course_code} - ${item.program_name} (${item.semester_name}, ${item.session_name})`,
                            shift: item.shift
                        })),
                        pagination: { more: data.pagination?.more || false }
                    };
                },
                cache: true
            },
            placeholder: "Search for a course offering...",
            minimumInputLength: 1,
            allowClear: true
        });
    }

    // Function to load students and check existing attendance
    function loadStudentsAndAttendance(id, shift = null) {
        console.log(`loadStudentsAndAttendance called: courseOfferingId=${id}, shift=${shift}, date={{ today_date|date:"Y-m-d" }}`);
        if (!id) {
            showMessageCard('error', 'Error', 'No course offering selected.');
            console.error("No courseOfferingId provided for loadStudentsAndAttendance");
            return;
        }
        hideMessageCard();
        $.ajax({
            url: "{% url 'faculty_staff:load_attendance' %}",
            type: 'GET',
            data: { course_offering_id: id, date: '{{ today_date|date:"Y-m-d" }}', shift: shift },
            success: function(response) {
                console.log(`load_attendance response: ${JSON.stringify(response)}`);
                if (response.success) {
                    if (response.attendances.length > 0) {
                        let tbody = $('#existing-attendance-record-body');
                        tbody.empty();
                        response.attendances.forEach((attendance, index) => {
                            tbody.append(`
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${attendance.student_name}
                                        ${attendance.student_role === 'CR' ? '<span class="badge badge-warning ml-1">CR</span>' : ''}
                                        ${attendance.student_role === 'GR' ? '<span class="badge badge-secondary ml-1" style="background-color:#f472b6; color:white;">GR</span>' : ''}
                                    </td>
                                    <td>${attendance.college_roll_no || 'N/A'}</td>
                                    <td>${attendance.university_roll_no || 'N/A'}</td>
                                    <td>${attendance.status === 'present' ? '<span class="status-check">✔</span>' : ''}</td>
                                    <td>${attendance.status === 'absent' ? '<span class="status-check">✔</span>' : ''}</td>
                                    <td>${attendance.status === 'leave' ? '<span class="status-check">✔</span>' : ''}</td>
                                </tr>
                            `);
                        });
                        $('#existing-attendance-record-container').show();
                        $('#students-table-container').hide();
                        console.log(`Existing attendance shown: ${response.attendances.length} records`);

                        let existingTbody = $('#existing-attendance-body');
                        existingTbody.empty();
                        response.attendances.forEach((attendance, index) => {
                            existingTbody.append(`
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${attendance.student_name}
                                        ${attendance.student_role === 'CR' ? '<span class="badge badge-warning ml-1">CR</span>' : ''}
                                        ${attendance.student_role === 'GR' ? '<span class="badge badge-secondary ml-1" style="background-color:#f472b6; color:white;">GR</span>' : ''}
                                    </td>
                                    <td>${attendance.college_roll_no || 'N/A'}</td>
                                    <td>${attendance.university_roll_no || 'N/A'}</td>
                                    <td>${attendance.course_code}</td>
                                    <td>${attendance.shift ? attendance.shift.charAt(0).toUpperCase() + attendance.shift.slice(1) : 'N/A'}</td>
                                    <td>${attendance.status.charAt(0).toUpperCase() + attendance.status.slice(1)}</td>
                                    <td>${attendance.recorded_by}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm edit-attendance"
                                                data-attendance-id="${attendance.id}"
                                                data-student-id="${attendance.student_id}"
                                                data-status="${attendance.status}"
                                                data-shift="${attendance.shift || ''}">Edit</button>
                                    </td>
                                </tr>
                            `);
                        });
                        $('#existing-attendance-container').show();
                        console.log(`Existing attendance table updated: ${response.attendances.length} records`);
                    } else {
                        $('#existing-attendance-record-container').hide();
                        // Load students for new attendance
                        $.ajax({
                            url: "{% url 'faculty_staff:load_students_for_course' %}",
                            type: 'GET',
                            data: { course_offering_id: id, shift: shift },
                            success: function(response) {
                                console.log(`load_students_for_course response: ${JSON.stringify(response)}`);
                                if (response.success) {
                                    let tbody = $('#students-table-body');
                                    tbody.empty();
                                    if (response.students.length > 0) {
                                        response.students.forEach((student, index) => {
                                            tbody.append(`
                                                <tr>
                                                    <td>${index + 1}</td>
                                                    <td>${student.name}
                                                        ${student.role === 'CR' ? '<span class="badge badge-warning ml-1">CR</span>' : ''}
                                                        ${student.role === 'GR' ? '<span class="badge badge-secondary ml-1" style="background-color:#f472b6; color:white;">GR</span>' : ''}
                                                    </td>
                                                    <td>${student.college_roll_no || 'N/A'}</td>
                                                    <td>${student.university_roll_no || 'N/A'}</td>
                                                    <td>
                                                        <div class="radio-group">
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="present" checked required>
                                                                Present
                                                            </label>
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="absent">
                                                                Absent
                                                            </label>
                                                            <label>
                                                                <input type="radio" name="status_${student.id}" value="leave">
                                                                Leave
                                                            </label>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `);
                                        });
                                        $('#students-table-container').show();
                                        $('#existing-attendance-container').hide();
                                        console.log(`Students table populated: ${response.students.length} students`);
                                    } else {
                                        tbody.append('<tr><td colspan="5" class="text-center">No students found for the selected course and shift.</td></tr>');
                                        $('#students-table-container').show();
                                        $('#existing-attendance-container').hide();
                                        console.log("No students found for the selected course and shift");
                                    }
                                } else {
                                    showMessageCard('error', 'Error', response.message);
                                    $('#students-table-container').hide();
                                    $('#existing-attendance-container').hide;
                                    console.error(`Error loading students: ${response.message}`);
                                }
                            },
                            error: function(xhr, status, error) {
                                showMessageCard('error', 'Error', 'An error occurred while loading students: ' + error);
                                $('#students-table-container').hide();
                                $('#existing-attendance-container').hide;
                                console.error(`AJAX error in load_students_for_course: status=${status}, error=${error}, response=${xhr.responseText}`);
                            }
                        });
                    }
                } else {  
                    showMessageCard('error', 'Error', response.message);
                    $('#existing-attendance-record-container').hide();
                    $('#students-table-container').hide();
                    $('#existing-attendance-container').hide;
                    console.error(`Error in load_attendance: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error(`AJAX error in load_attendance: status=${status}, error=${error}, response=${xhr.responseText}`);
                showMessageCard('error', 'Error', 'An error occurred while fetching attendance: ' + error);
                $('#existing-attendance-record-container').hide();
                $('#students-table-container').hide();
                $('#existing-attendance-container').hide;
            }
        });
    }

    // Load students when course offering is selected
    $('#course_offering_id').on('change', function() {
        if ($(this).is('select')) {
            courseOfferingId = $(this).val();
            console.log(`Course offering changed: courseOfferingId=${courseOfferingId}`);
            let selectedOption = $(this).find('option:selected').data('select2-result');
            let shift = $('#shift').val() || null;
            console.log(`Selected option: ${JSON.stringify(selectedOption)}, shift=${shift}`);
            if (courseOfferingId) {
                if (selectedOption && selectedOption.shift === 'both' && !shift) {
                    $('#students-table-container').hide();
                    $('#existing-attendance-record-container').hide();
                    $('#existing-attendance-container').hide;
                    $('#shift-error').text('Please select a shift.');
                    showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
                    console.log("Shift required but not selected");
                } else {
                    $('#shift-error').text('');
                    loadStudentsAndAttendance(courseOfferingId, shift);
                }
            } else {
                $('#students-table-container').hide();
                $('#existing-attendance-record-container').hide();
                $('#existing-attendance-container').hide;
                hideMessageCard();
                console.log("No course offering selected");
            }
        }
    });

    // Load students when shift is selected
    $('#shift').on('change', function() {
        let shift = $(this).val();
        console.log(`Shift changed: shift=${shift}, courseOfferingId=${courseOfferingId}`);
        if (shift && courseOfferingId) {
            $('#shift-error').text('');
            loadStudentsAndAttendance(courseOfferingId, shift);
        } else if (!shift) {
            $('#shift-error').text('Please select a shift.');
            $('#students-table-container').hide();
            $('#existing-attendance-record-container').hide();
            $('#existing-attendance-container').hide;
            showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
            console.log("No shift selected");
        } else {
            showMessageCard('error', 'Error', 'No course offering selected.');
            console.error("No courseOfferingId for shift change");
        }
    });

    // Initialize with course_offering_id from URL or template
    if (courseOfferingId) {
        console.log(`Loading data for course_offering_id: ${courseOfferingId}`);
        $.ajax({
            url: "{% url 'faculty_staff:search_course_offerings' %}",
            type: 'GET',
            data: { id: courseOfferingId },
            success: function(response) {
                console.log(`search_course_offerings response: ${JSON.stringify(response)}`);
                if (response.success && response.results.length > 0) {
                    const course = response.results[0];
                    $('#course-offering-text').text(
                        `${course.course_code} - ${course.program_name} (${course.semester_name}, ${course.session_name})`
                    );
                    if ($('#course_offering_id').is('select')) {
                        // Programmatically set Select2 value
                        const option = new Option(
                            `${course.course_code} - ${course.program_name} (${course.semester_name}, ${course.session_name})`,
                            course.id,
                            true,
                            true
                        );
                        $('#course_offering_id').append(option).trigger('change');
                        $('#course_offering_id').data('select2-result', course);
                    }
                    if (course.shift === 'both') {
                        $('#shift').prop('required', true);
                        $('#shift').parent().show();
                        showMessageCard('warning', 'Shift Required', 'Please select a shift to proceed.');
                        console.log("Course shift is 'both', showing shift selector");
                    } else {
                        loadStudentsAndAttendance(courseOfferingId, course.shift);
                    }
                } else {
                    showMessageCard('error', 'Error', 'Course offering not found.');
                    $('#course-offering-text').text('Course offering not found.');
                    console.error("Course offering not found in search_course_offerings");
                }
            },
            error: function(xhr, status, error) {
                showMessageCard('error', 'Error', 'An error occurred while fetching course offering: ' + error);
                $('#course-offering-text').text('Error loading course offering.');
                console.error(`AJAX error in search_course_offerings: status=${status}, error=${error}, response=${xhr.responseText}`);
            }
        });
    } else {
        console.log("No course_offering_id provided in URL or template");
        if ($('#course_offering_id').is('select')) {
            showMessageCard('info', 'Select Course', 'Please select a course offering to view students.');
        }
    }

    // Handle attendance form submission
    $('#record-attendance-form').on('submit', function(e) {
        e.preventDefault();
        let formData = $(this).serialize();
        console.log(`Submitting attendance form: ${formData}, courseOfferingId=${courseOfferingId}`);
        if (!courseOfferingId) {
            $('#course-offering-error').text('Course offering is required.');
            showMessageCard('error', 'Error', 'Please select a course offering.');
            console.error("Form submission failed: No course offering selected");
            return;
        }
        if ($('#shift').is(':visible') && !$('#shift').val()) {
            $('#shift-error').text('Shift is required.');
            showMessageCard('error', 'Error', 'Please select a shift.');
            console.error("Form submission failed: No shift selected");
            return;
        }
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                console.log(`record_attendance response: ${JSON.stringify(response)}`);
                if (response.success) {
                    showMessageCard('success', 'Success', response.message);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessageCard('error', 'Error', response.message);
                    console.error(`Error recording attendance: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error(`AJAX error in record_attendance: status=${status}, error=${error}, response=${xhr.responseText}`);
                showMessageCard('error', 'Error', 'An error occurred: ' + error);
            }
        });
    });

    // Handle edit attendance
    $(document).on('click', '.edit-attendance', function() {
        let attendanceId = $(this).data('attendance-id');
        let studentId = $(this).data('student-id');
        let currentStatus = $(this).data('status');
        let currentShift = $(this).data('shift');
        console.log(`Editing attendance: attendanceId=${attendanceId}, studentId=${studentId}, currentStatus=${currentStatus}, shift=${currentShift}, courseOfferingId=${courseOfferingId}`);
        let newStatus = prompt('Enter new status (present/absent/leave):', currentStatus);
        if (newStatus && ['present', 'absent', 'leave'].includes(newStatus.toLowerCase())) {
            $.ajax({
                url: "{% url 'faculty_staff:edit_attendance' %}",
                type: 'POST',
                data: {
                    attendance_id: attendanceId,
                    student_id: studentId,
                    status: newStatus.toLowerCase(),
                    shift: currentShift,
                    course_offering_id: courseOfferingId,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    console.log(`edit_attendance response: ${JSON.stringify(response)}`);
                    if (response.success) {
                        showMessageCard('success', 'Success', response.message);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showMessageCard('error', 'Error', response.message);
                        console.error(`Error editing attendance: ${response.message}`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error(`AJAX error in edit_attendance: status=${status}, error=${error}, response=${xhr.responseText}`);
                    showMessageCard('error', 'Error', 'An error occurred: ' + error);
                }
            });
        } else if (newStatus) {
            showMessageCard('error', 'Error', 'Invalid status. Please enter "present", "absent", or "leave".');
            console.error(`Invalid status entered: ${newStatus}`);
        }
    });
});
</script>
{% endblock %}
