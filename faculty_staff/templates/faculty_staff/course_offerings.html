{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Courses{% endblock %}
{% block content %}
 <style>
  body {
    overflow-x: hidden;
    margin: 0;
    max-width: 100%;
  }
  .container {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
  }
  .filter-section {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background-color: #f9f9f9;
    border-radius: 0.5rem;
  }
  .filter-section .form-control {
    flex: 1 1 100%;
    min-width: 0;
  }
  @media (min-width: 640px) {
    .filter-section .form-control {
      flex: 1 1 auto;
      min-width: 200px;
    }
  }
  .overflow-x-auto::before,
  .overflow-x-auto::after {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 12px;
    pointer-events: none;
    z-index: 5;
  }
  .overflow-x-auto::before {
    left: 0;
    background: linear-gradient(to right, rgba(0,0,0,0.15), transparent);
  }
  .overflow-x-auto::after {
    right: 0;
    background: linear-gradient(to left, rgba(0,0,0,0.15), transparent);
  }
  .table th, .table td {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
  }
  .table tbody tr {
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .btn-xs {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  .pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .pagination .page-link {
    padding: 0.25rem 0.5rem;
    border: 1px solid #ddd;
    border-radius: 0.25rem;
    text-decoration: none;
    color: #333;
  }
  .pagination .page-link:hover {
    background-color: #f0f0f0;
  }
  .pagination .page-link.active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
  }
  .alert {
    margin-bottom: 1rem;
  }
  .border-red-500 {
    border-color: #ef4444 !important;
  }
</style> 


<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
  <!-- Display Messages -->
  {% if messages %}
    <div class="space-y-2">
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
          <i class="{% if message.tags == 'success' %}fas fa-check-circle{% else %}fas fa-exclamation-circle{% endif %} me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-xl shadow-lg mb-6">
    <div class="text-center py-6">
      <h1 class="text-4xl font-bold">Course Offerings</h1>
      <p class="text-lg text-white/80">Manage courses and timetables for {{ department.name }}</p>
    </div>
  </div>

  <!-- Course Offering Form -->
  <form method="post" action="{% url 'faculty_staff:save_course_offering' %}" class="space-y-6">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-control">
        <label class="label" for="course_id">
          <span class="label-text">Course</span>
        </label>
        <select name="course_id" id="course_id" class="select select-bordered select2" aria-label="Select course" required>
          <option value="">Search for a course...</option>
        </select>
        <span id="course_id-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="offering_type">
          <span class="label-text">Offering Type</span>
        </label>
        <select name="offering_type" id="offering_type" class="select select-bordered" aria-label="Select offering type" required>
          <option value="">Select offering type...</option>
        </select>
        <span id="offering_type-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="teacher_id">
          <span class="label-text">Teacher</span>
        </label>
        <select name="teacher_id" id="teacher_id" class="select select-bordered select2" aria-label="Select teacher" required>
          <option value="">Select a teacher...</option>
        </select>
        <span id="teacher_id-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="academic_session_id">
          <span class="label-text">Academic Session</span>
        </label>
        <select name="academic_session_id" id="academic_session_id" class="select select-bordered" aria-label="Select academic session" required>
          <option value="">Select an academic session...</option>
        </select>
        <span id="academic_session_id-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="program_id">
          <span class="label-text">Program</span>
        </label>
        <select name="program_id" id="program_id" class="select select-bordered" aria-label="Select program" required>
          <option value="">Select an academic session first...</option>
        </select>
        <span id="program_id-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="semester_id">
          <span class="label-text">Semester</span>
        </label>
        <select name="semester_id" id="semester_id" class="select select-bordered" aria-label="Select semester" required>
          <option value="">Select a program first...</option>
        </select>
        <span id="semester_id-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="shift">
          <span class="label-text">Shift</span>
        </label>
        <select name="shift" id="shift" class="select select-bordered" aria-label="Select shift" required>
          <option value="">Select a shift...</option>
          <option value="morning">Morning</option>
          <option value="evening">Evening</option>
          <option value="both">Both</option>
        </select>
        <span id="shift-error" class="text-error text-sm mt-1"></span>
      </div>
      <div class="form-control">
        <label class="label" for="is_active">
          <span class="label-text">Active</span>
        </label>
        <input type="checkbox" name="is_active" id="is_active" class="checkbox checkbox-primary" checked aria-label="Toggle active status" />
      </div>
    </div>
    <button type="submit" class="btn btn-primary w-full">
      <i class="fas fa-check mr-2"></i>
      Assign Course
    </button>
  </form>

  <!-- Filter Section -->
  <section class="card bg-base-100 shadow-xl">
    <div class="card-body p-6">
      <h2 class="card-title text-2xl font-semibold mb-4">Filters</h2>
      <form method="get" class="filter-section">
        <div class="form-control">
          <label class="label" for="session_id">
            <span class="label-text">Active Session</span>
          </label>
          <select name="session_id" id="session_id" class="select select-bordered" onchange="this.form.submit()">
            <option value="">All Sessions</option>
            {% for session in academic_sessions %}
              <option value="{{ session.id }}" {% if session_id == session.id|stringformat:"s" %}selected{% endif %}>
                {{ session.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-control">
          <label class="label" for="program_id">
            <span class="label-text">Program</span>
          </label>
          <select name="program_id" id="program_id" class="select select-bordered" onchange="this.form.submit()">
            <option value="">All Programs</option>
            {% for program in programs %}
              <option value="{{ program.id }}" {% if program_id == program.id|stringformat:"s" %}selected{% endif %}>
                {{ program.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="form-control">
          <label class="label" for="semester_id">
            <span class="label-text">Active Semester</span>
          </label>
          <select name="semester_id" id="semester_id" class="select select-bordered" onchange="this.form.submit()">
            <option value="">All Semesters</option>
            {% for semester in semesters %}
              <option value="{{ semester.id }}" {% if semester_id == semester.id|stringformat:"s" %}selected{% endif %}>
                {{ semester.name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
  </section>

  <!-- Course Offerings Table -->
  <section class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body p-6 min-h-[400px]">
      <h2>
        <i class="fas fa-table mr-2"></i>
        Assigned Courses
      </h2>
      <div class="relative">
        <div class="overflow-x-auto scroll-smooth h-full">
          <table class="table table-zebra w-full min-w-[1320px] table-fixed" aria-label="Course Offerings">
            <thead class="bg-base-200">
              <tr>
                <th class="text-sm w-[100px] text-center">Code</th>
                <th class="text-sm w-[200px] text-left">Course</th>
                <th class="text-sm w-[150px] text-left">Program</th>
                <th class="text-sm w-[150px] text-left">Dept</th>
                <th class="text-sm w-[150px] text-left">Teacher</th>
                <th class="text-sm w-[150px] text-left">Prof Dept</th>
                <th class="text-sm w-[150px] text-left">Session</th>
                <th class="text-sm w-[150px] text-center">Sem</th>
                <th class="text-sm w-[150px] text-center">Type</th>
                <th class="text-sm w-[150px] text-center">Shift</th>
                <th class="text-sm w-[150px] text-center">Active</th>
                <th class="text-sm w-[150px] text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for offering in course_offerings %}
              <tr class="hover:bg-base-200 transition-colors">
                <td class="text-sm text-center border-r border-base-300">{{ offering.course.code }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ offering.course.name }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ offering.program.name|default:"N/A" }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ offering.department.name|default:"N/A" }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">
                  {% if offering.teacher %}
                  {{ offering.teacher.user.get_full_name }} 
                  {% else %}
                  <span class="text-warning">Not Assigned</span>
                  {% endif %}
                </td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ offering.teacher.department.name|default:"N/A" }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ offering.academic_session.name }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ offering.semester.name }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ offering.get_offering_type_display }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ offering.shift|capfirst }}</td>
                <td class="text-sm text-center border-r border-base-300">
                  <span class="badge {% if offering.is_active %}badge-success{% else %}badge-error{% endif %} text-xs">
                    {{ offering.is_active|yesno:"Active,Inactive" }}
                  </span>
                </td>
                <td class="text-sm text-center">
                  <div class="flex flex-row gap-1 flex-nowrap justify-center">
                    <a href="{% url 'faculty_staff:timetable_schedule' offering.id %}"
                       class="btn btn-xs btn-accent tooltip tooltip-primary px-2" data-tip="Edit Timetable" aria-label="Edit Timetable">
                      <i class="fas fa-calendar-alt"></i>
                    </a>
                    <label for="edit-offering-modal"
                           class="btn btn-xs btn-warning tooltip tooltip-primary px-2 edit-offering"
                           data-offering-id="{{ offering.id }}"
                           data-tip="Edit Offering" aria-label="Edit Offering">
                      <i class="fas fa-edit"></i>
                    </label>
                    <button class="btn btn-xs btn-error tooltip tooltip-primary px-2 delete-offering"
                            data-offering-id="{{ offering.id }}"
                            data-tip="Delete Offering" aria-label="Delete Offering">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="12" class="text-center p-8 border-b border-base-300">
                  <div class="text-center">
                    <i class="fas fa-book text-6xl text-base-content/20 mb-4"></i>
                    <h3 class="text-xl font-semibold text-base-content/70 mb-2">No Courses Found</h3>
                    <p class="text-base-content/50">Assign courses using the form above or adjust filters.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Pagination for Course Offerings -->
      {% if course_offerings.has_other_pages %}
        <div class="flex justify-center items-center gap-2 mt-4">
          {% if course_offerings.has_previous %}
            <a href="?page=1&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              First
            </a>
            <a href="?page={{ course_offerings.previous_page_number }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Previous
            </a>
          {% endif %}
          {% for num in course_offerings.paginator.page_range %}
            <a href="?page={{ num }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 {% if course_offerings.number == num %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-800 hover:bg-gray-300{% endif %} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              {{ num }}
            </a>
          {% endfor %}
          {% if course_offerings.has_next %}
            <a href="?page={{ course_offerings.next_page_number }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Next
            </a>
            <a href="?page={{ course_offerings.paginator.num_pages }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Last
            </a>
          {% endif %}
          <span class="text-sm text-gray-600 ml-2">
            Page {{ course_offerings.number }} of {{ course_offerings.paginator.num_pages }}
          </span>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Timetable Display -->
  <section class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body p-6 min-h-[400px]">
      <h2>
        <i class="fas fa-calendar-alt mr-2"></i>
        Timetable
      </h2>
      <div class="relative">
        <div class="overflow-x-auto scroll-smooth h-full">
          <table class="table table-zebra w-full min-w-[1200px] table-fixed" aria-label="Timetable Slots">
            <thead class="bg-base-200">
              <tr>
                <th class="text-sm w-[100px] sticky top-0 z-20 border-r border-b border-base-300 text-center">Code</th>
                <th class="text-sm w-[200px] sticky top-0 z-20 border-r border-b border-base-300 text-left">Course</th>
                <th class="text-sm w-[150px] sticky top-0 z-20 border-r border-b border-base-300 text-left">Teacher</th>
                <th class="text-sm w-[150px] sticky top-0 z-20 border-r border-b border-base-300 text-left">Program</th>
                <th class="text-sm w-[120px] sticky top-0 z-20 border-r border-b border-base-300 text-center">Sem</th>
                <th class="text-sm w-[120px] sticky top-0 z-20 border-r border-b border-base-300 text-center">Shift</th>
                <th class="text-sm w-[120px] sticky top-0 z-20 border-r border-b border-base-300 text-center">Day</th>
                <th class="text-sm w-[120px] sticky top-0 z-20 border-r border-b border-base-300 text-center">Time</th>
                <th class="text-sm w-[150px] sticky top-0 z-20 border-r border-b border-base-300 text-left">Class Room</th>
                <th class="text-sm w-[100px] sticky top-0 z-20 border-r border-b border-base-300 text-left">Room no.</th>
                <th class="text-sm w-[120px] sticky top-0 z-20 border-b border-base-300 text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for slot in timetable_slots %}
              <tr class="hover:bg-base-200 transition-colors">
                <td class="text-sm text-center border-r border-base-300">{{ slot.course_offering.course.code }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ slot.course_offering.course.name }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ slot.course_offering.teacher.user.get_full_name|default:"N/A" }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ slot.course_offering.program.name|default:"N/A" }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ slot.course_offering.semester.name }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ slot.course_offering.shift|capfirst }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ slot.get_day_display }}</td>
                <td class="text-sm text-center border-r border-base-300">{{ slot.start_time|time:"H:i" }}â€“{{ slot.end_time|time:"H:i" }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ slot.venue.name }}</td>
                <td class="text-sm text-left border-r border-base-300 overflow-hidden text-ellipsis whitespace-nowrap">{{ slot.venue.capacity }}</td>
                <td class="text-sm text-center">
                  <div class="flex flex-row gap-1 flex-nowrap justify-center">
                    <label for="edit-timetable-modal"
                           class="btn btn-xs btn-warning tooltip tooltip-primary px-2 edit-timetable-slot"
                           data-slot-id="{{ slot.id }}"
                           data-tip="Edit Slot" aria-label="Edit Timetable Slot">
                      <i class="fas fa-edit"></i>
                    </label>
                    <button class="btn btn-xs btn-error tooltip tooltip-primary px-2 delete-timetable-slot"
                            data-slot-id="{{ slot.id }}"
                            data-tip="Delete Slot" aria-label="Delete Timetable Slot">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="text-center p-8 border-b border-base-300">
                  <div class="text-center">
                    <i class="fas fa-calendar-alt text-6xl text-base-content/20 mb-4"></i>
                    <h3 class="text-xl font-semibold text-base-content/70 mb-2">No Timetable Slots Found</h3>
                    <p class="text-base-content/50">Schedule slots via the Timetable link above or adjust filters.</p>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Pagination for Timetable Slots -->
      {% if timetable_slots.has_other_pages %}
        <div class="flex justify-center items-center gap-2 mt-4">
          {% if timetable_slots.has_previous %}
            <a href="?page=1&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              First
            </a>
            <a href="?page={{ timetable_slots.previous_page_number }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Previous
            </a>
          {% endif %}
          {% for num in timetable_slots.paginator.page_range %}
            <a href="?page={{ num }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 {% if timetable_slots.number == num %}bg-blue-600 text-white{% else %}bg-gray-200 text-gray-800 hover:bg-gray-300{% endif %} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              {{ num }}
            </a>
          {% endfor %}
          {% if timetable_slots.has_next %}
            <a href="?page={{ timetable_slots.next_page_number }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Next
            </a>
            <a href="?page={{ timetable_slots.paginator.num_pages }}&session_id={{ session_id|default:'' }}&program_id={{ program_id|default:'' }}&semester_id={{ semester_id|default:'' }}"
               class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
              Last
            </a>
          {% endif %}
          <span class="text-sm text-gray-600 ml-2">
            Page {{ timetable_slots.number }} of {{ timetable_slots.paginator.num_pages }}
          </span>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- Edit Offering Modal -->
  <input type="checkbox" id="edit-offering-modal" class="modal-toggle" />
  <div class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Edit Course Offering</h3>
      <form id="edit-offering-form" method="post" action="{% url 'faculty_staff:edit_course_offering' %}" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="offering_id" id="edit_offering_id">
        <div class="form-control">
          <label class="label" for="edit_course_id">
            <span class="label-text">Course</span>
          </label>
          <select name="course_id" id="edit_course_id" class="select select-bordered select2" required>
            <option value="">Search for a course...</option>
          </select>
          <span id="edit_course_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_offering_type">
            <span class="label-text">Offering Type</span>
          </label>
          <select name="offering_type" id="edit_offering_type" class="select select-bordered" required>
            <option value="">Select offering type...</option>
          </select>
          <span id="edit_offering_type-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_teacher_id">
            <span class="label-text">Teacher</span>
          </label>
          <select name="teacher_id" id="edit_teacher_id" class="select select-bordered select2" required>
            <option value="">Select a teacher...</option>
          </select>
          <span id="edit_teacher_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_academic_session_id">
            <span class="label-text">Academic Session</span>
          </label>
          <select name="academic_session_id" id="edit_academic_session_id" class="select select-bordered" required>
            <option value="">Select an academic session...</option>
          </select>
          <span id="edit_academic_session_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_program_id">
            <span class="label-text">Program</span>
          </label>
          <select name="program_id" id="edit_program_id" class="select select-bordered" required>
            <option value="">Select an academic session first...</option>
          </select>
          <span id="edit_program_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_semester_id">
            <span class="label-text">Semester</span>
          </label>
          <select name="semester_id" id="edit_semester_id" class="select select-bordered" required>
            <option value="">Select a program first...</option>
          </select>
          <span id="edit_semester_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_shift">
            <span class="label-text">Shift</span>
          </label>
          <select name="shift" id="edit_shift" class="select select-bordered" required>
            <option value="">Select a shift...</option>
            <option value="morning">Morning</option>
            <option value="evening">Evening</option>
            <option value="both">Both</option>
          </select>
          <span id="edit_shift-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_is_active">
            <span class="label-text">Active</span>
          </label>
          <input type="checkbox" name="is_active" id="edit_is_active" class="checkbox checkbox-primary">
          <span id="edit_is_active-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="mb-4 md:mb-6">
          <button type="submit" class="btn btn-primary w-full">
            <i class="fas fa-save mr-2"></i> Save Changes
          </button>
          <label for="edit-offering-modal" class="btn btn-secondary w-full mt-2 cursor-pointer">
            <i class="fas fa-times mr-2"></i> Cancel
          </label>
          <label for="edit-offering-modal" class="modal-backdrop cursor-pointer">Close</label>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Timetable Modal -->
  <input type="checkbox" id="edit-timetable-modal" class="modal-toggle" />
  <div class="modal" role="dialog">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Edit Timetable Slot</h3>
      <form id="edit-timetable-form" method="post" action="{% url 'faculty_staff:edit_timetable_slot' %}" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="slot_id" id="edit_slot_id">
        <div class="form-control">
          <label class="label" for="edit_timetable_course_offering_display">
            <span class="label-text">Course Offering</span>
          </label>
          <input type="text" id="edit_timetable_course_offering_display" class="input input-bordered" readonly aria-label="Course Offering" />
          <input type="hidden" name="course_offering_id" id="edit_timetable_course_offering_id">
          <span id="edit_course_offering_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_day">
            <span class="label-text">Day</span>
          </label>
          <select name="day" id="edit_day" class="select select-bordered" required>
            <option value="">Select a day...</option>
            <option value="monday">Monday</option>
            <option value="tuesday">Tuesday</option>
            <option value="wednesday">Wednesday</option>
            <option value="thursday">Thursday</option>
            <option value="friday">Friday</option>
            <option value="saturday">Saturday</option>
          </select>
          <span id="edit_day-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_start_time">
            <span class="label-text">Start Time</span>
          </label>
          <input type="time" name="start_time" id="edit_start_time" class="input input-bordered" required>
          <span id="edit_start_time-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_end_time">
            <span class="label-text">End Time</span>
          </label>
          <input type="time" name="end_time" id="edit_end_time" class="input input-bordered" required>
          <span id="edit_end_time-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="form-control">
          <label class="label" for="edit_venue_id">
            <span class="label-text">Venue</span>
          </label>
          <select name="venue_id" id="edit_venue_id" class="select select-bordered select2" required>
            <option value="">Search for a venue...</option>
          </select>
          <span id="edit_venue_id-error" class="text-error text-sm mt-1"></span>
        </div>
        <div class="modal-action">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save mr-2"></i> Save Changes
          </button>
          <label for="edit-timetable-modal" class="btn btn-outline">Close</label>
        </div>
      </form>
    </div>
  </div>

  <!-- Include External Dependencies -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function() {
      // Initialize Select2 for course
      function initSelect2Course(selector) {
        $(selector).select2({
          ajax: {
            url: "{% url 'faculty_staff:search_courses' %}",
            dataType: 'json',
            delay: 250,
            data: function(params) {
              return { q: params.term, page: params.page || 1 };
            },
            processResults: function(data, params) {
              params.page = params.page || 1;
              return {
                results: data.results,
                pagination: { more: data.more }
              };
            },
            cache: true
          },
          placeholder: "Search for a course...",
          minimumInputLength: 1,
          allowClear: true
        });
      }

      // Initialize Select2 for teacher
      function initSelect2Teacher(selector) {
        $(selector).select2({
          ajax: {
            url: "{% url 'faculty_staff:search_teachers' %}",
            dataType: 'json',
            delay: 250,
            data: function(params) {
              return { q: params.term, page: params.page || 1 };
            },
            processResults: function(data, params) {
              params.page = params.page || 1;
              return {
                results: data.results,
                pagination: { more: data.more }
              };
            },
            cache: true
          },
          placeholder: "Select a teacher...",
          minimumInputLength: 1,
          allowClear: true
        });
      }

      // Initialize Select2 for venue
      function initSelect2Venue(selector) {
        $(selector).select2({
          ajax: {
            url: "{% url 'faculty_staff:search_venues' %}",
            dataType: 'json',
            delay: 250,
            data: function(params) {
              return { q: params.term, page: params.page || 1 };
            },
            processResults: function(data, params) {
              params.page = params.page || 1;
              return {
                results: data.results,
                pagination: { more: data.more }
              };
            },
            cache: true
          },
          placeholder: "Search for a venue...",
          minimumInputLength: 1,
          allowClear: true
        });
      }

      // Initialize normal select for academic session
      function initSelectAcademicSession(selector) {
        $.ajax({
          url: "{% url 'faculty_staff:get_academic_sessions' %}",
          dataType: 'json',
          success: function(data) {
            const $select = $(selector);
            $select.empty().append('<option value="">Select an academic session...</option>');
            $.each(data.results, function(index, item) {
              $select.append(`<option value="${item.id}">${item.text}</option>`);
            });
          },
          error: function(xhr, status, error) {
            console.error('Error fetching academic sessions:', error);
          }
        });
      }

      // Initialize normal select for program
      function initSelectProgram(selector, academicSessionSelector) {
        const $select = $(selector);
        $select.empty().append('<option value="">Select an academic session first...</option>').prop('disabled', true);
        
        $(academicSessionSelector).on('change', function() {
          const sessionId = $(this).val();
          if (sessionId) {
            $select.prop('disabled', false);
            $.ajax({
              url: "{% url 'faculty_staff:search_programs' %}",
              dataType: 'json',
              data: { academic_session_id: sessionId },
              success: function(data) {
                $select.empty().append('<option value="">Select a program...</option>');
                $.each(data.results, function(index, item) {
                  $select.append(`<option value="${item.id}">${item.text}</option>`);
                });
              },
              error: function(xhr, status, error) {
                console.error('Error fetching programs:', error);
                $select.empty().append('<option value="">Error loading programs</option>').prop('disabled', true);
              }
            });
          } else {
            $select.empty().append('<option value="">Select an academic session first...</option>').prop('disabled', true);
          }
        });
      }

      // Initialize normal select for semester
      function initSelectSemester(selector, academicSessionSelector, programSelector) {
        const $select = $(selector);
        $select.empty().append('<option value="">Select a program first...</option>').prop('disabled', true);
        
        $(programSelector).on('change', function() {
          const programId = $(this).val();
          const sessionId = $(academicSessionSelector).val();
          if (programId && sessionId) {
            $select.prop('disabled', false);
            $.ajax({
              url: "{% url 'faculty_staff:search_semesters' %}",
              dataType: 'json',
              data: { program_id: programId, academic_session_id: sessionId },
              success: function(data) {
                $select.empty().append('<option value="">Select a semester...</option>');
                $.each(data.results, function(index, item) {
                  $select.append(`<option value="${item.id}">${item.text}</option>`);
                });
              },
              error: function(xhr, status, error) {
                console.error('Error fetching semesters:', error);
                $select.empty().append('<option value="">Error loading semesters</option>').prop('disabled', true);
              }
            });
          } else {
            $select.empty().append('<option value="">Select a program first...</option>').prop('disabled', true);
          }
        });
      }

      // Initialize normal select for offering type
      function initSelectOfferingType(selector) {
        $.ajax({
          url: "{% url 'faculty_staff:get_offering_type_choices' %}",
          dataType: 'json',
          success: function(data) {
            const $select = $(selector);
            $select.empty().append('<option value="">Select offering type...</option>');
            $.each(data.results, function(index, item) {
              $select.append(`<option value="${item.id}">${item.text}</option>`);
            });
          },
          error: function(xhr, status, error) {
            console.error('Error fetching offering types:', error);
          }
        });
      }

      // Initialize Select2 and normal selects for main form
      initSelect2Course('#course_id');
      initSelect2Teacher('#teacher_id');
      initSelectAcademicSession('#academic_session_id');
      initSelectProgram('#program_id', '#academic_session_id');
      initSelectSemester('#semester_id', '#academic_session_id', '#program_id');
      initSelectOfferingType('#offering_type');

      // Initialize Select2 and normal selects for edit offering form
      initSelect2Course('#edit_course_id');
      initSelect2Teacher('#edit_teacher_id');
      initSelectAcademicSession('#edit_academic_session_id');
      initSelectProgram('#edit_program_id', '#edit_academic_session_id');
      initSelectSemester('#edit_semester_id', '#edit_academic_session_id', '#edit_program_id');
      initSelectOfferingType('#edit_offering_type');

      // Initialize Select2 for edit timetable form
      initSelect2Venue('#edit_venue_id');

      // Client-side form validation for course offering form
      $('#course-offering-form').on('submit', function(e) {
        let isValid = true;
        $('.text-error', this).text('');
        $('select[required], input[required]', this).each(function() {
          if (!$(this).val()) {
            const fieldName = $(this).attr('name');
            $(`#${fieldName}-error`).text('This field is required.');
            $(this).addClass('border-red-500');
            isValid = false;
          } else {
            $(this).removeClass('border-red-500');
          }
        });
        if (!isValid) {
          e.preventDefault();
          $(this).prepend(`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              Please fill in all required fields.
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          `);
        }
      });

      // Handle edit course offering (populate modal)
      $('.edit-offering').on('click', function() {
        const offeringId = $(this).data('offering-id');
        $.ajax({
          url: "{% url 'faculty_staff:get_course_offering' %}",
          type: 'GET',
          data: { offering_id: offeringId },
          success: function(response) {
            if (response.success) {
              const data = response.data;
              $('#edit_offering_id').val(data.id);
              $('#edit_course_id').append(new Option(data.course.text, data.course.id, true, true)).trigger('change');
              $('#edit_teacher_id').append(new Option(data.teacher.text, data.teacher.id, true, true)).trigger('change');
              $('#edit_offering_type').val(data.offering_type.id);
              $('#edit_academic_session_id').val(data.academic_session.id).trigger('change');
              
              $.ajax({
                url: "{% url 'faculty_staff:search_programs' %}",
                dataType: 'json',
                data: { academic_session_id: data.academic_session.id },
                success: function(programData) {
                  const $programSelect = $('#edit_program_id');
                  $programSelect.empty().append('<option value="">Select a program...</option>').prop('disabled', false);
                  $.each(programData.results, function(index, item) {
                    $programSelect.append(`<option value="${item.id}">${item.text}</option>`);
                  });
                  $programSelect.val(data.program.id).trigger('change');
                  
                  $.ajax({
                    url: "{% url 'faculty_staff:search_semesters' %}",
                    dataType: 'json',
                    data: { program_id: data.program.id, academic_session_id: data.academic_session.id },
                    success: function(semesterData) {
                      const $semesterSelect = $('#edit_semester_id');
                      $semesterSelect.empty().append('<option value="">Select a semester...</option>').prop('disabled', false);
                      $.each(semesterData.results, function(index, item) {
                        $semesterSelect.append(`<option value="${item.id}">${item.text}</option>`);
                      });
                      $semesterSelect.val(data.semester.id);
                    },
                    error: function(xhr, status, error) {
                      console.error('Error fetching semesters:', error);
                    }
                  });
                },
                error: function(xhr, status, error) {
                  console.error('Error fetching programs:', error);
                }
              });

              $('#edit_shift').val(data.shift);
              $('#edit_is_active').prop('checked', data.is_active);
              $('#edit-offering-modal').prop('checked', true);
            }
          },
          error: function(xhr, status, error) {
            console.error('Error fetching course offering:', error);
          }
        });
      });

      // Handle edit timetable slot (populate modal)
      $('.edit-timetable-slot').on('click', function() {
        const slotId = $(this).data('slot-id');
        $.ajax({
          url: "{% url 'faculty_staff:get_timetable_slot' %}",
          type: 'GET',
          data: { slot_id: slotId },
          success: function(response) {
            if (response.success) {
              const data = response.data;
              $('#edit_slot_id').val(data.id);
              $('#edit_timetable_course_offering_id').val(data.course_offering.id);
              $('#edit_timetable_course_offering_display').val(data.course_offering.text);
              $('#edit_day').val(data.day);
              $('#edit_start_time').val(data.start_time);
              $('#edit_end_time').val(data.end_time);
              $('#edit_venue_id').append(new Option(data.venue.text, data.venue.id, true, true)).trigger('change');
              $('#edit-timetable-modal').prop('checked', true);
            }
          },
          error: function(xhr, status, error) {
            console.error('Error fetching timetable slot:', error);
          }
        });
      });

      // Handle delete course offering (simplified with form submission)
      $('.delete-offering').on('click', function(e) {
        e.preventDefault();
        const offeringId = $(this).data('offering-id');
        if (confirm('Are you sure you want to delete this course offering?')) {
          const form = $('<form>', {
            method: 'POST',
            action: "{% url 'faculty_staff:delete_course_offering' %}",
            style: 'display: none;'
          }).append(
            $('<input>', { type: 'hidden', name: 'csrfmiddlewaretoken', value: $('input[name=csrfmiddlewaretoken]').val() }),
            $('<input>', { type: 'hidden', name: 'offering_id', value: offeringId })
          );
          $('body').append(form);
          form.submit();
        }
      });

      // Handle delete timetable slot (simplified with form submission)
      $('.delete-timetable-slot').on('click', function(e) {
        e.preventDefault();
        const slotId = $(this).data('slot-id');
        if (confirm('Are you sure you want to delete this timetable slot?')) {
          const form = $('<form>', {
            method: 'POST',
            action: "{% url 'faculty_staff:delete_timetable_slot' %}",
            style: 'display: none;'
          }).append(
            $('<input>', { type: 'hidden', name: 'csrfmiddlewaretoken', value: $('input[name=csrfmiddlewaretoken]').val() }),
            $('<input>', { type: 'hidden', name: 'slot_id', value: slotId })
          );
          $('body').append(form);
          form.submit();
        }
      });
    });
  </script>
</div>
{% endblock %}