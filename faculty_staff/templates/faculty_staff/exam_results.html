{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Exam Results{% endblock %}

{% block content %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .table th {
        background-color: #e9ecef;
        color: #343a40;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .select2-container {
        width: 100% !important;
    }
    .error {
        color: red;
    }
    .mark-input {
        width: 100px;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Exam Results</h2>
    </div>

    <!-- Record Exam Results Form -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Record Exam Results</h5>
            <form id="record-exam-results-form" method="post" action="{% url 'faculty_staff:record_exam_results' %}">
                {% csrf_token %}
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label for="course_offering_id" class="form-label">Course Offering</label>
                        <select name="course_offering_id" id="course_offering_id" class="form-select select2" required>
                            <option value="">Search for a course offering...</option>
                        </select>
                        <span id="course-offering-error" class="error"></span>
                    </div>
                </div>

                <!-- Students Table with Input Fields -->
                <div class="table-responsive" id="students-table-container" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Mid (100)</th>
                                <th>Sessional (100)</th>
                                <th>Project (100)</th>
                                <th>Practical (100)</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            {% for student in students %}
                            <tr>
                                <td>{{ student.name }}</td>
                                <td>
                                    <input type="number" name="mid_{{ student.id }}" class="form-control mark-input" min="0" max="100" required>
                                    <span class="error" id="mid-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="sessional_{{ student.id }}" class="form-control mark-input" min="0" max="100" required>
                                    <span class="error" id="sessional-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="project_{{ student.id }}" class="form-control mark-input" min="0" max="100" required>
                                    <span class="error" id="project-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="practical_{{ student.id }}" class="form-control mark-input" min="0" max="100" required>
                                    <span class="error" id="practical-error-{{ student.id }}"></span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No students found for the selected course offering.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">Submit All Results</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing Exam Results Table -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Existing Exam Results</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Course</th>
                            <th>Mid</th>
                            <th>Sessional</th>
                            <th>Practical</th>
                            <th>Project</th>
                            <th>Academic Session</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in exam_results %}
                        <tr>
                            <td>{{ result.student.applicant.full_name }}</td>
                            <td>{{ result.course.code }}</td>
                            <td>{{ result.mid }}</td>
                            <td>{{ result.sessional }}</td>
                            <td>{{ result.practical }}</td>
                            <td>{{ result.project }}</td>
                            <td>{{ result.final_year }}</td>
                            <td>{{ result.remarks|default:"No Remarks" }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-result" data-result-id="{{ result.id }}">Delete</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No exam results found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for course offering
    $('#course_offering_id').select2({     
        ajax: {
            url: "{% url 'faculty_staff:search_course_offerings' %}",
            dataType: 'json',
            delay: 250,
            data: function(params) {
                return { q: params.term, page: params.page || 1 };
            },
            processResults: function(data, params) {
                params.page = params.page || 1;
                return { results: data.results, pagination: { more: data.pagination.more } };
            },
            cache: true
        },
        placeholder: "Search for a course offering...",
        minimumInputLength: 1,
        allowClear: true
    });

    // Load students when course offering is selected
    $('#course_offering_id').on('change', function() {
        let courseOfferingId = $(this).val();
        if (courseOfferingId) {
            $.ajax({
                url: "{% url 'faculty_staff:load_students_for_course' %}",
                type: 'GET',
                data: { course_offering_id: courseOfferingId },
                success: function(response) {
                    if (response.success) {
                        let tbody = $('#students-table-body');
                        tbody.empty();
                        if (response.students.length > 0) {
                            response.students.forEach(student => {
                                tbody.append(`
                                    <tr>
                                        <td>${student.name}</td>
                                        <td><input type="number" name="mid_${student.id}" class="form-control mark-input" min="0" max="100" required></td>
                                        <td><input type="number" name="sessional_${student.id}" class="form-control mark-input" min="0" max="100" required></td>
                                        <td><input type="number" name="project_${student.id}" class="form-control mark-input" min="0" max="100" required></td>
                                        <td><input type="number" name="practical_${student.id}" class="form-control mark-input" min="0" max="100" required></td>
                                    </tr>
                                `);
                            });
                            $('#students-table-container').show();
                        } else {
                            tbody.append('<tr><td colspan="5" class="text-center">No students found for the selected course offering.</td></tr>');
                            $('#students-table-container').show();
                        }
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        } else {
            $('#students-table-container').hide();
        }
    });

    // Handle form submission with AJAX
    $('#record-exam-results-form').on('submit', function(e) {
        e.preventDefault();
        let formData = $(this).serialize();
        let error = false;

        if (!$('#course_offering_id').val()) {
            $('#course-offering-error').text('Please select a course offering.');
            error = true;
        } else {
            $('#course-offering-error').text('');
        }

        let hasInvalidMarks = false;
        $('#students-table-body input[type="number"]').each(function() {
            let value = parseInt($(this).val());
            let id = $(this).attr('name').split('_')[0];
            let errorSpan = $(`#${id}-error-${$(this).attr('name').split('_')[1]}`);
            if (isNaN(value) || value < 0 || value > 100) {
                errorSpan.text('Marks must be between 0 and 100.');
                hasInvalidMarks = true;
            } else {
                errorSpan.text('');
            }
        });

        if (error || hasInvalidMarks) {
            return;
        }

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    $('#record-exam-results-form')[0].reset();
                    $('#course_offering_id').val(null).trigger('change');
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred: ' + error);
            }
        });
    });

    // Handle delete action with AJAX
    $('.delete-result').on('click', function() {
        let resultId = $(this).data('result-id');
        if (confirm('Are you sure you want to delete this exam result?')) {
            $.ajax({
                url: "{% url 'faculty_staff:delete_exam_result' %}",
                type: 'POST',
                data: {
                    result_id: resultId,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        }
    });
});
</script>
{% endblock %}