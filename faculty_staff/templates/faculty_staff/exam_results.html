{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Exam Results{% endblock %}

{% block extra_head %}
<style media="screen">
    .table-container {
        overflow-x: auto;
        max-width: 100%;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: auto;
    }
    th, td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
        vertical-align: middle;
        min-width: 100px;
    }
    th {
        background-color: #f1f1f1;
        font-weight: bold;
        white-space: nowrap;
    }
    .input-sm {
        width: 100%;
        max-width: 100px;
        padding: 4px;
    }
    .remarks-input {
        min-width: 200px !important;
        width: 100%;
        max-width: 300px;
    }
    @media screen and (max-width: 768px) {
        th, td {
            padding: 6px;
            font-size: 14px;
            min-width: 80px;
        }
        .input-sm {
            max-width: 80px;
        }
        .remarks-input {
            min-width: 150px !important;
            max-width: 200px;
        }
        .hero-content {
            padding: 16px;
        }
        .hero h1 {
            font-size: 1.5rem;
        }
        .hero p {
            font-size: 0.9rem;
        }
        .card-title {
            font-size: 1.25rem;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
    }
    @media screen and (max-width: 480px) {
        th, td {
            padding: 4px;
            font-size: 12px;
            min-width: 60px;
        }
        .input-sm {
            max-width: 60px;
        }
        .remarks-input {
            min-width: 120px !important;
            max-width: 150px;
        }
        .hero h1 {
            font-size: 1.25rem;
        }
        .hero p {
            font-size: 0.8rem;
        }
    }
</style>
<style media="print">
    @page {
        size: landscape;
        margin: 0.5cm;
    }
    body * {
        visibility: hidden;  
    }
    .print-section, .print-section * {
        visibility: visible;
    }
    .print-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
    .no-print {
        display: none !important;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #000;
        padding: 6px;
        text-align: left;
        font-size: 11px;
    }
    th {
        background-color: #f1f1f1;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Hero Section -->
    <div class="hero bg-gradient-to-r from-primary to-secondary rounded-box mb-6">
        <div class="hero-content text-center py-8">
            <div>
                <h1 class="text-3xl font-bold text-primary-content">Exam Results</h1>
                <p class="text-base-content/70">
                    {{ course_offering.course.code }} - {{ course_offering.course.name }}
                    <br>
                    <span class="text-sm">Academic Session: {{ course_offering.academic_session.name }} | {{ course_offering.semester.name }} |  {{ course_offering.shift|title }}</span>
                </p>
            </div>
        </div>
    </div>
    
    <!-- Record/Update Exam Results Form -->
    <div class="card bg-base-100 shadow-xl mb-6 print-section">
        <div class="card-body">
            <div class="flex justify-between items-center mb-4">
                <h2 class="card-title">Record/Update Exam Results</h2>
                <button id="printButton" class="btn btn-primary btn-sm print:hidden no-print">
                    <i class="fas fa-print mr-2"></i>Print Results
                </button>
            </div>
            <form method="post" action="{% url 'faculty_staff:record_exam_results' %}">
                {% csrf_token %}
                <input type="hidden" name="course_offering_id" value="{{ course_offering_id }}">
                <div class="table-container">
                    <table class="table w-full" id="studentsTable">
                        <thead>
                            <tr>
                                <th>University Roll No</th>
                                <th>Student</th>
                                <th>Midterm (Max: <span id="midtermMax">{{ midterm_max|default:0 }}</span>)</th>
                                <th>Sessional (Max: <span id="sessionalMax">{{ sessional_max|default:0 }}</span>)</th>
                                <th>Final (Max: <span id="finalMax">{{ final_max|default:0 }}</span>)</th>
                                {% if course_offering.course.lab_work > 0 %}
                                <th>Practical (Max: <span id="practicalMax">{{ practical_max|default:0 }}</span>)</th>
                                {% endif %}
                                <th>Total Obtained Marks</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            {% for student in students %}
                            <tr data-student-id="{{ student.id }}">
                                <td>{{ student.university_roll_no }}</td>
                                <td>
                                    {{ student.name }}
                                    <input type="hidden" name="student_ids[]" value="{{ student.id }}">
                                </td>
                                <td>
                                    <input type="number" name="midterm_{{ student.id }}" class="input input-bordered input-sm w-24 marks-input" 
                                           min="0" max="{{ midterm_max }}" value="{{ student.midterm|default_if_none:'0' }}" data-student-id="{{ student.id }}">
                                </td>
                                <td>
                                    <input type="number" name="sessional_{{ student.id }}" class="input input-bordered input-sm w-24 marks-input" 
                                           min="0" max="{{ sessional_max }}" value="{{ student.sessional|default_if_none:'0' }}" data-student-id="{{ student.id }}">
                                </td>
                                <td>
                                    <input type="number" name="final_{{ student.id }}" class="input input-bordered input-sm w-24 marks-input" 
                                           min="0" max="{{ final_max }}" value="{{ student.final|default_if_none:'0' }}" data-student-id="{{ student.id }}">
                                </td>
                                {% if course_offering.course.lab_work > 0 %}
                                <td>
                                    <input type="number" name="practical_{{ student.id }}" class="input input-bordered input-sm w-24 marks-input" 
                                           min="0" max="{{ practical_max }}" value="{{ student.practical|default_if_none:'0' }}" data-student-id="{{ student.id }}">
                                </td>
                                {% endif %}
                                <td>
                                    <input type="number" name="total_obtained_{{ student.id }}" class="input input-bordered input-sm w-24 total-obtained" 
                                           value="0" readonly>
                                </td>
                                <td>
                                    <input type="number" name="total_max_{{ student.id }}" class="input input-bordered input-sm w-24 total-marks" 
                                           value="{{ totalMax }}" readonly>
                                </td>
                                <td>
                                    <input type="text" name="percentage_{{ student.id }}" class="input input-bordered input-sm w-24 percentage" 
                                           value="0%" readonly>
                                </td>
                                <td>
                                    <input type="text" name="remarks_{{ student.id }}" class="input input-bordered input-sm remarks-input" 
                                           value="{{ student.remarks|default_if_none:'' }}">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-actions justify-end mt-4">
                    <button type="submit" class="btn btn-primary no-print">Save All Results</button>
                </div>
            </form>
        </div>
    </div>  
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const courseOfferingId = {{ course_offering_id|default:0 }};
    const midtermMax = {{ midterm_max|default:0 }};
    const sessionalMax = {{ sessional_max|default:0 }};
    const finalMax = {{ final_max|default:0 }};
    const practicalMax = {{ practical_max|default:0 }};
    const totalMax = {{ totalMax|default:0 }};
    const hasPractical = {{ course_offering.course.lab_work|default:0 }} > 0;

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Calculate totals for a student row
    function calculateTotals(studentId) {
        const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
        if (!row) return;

        const getValue = (name) => {
            const el = row.querySelector(`input[name="${name}_${studentId}"]`);
            return el ? parseFloat(el.value) || 0 : 0;
        };

        const midterm = getValue("midterm");
        const sessional = getValue("sessional");
        const final = getValue("final");
        const practical = hasPractical ? getValue("practical") : 0;

        const total = midterm + sessional + final + practical;
        const percentage = totalMax > 0 ? ((total / totalMax) * 100).toFixed(2) : "0.00";

        const totalObtainedInput = row.querySelector(`input[name="total_obtained_${studentId}"]`);
        const percentageInput = row.querySelector(`input[name="percentage_${studentId}"]`);

        if (totalObtainedInput) totalObtainedInput.value = total.toFixed(2);
        if (percentageInput) percentageInput.value = `${percentage}%`;
    }

    // Real-time update with debouncing
    const debouncedCalculateTotals = debounce(calculateTotals, 100);

    // Attach event listeners to table inputs
    document.querySelectorAll('#studentsTableBody tr').forEach(row => {
        const studentId = row.dataset.studentId;
        row.querySelectorAll('.marks-input').forEach(input => {
            ['input', 'change', 'keyup'].forEach(eventType => {
                input.addEventListener(eventType, () => debouncedCalculateTotals(studentId));
            });
        });
        // Calculate initial totals for each row
        calculateTotals(studentId);
    });

    // Print functionality
    const printButton = document.getElementById('printButton');
    if (printButton) {
        printButton.addEventListener('click', () => {
            const printWindow = window.open('', '', 'width=1000,height=600');
            const tableRows = Array.from(document.querySelectorAll('.print-section .table-container tbody tr'))
                .filter(row => row.querySelectorAll('td').length > 1)
                .map((row, index) => {
                    const studentId = row.dataset.studentId;
                    const universityRollNo = row.querySelector('td:nth-child(1)').textContent;
                    const studentName = row.querySelector('td:nth-child(2)').textContent;
                    const midterm = row.querySelector(`input[name="midterm_${studentId}"]`).value || '0';
                    const sessional = row.querySelector(`input[name="sessional_${studentId}"]`).value || '0';
                    const final = row.querySelector(`input[name="final_${studentId}"]`).value || '0';
                    const practical = hasPractical ? (row.querySelector(`input[name="practical_${studentId}"]`)?.value || '0') : '';
                    const totalObtained = row.querySelector(`input[name="total_obtained_${studentId}"]`).value || '0';
                    const totalMarks = row.querySelector(`input[name="total_max_${studentId}"]`).value || '0';
                    const percentage = row.querySelector(`input[name="percentage_${studentId}"]`).value || '0%';
                    const remarks = row.querySelector(`input[name="remarks_${studentId}"]`).value || 'No Remarks';
                    
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${universityRollNo}</td>
                            <td>${studentName}</td>
                            <td>${midterm}/${midtermMax}</td>
                            <td>${sessional}/${sessionalMax}</td>
                            <td>${final}/${finalMax}</td>
                            ${hasPractical ? `<td>${practical}/${practicalMax}</td>` : ''}
                            <td>${totalObtained}</td>
                            <td>${totalMarks}</td>
                            <td>${percentage}</td>
                            <td>${remarks}</td>
                        </tr>
                    `;
                }).join('');

            const tableHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Exam Results - ${document.querySelector('h1').textContent}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                        h1 { color: #333; text-align: center; margin-bottom: 20px; font-size: 18px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
                        th, td { border: 1px solid #000; padding: 6px; text-align: left; }
                        th { background-color: #f1f1f1; font-weight: bold; white-space: nowrap; }
                        .print-header { text-align: center; margin-bottom: 15px; }
                        .print-header h1 { margin: 0 0 5px 0; }
                        .print-header p { margin: 3px 0; font-size: 11px; }
                        @page { 
                            size: A4 landscape; 
                            margin: 0.5cm;
                            @bottom-center {
                                content: "Page " counter(page) " of " counter(pages);
                                font-size: 10px;
                            }
                        }
                        @media print {
                            table { page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            thead { display: table-header-group; }
                            tfoot { display: table-footer-group; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>${document.querySelector('h1').textContent}</h1>
                        <p>${document.querySelector('h1').nextElementSibling.textContent}</p>
                        <p>Printed on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>PRN</th>
                                <th>University Roll No</th>
                                <th>Student</th>
                                <th>Midterm</th>
                                <th>Sessional</th>
                                <th>Final</th>
                                ${hasPractical ? '<th>Practical</th>' : ''}
                                <th>Total Obtained Marks</th>
                                <th>Total Marks</th>
                                <th>Percentage</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            printWindow.document.open();
            printWindow.document.write(tableHtml);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        });
    }

    // Form validation
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', (e) => {
            let isValid = true;
            document.querySelectorAll('.marks-input').forEach(input => {
                const max = parseFloat(input.max) || 100;
                const value = parseFloat(input.value);
                if (input.value !== '' && (isNaN(value) || value < 0 || value > max)) {
                    input.classList.add('input-error');
                    isValid = false;
                } else {
                    input.classList.remove('input-error');
                }
            });
            if (!isValid) {
                e.preventDefault();
                alert('Please ensure all marks are valid numbers within the specified ranges.');
            }
        });
    });
});
</script>
{% endblock %}