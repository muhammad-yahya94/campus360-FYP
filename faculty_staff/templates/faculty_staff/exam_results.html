{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}Exam Results{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Hero Section -->
    <div class="hero bg-gradient-to-r from-primary to-secondary rounded-box mb-6">
        <div class="hero-content text-center py-8">
            <div>
                <h1 class="text-3xl font-bold text-primary-content">Exam Results</h1>
                <p class="text-base-content/70">
                    {{ course_offering.course.code }} - {{ course_offering.course.name }}
                    <br>
                    <span class="text-sm">Academic Session: {{ course_offering.academic_session.name }}</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    {% if error %}
    <div class="alert alert-error mb-6 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>{{ error }}</span>
    </div>
    {% endif %}
    

    {% if not exam_results %}
    <!-- Record Exam Results Form -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Record Exam Results</h2>
            <form id="record-exam-results-form" method="post" action="{% url 'faculty_staff:record_exam_results' %}">
                {% csrf_token %}
                <input type="hidden" name="course_offering_id" id="hidden_course_offering_id" value="{{ course_offering_id|default_if_none:'' }}">
                <div class="form-control mb-4">
                    <label class="label" for="course_offering_id">
                        <span class="label-text">Course Offering</span>
                    </label>
                    <select name="course_offering_display" id="course_offering_id" class="select select-bordered w-full" disabled>
                        <option value="">Loading course offering...</option>
                    </select>
                    <span id="course-offering-error" class="text-error text-sm mt-1"></span>
                </div>

                <!-- Students Table -->
                <div class="overflow-x-auto" id="students-table-container" style="display: none;">
                    <table class="table w-full">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Mid</th>
                                <th>Sessional</th>
                                <th>Final</th>
                                <th>Practical</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            {% for student in students %}
                            <tr>
                                <td>{{ student.name }}</td>
                                <td>
                                    <input type="number" name="mid_{{ student.id }}" class="input input-bordered input-sm w-24" min="0" max="100">
                                    <span class="text-error text-sm" id="mid-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="sessional_{{ student.id }}" class="input input-bordered input-sm w-24" min="0" max="100">
                                    <span class="text-error text-sm" id="sessional-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="project_{{ student.id }}" class="input input-bordered input-sm w-24" min="0" max="100">
                                    <span class="text-error text-sm" id="project-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="number" name="practical_{{ student.id }}" class="input input-bordered input-sm w-24" min="0" max="100">
                                    <span class="text-error text-sm" id="practical-error-{{ student.id }}"></span>
                                </td>
                                <td>
                                    <input type="text" name="remarks_{{ student.id }}" class="input input-bordered input-sm w-full">
                                    <span class="text-error text-sm" id="remarks-error-{{ student.id }}"></span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No students found for the selected course offering.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="card-actions justify-end mt-4">
                        <button type="submit" class="btn btn-primary">Submit All Results</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
    <!-- Existing Exam Results Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Existing Exam Results</h2>
            <div class="overflow-x-auto">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Course</th>
                            <th>Mid</th>
                            <th>Sessional</th>
                            <th>Practical</th>
                            <th>Final</th>
                            <th>Academic Session</th>
                            <th>Remarks</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in exam_results %}
                        <tr>
                            <td>{{ result.student.applicant.full_name }}</td>
                            <td>{{ result.course.code }}</td>
                            <td>{{ result.mid|default:'0' }}</td>
                            <td>{{ result.sessional|default:'0' }}</td>
                            <td>{{ result.practical|default:'0' }}</td>
                            <td>{{ result.project|default:'0' }}</td>
                            <td>{{ result.final_year }}</td>
                            <td>{{ result.remarks|default:"No Remarks" }}</td>
                            <td>
                                <label for="editResultModal" class="btn btn-warning btn-sm edit-result" 
                                       data-result-id="{{ result.id }}"
                                       data-mid="{{ result.mid|default:'0' }}"
                                       data-sessional="{{ result.sessional|default:'0' }}"
                                       data-practical="{{ result.practical|default:'0' }}"
                                       data-project="{{ result.project|default:'0' }}"
                                       data-remarks="{{ result.remarks|default:''|escape }}">
                                    <i class="fas fa-edit"></i> Edit
                                </label>
                                <button class="btn btn-error btn-sm delete-result" data-result-id="{{ result.id }}">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No exam results found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Result Modal -->
<input type="checkbox" id="editResultModal" class="modal-toggle" />
<div class="modal" role="dialog">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Edit Exam Result</h3>
        <form id="edit-result-form">
            {% csrf_token %}
            <input type="hidden" id="edit_result_id" name="result_id" value="">
            <input type="hidden" id="edit_course_offering_id" name="course_offering_id" value="{{ course_offering_id|default_if_none:'' }}">
            <div class="form-control mb-3">
                <label class="label" for="edit_mid">
                    <span class="label-text">Mid Marks</span>
                </label>
                <input type="number" class="input input-bordered" id="edit_mid" name="mid" min="0" max="100">
            </div>
            <div class="form-control mb-3">
                <label class="label" for="edit_sessional">
                    <span class="label-text">Sessional Marks</span>
                </label>
                <input type="number" class="input input-bordered" id="edit_sessional" name="sessional" min="0" max="100">
            </div>
            <div class="form-control mb-3">
                <label class="label" for="edit_practical">
                    <span class="label-text">Practical Marks</span>
                </label>
                <input type="number" class="input input-bordered" id="edit_practical" name="practical" min="0" max="100">
            </div>
            <div class="form-control mb-3">
                <label class="label" for="edit_project">
                    <span class="label-text">Final Project Marks</span>
                </label>
                <input type="number" class="input input-bordered" id="edit_project" name="project" min="0" max="100">
            </div>
            <div class="form-control mb-3">
                <label class="label" for="edit_remarks">
                    <span class="label-text">Remarks</span>
                </label>
                <textarea class="textarea textarea-bordered" id="edit_remarks" name="remarks" rows="3"></textarea>
            </div>
            <div class="modal-action">
                <label for="editResultModal" class="btn btn-ghost">Close</label>
                <button type="submit" class="btn btn-primary">Save changes</button>
            </div>
        </form>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script>
$(document).ready(function() {
    // Initialize Select2 for course offering
    $('#course_offering_id').select2({
        placeholder: "Course offering selected",
        minimumResultsForSearch: Infinity,
        allowClear: false,
        width: '100%'
    }).prop('disabled', true);

    // Function to load students for a course offering
    function loadStudents(courseOfferingId) {
        $.ajax({
            url: "{% url 'faculty_staff:load_students_for_course' %}",
            type: 'GET',
            data: { course_offering_id: courseOfferingId },
            success: function(response) {
                if (response.success) {
                    let tbody = $('#students-table-body');
                    tbody.empty();
                    if (response.students.length > 0) {
                        response.students.forEach(student => {
                            tbody.append(`
                                <tr>
                                    <td>${student.name}</td>
                                    <td>
                                        <input type="number" name="mid_${student.id}" class="input input-bordered input-sm w-24" min="0" max="100">
                                        <span class="text-error text-sm" id="mid-error-${student.id}"></span>
                                    </td>
                                    <td>
                                        <input type="number" name="sessional_${student.id}" class="input input-bordered input-sm w-24" min="0" max="100">
                                        <span class="text-error text-sm" id="sessional-error-${student.id}"></span>
                                    </td>
                                    <td>
                                        <input type="number" name="project_${student.id}" class="input input-bordered input-sm w-24" min="0" max="100">
                                        <span class="text-error text-sm" id="project-error-${student.id}"></span>
                                    </td>
                                    <td>
                                        <input type="number" name="practical_${student.id}" class="input input-bordered input-sm w-24" min="0" max="100">
                                        <span class="text-error text-sm" id="practical-error-${student.id}"></span>
                                    </td>
                                    <td>
                                        <input type="text" name="remarks_${student.id}" class="input input-bordered input-sm w-full">
                                        <span class="text-error text-sm" id="remarks-error-${student.id}"></span>
                                    </td>
                                </tr>
                            `);
                        });
                        $('#students-table-container').show();
                    } else {
                        tbody.append('<tr><td colspan="6" class="text-center">No students found for the selected course offering.</td></tr>');
                        $('#students-table-container').show();
                    }
                } else {
                    alert('Error: ' + response.message);
                    $('#students-table-container').hide();
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred: ' + error);
                $('#students-table-container').hide();
            }
        });
    }

    // Load course offering on page load
    const urlParams = new URLSearchParams(window.location.search);
    const courseOfferingId = urlParams.get('course_offering_id');
    if (courseOfferingId) {
        $('#hidden_course_offering_id').val(courseOfferingId);
        $('#edit_course_offering_id').val(courseOfferingId);
        $.ajax({
            url: "{% url 'faculty_staff:search_course_offerings' %}",
            type: 'GET',
            data: { id: courseOfferingId },
            success: function(response) {
                if (response.success && response.results.length > 0) {
                    const course = response.results[0];
                    const option = new Option(
                        `${course.course_code} - ${course.program_name} (${course.semester_name}, ${course.session_name})`,
                        course.id,
                        true,
                        true
                    );
                    $('#course_offering_id').empty().append(option).trigger('change');
                    loadStudents(courseOfferingId);
                } else {
                    $('#course_offering_id').empty().append('<option value="">Course offering not found</option>');
                    alert('Error: Course offering not found.');
                    $('#students-table-container').hide();
                }
            },
            error: function(xhr, status, error) {
                $('#course_offering_id').empty().append('<option value="">Error loading course</option>');
                alert('An error occurred while fetching course offering: ' + error);
                $('#students-table-container').hide();
            }
        });
    } else {
        $('#course_offering_id').empty().append('<option value="">No course selected</option>');
        $('#students-table-container').hide();
        alert('Error: Course offering ID not provided.');
    }

    // Handle form submission
    $('#record-exam-results-form').on('submit', function(e) {
        e.preventDefault();
        let formData = $(this).serialize();
        let error = false;

        if (!$('#hidden_course_offering_id').val()) {
            $('#course-offering-error').text('Course offering ID is missing.');
            error = true;
        } else {
            $('#course-offering-error').text('');
        }

        let hasInvalidMarks = false;
        $('#students-table-body input[type="number"]').each(function() {
            let value = parseInt($(this).val());
            let id = $(this).attr('name').split('_')[0];
            let errorSpan = $(`#${id}-error-${$(this).attr('name').split('_')[1]}`);
            if (isNaN(value) || value < 0 || value > 100) {
                errorSpan.text('Marks must be between 0 and 100.');
                hasInvalidMarks = true;
            } else {
                errorSpan.text('');
            }
        });

        if (error || hasInvalidMarks) {
            return;
        }

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    $('#record-exam-results-form')[0].reset();
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred: ' + error);
            }
        });
    });

    // Handle edit button click
    $(document).on('click', '.edit-result', function(e) {
        e.preventDefault();
        const $button = $(this);
        const resultId = $button.data('result-id');
        const mid = $button.data('mid');
        const sessional = $button.data('sessional');
        const practical = $button.data('practical');
        const project = $button.data('project');
        const remarks = $button.data('remarks');

        // Log button data for debugging
        console.log('Edit button data:', {
            resultId: resultId,
            mid: mid,
            sessional: sessional,
            practical: practical,
            project: project,
            remarks: remarks
        });

        // Populate the form with existing data
        $('#edit_result_id').val(resultId || '');
        $('#edit_mid').val(mid || '');
        $('#edit_sessional').val(sessional || '');
        $('#edit_practical').val(practical || '');
        $('#edit_project').val(project || '');
        $('#edit_remarks').val(remarks || '');

        // Log form values for debugging
        console.log('Form values after setting:', {
            result_id: $('#edit_result_id').val(),
            course_offering_id: $('#edit_course_offering_id').val(),
            mid: $('#edit_mid').val(),
            sessional: $('#edit_sessional').val(),
            practical: $('#edit_practical').val(),
            project: $('#edit_project').val(),
            remarks: $('#edit_remarks').val()
        });

        // Show the modal
        document.getElementById('editResultModal').checked = true;
    });

    // Handle edit form submission
    $(document).on('submit', '#edit-result-form', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const formDataObj = Object.fromEntries(formData);

        // Log form data before submission
        console.log('Form data before submission:', formDataObj);

        // Validate result_id
        if (!formDataObj.result_id) {
            alert('Error: Result ID is missing.');
            return;
        }

        $.ajax({
            url: "{% url 'faculty_staff:update_exam_result' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                console.log('Update response:', response);
                if (response.success) {
                    alert('Result updated successfully!');
                    document.getElementById('editResultModal').checked = false;
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error details:', xhr.responseText);
                alert('An error occurred while updating the result: ' + (xhr.responseJSON?.message || error));
            }
        });
    });

    // Handle delete action
    $(document).on('click', '.delete-result', function() {
        let resultId = $(this).data('result-id');
        if (confirm('Are you sure you want to delete this exam result?')) {
            $.ajax({
                url: "{% url 'faculty_staff:delete_exam_result' %}",
                type: 'POST',
                data: {
                    result_id: resultId,
                    course_offering_id: $('#hidden_course_offering_id').val(),
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    alert('An error occurred: ' + error);
                }
            });
        }
    });
});
</script>
{% endblock %}