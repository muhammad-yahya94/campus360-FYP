{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}My Timetable - {{ teacher.user.first_name }} {{ teacher.user.last_name }}{% endblock %}

{% block extra_css %}
<style>
  @media print {
    body {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      font-size: 13px;
      line-height: 1.4;
    }
    .bg-blue-100, .bg-purple-100, .bg-green-100 {
      -webkit-print-color-adjust: exact;
      break-inside: avoid;
      page-break-inside: avoid;
    }
    .print-header {
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .bg-white, .print-tooltip, .bg-opacity-50 {
      background-color: #fff !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      border: 1px solid #f3f4f6 !important;
    }
    [class*='from-'], [class*='to-'] {
      background-image: none !important;
    }
    .text-gray-600, .text-gray-700, .text-gray-900 {
      color: #1f2937 !important;
    }
    .print-tooltip {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      position: static !important;
      transform: none !important;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #f9fafb !important;
      border: 1px solid #e5e7eb !important;
      font-size: 12px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-xl shadow-lg mb-6">
    <div class="text-center py-8">
      <h1 class="text-4xl font-bold mb-2">My Timetable</h1>
      <p class="text-lg opacity-90">{{ teacher.user.first_name }} {{ teacher.user.last_name }} - <span class="academic-session">{{ academic_session.name|default:'No Active Session' }}</span></p>
    </div>
  </div>

  <!-- Controls Row -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
    <a href="{% url 'faculty_staff:course_offerings' %}" class="no-print inline-flex items-center px-4 py-2 border border-indigo-500 text-indigo-500 bg-white hover:bg-indigo-50 rounded-lg shadow-sm">
      <i class="fas fa-arrow-left mr-2"></i>
      Back to Course Offerings
    </a>
    <div class="flex flex-wrap items-center gap-4">
      <div class="flex items-center gap-2">
        <label for="session-filter" class="text-sm font-medium text-gray-700">Session:</label>
        <select id="session-filter" onchange="window.location.href='?session_id=' + this.value + '&shift=' + document.getElementById('shift-filter').value" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for session in academic_sessions %}
            <option value="{{ session.id }}" {% if request.GET.session_id|default:'' == session.id|stringformat:'s' %}selected{% endif %}>
              {{ session.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label for="shift-filter" class="text-sm font-medium text-gray-700">Shift:</label>
        <select id="shift-filter" onchange="window.location.href='?session_id=' + document.getElementById('session-filter').value + '&shift=' + this.value" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for value, label in shift_options %}
            <option value="{{ value }}" {% if shift_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <button onclick="printTimetable()" class="no-print inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <i class="fas fa-print mr-2"></i> Print Timetable
      </button>
    </div>
  </div>

  <!-- Timetable -->
  <div class="bg-white shadow-xl rounded-lg p-6 print-section">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">
        <i class="fas fa-calendar-week mr-2"></i>
        My Schedule
      </h2>
      <span class="text-sm font-medium bg-gray-100 px-3 py-1 rounded-full">{{ academic_session.name|default:'No Active Session' }}</span>
    </div>
    
    {% if timetable_data %}
      <div class="space-y-4">
        {% for day in timetable_data %}
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button class="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition duration-200" onclick="toggleDay('{{ day.day_value }}')">
              <span class="text-lg font-semibold text-gray-800">{{ day.day_label }}</span>
              <i id="toggle-icon-{{ day.day_value }}" class="fas fa-chevron-down text-gray-600"></i>
            </button>
            <div id="slots-{{ day.day_value }}" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for slot in day.slots %}
                <div class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 transform hover:scale-[1.02] 
                  {% if slot.shift == 'Morning' %}bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-400
                  {% elif slot.shift == 'Evening' %}bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-400
                  {% else %}bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-400{% endif %}
                  hover:shadow-xl" 
                  data-tooltip="Program: {{ slot.program }}"
                  data-course-code="{{ slot.course_code }}"
                  data-course-name="{{ slot.course_name }}"
                  data-program="{{ slot.program }}">
                  <div class="p-5">
                    <!-- Course Header -->
                    <div class="flex items-start justify-between mb-3">
                      <div>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                          {% if slot.shift == 'Morning' %}bg-blue-100 text-blue-800
                          {% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-800
                          {% else %}bg-green-100 text-green-800{% endif %} mb-2">
                          {{ slot.shift }}
                        </span>
                        <h3 class="text-lg font-bold 
                          {% if slot.shift == 'Morning' %}text-blue-900
                          {% elif slot.shift == 'Evening' %}text-purple-900
                          {% else %}text-green-900{% endif %} mb-1">
                          {{ slot.course_code }}
                        </h3>
                        <p class="text-sm font-medium text-gray-600">{{ slot.course_name }}</p>
                      </div>
                    </div>
                    
                    <!-- Program Info -->
                    <div class="mt-3 p-3 bg-white bg-opacity-50 rounded-lg border border-gray-100">
                      <p class="text-sm text-gray-700">
                        <i class="fas fa-graduation-cap mr-2"></i>{{ slot.program|default:'No Program' }}
                      </p>
                    </div>
                    
                    <!-- Location and Time -->
                    <div class="mt-3 space-y-2">
                      <p class="text-sm text-gray-600 flex items-center">
                        <i class="fas fa-map-marker-alt mr-2 w-4 text-center"></i>
                        {{ slot.venue }} - Room {{ slot.room_no }}
                      </p>
                      <p class="text-sm text-gray-600 flex items-center">
                        <i class="fas fa-clock mr-2 w-4 text-center"></i>
                        {{ slot.start_time }}â€“{{ slot.end_time }}
                      </p>
                    </div>
                  </div>
                </div>
              {% empty %}
                <p class="col-span-full text-center text-gray-500">No slots scheduled for {{ day.day_label }}.</p>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

{% block extra_js %}
<script>
function toggleDay(dayId) {
  const slots = document.getElementById(`slots-${dayId}`);
  const icon = document.getElementById(`toggle-icon-${dayId}`);
  if (slots.classList.contains('hidden')) {
    slots.classList.remove('hidden');
    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
  } else {
    slots.classList.add('hidden');
    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
  }
}

function printTimetable() {
  try {
    // Create a new container for the print content
    const printContent = document.querySelector('.print-section').cloneNode(true);
    printContent.className = 'print-container';
    
    // Get the current academic session
    const academicSession = document.querySelector('.academic-session')?.textContent || 'Current Session';
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    
    // Check if window was opened (not blocked by popup blocker)
    if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
      alert('Please allow popups for this site to use the print feature.');
      return;
    }
    
    // Create the print document
    const printDoc = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>My Timetable - ${document.title}</title>
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
        <style>
          @page {
            size: A4 landscape;
            margin: 0.5cm;
          }
          body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            font-size: 12px;
          }
          .print-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
          }
          .print-header h1 {
            margin: 0 0 5px 0;
            font-size: 24px;
            color: #1e40af;
          }
          .print-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 10px;
            color: #6b7280;
          }
          /* Ensure cards don't break across pages */
          .border-gray-200 {
            page-break-inside: avoid;
            break-inside: avoid;
          }
          /* Force grid layout for printing */
          .grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
          }
          /* Print-specific styles */
          @media print {
            .teacher-section {
              page-break-after: always;
              margin-bottom: 2rem;
            }
            .teacher-section h2 {
              color: #1e40af;
              font-size: 1.5rem;
              margin-bottom: 1.5rem;
            }
            body {
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
              font-size: 13px;
              line-height: 1.4;
            }
            [class*='from-'] {
              background: #fff !important;
              border: 1px solid #e5e7eb !important;
            }
            .border-gray-200 {
              break-inside: avoid;
              page-break-inside: avoid;
              margin-bottom: 16px;
            }
            .print-header {
              border-bottom: 2px solid #e5e7eb;
              padding-bottom: 15px;
              margin-bottom: 20px;
            }
            .bg-white, .print-tooltip, .bg-opacity-50 {
              background-color: #fff !important;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
              border: 1px solid #f3f4f6 !important;
            }
            [class*='from-'], [class*='to-'] {
              background-image: none !important;
            }
            .text-gray-600, .text-gray-700, .text-gray-900 {
              color: #1f2937 !important;
            }
            .print-tooltip {
              display: block !important;
              opacity: 1 !important;
              visibility: visible !important;
              position: static !important;
              transform: none !important;
              margin-top: 8px;
              padding: 8px 12px;
              border-radius: 6px;
              background-color: #f9fafb !important;
              border: 1px solid #e5e7eb !important;
              font-size: 12px;
            }
          }
        </style>
      </head>
      <body>
        <div class="print-header">
          <h1>${document.querySelector('h1').textContent}</h1>
          <p>${document.querySelector('.text-lg').textContent}</p>
          <p>Generated on: ${new Date().toLocaleString()}</p>
        </div>
        ${printContent.outerHTML}
        <div class="print-footer">
          Generated by Campus360 - ${window.location.hostname}
        </div>
        <script>
          // Auto-print when the print window loads
          window.onload = function() {
            // Expand all days for printing
            document.querySelectorAll('[id^="slots-"]').forEach(el => {
              el.classList.remove('hidden');
            });
            
            setTimeout(function() {
              window.print();
            }, 500);
          };
        <\/script>
      </body>
      </html>
    `;
    
    printWindow.document.open();
    printWindow.document.write(printDoc);
    printWindow.document.close();
    
    // Focus the window (helps with some browsers)
    printWindow.focus();
    
  } catch (error) {
    console.error('Print error:', error);
    alert('An error occurred while preparing the print view. Please try again.');
  }
}

// Initialize all days as expanded
document.querySelectorAll('[id^="slots-"]').forEach(el => el.classList.remove('hidden'));

// Add event listener for print button
document.addEventListener('DOMContentLoaded', function() {
  // Add click handler for print button if it exists
  const printBtn = document.getElementById('print-timetable-btn');
  if (printBtn) {
    printBtn.addEventListener('click', printTimetable);
  }
  
  // Initialize tooltips
  document.querySelectorAll('[data-tooltip]').forEach(el => {
    el.classList.add('group', 'relative');
    const tooltip = document.createElement('div');
    tooltip.className = 'hidden group-hover:block absolute z-10 w-48 p-2 text-sm text-white bg-gray-800 rounded shadow-lg -top-12 left-1/2 transform -translate-x-1/2';
    tooltip.innerHTML = el.getAttribute('data-tooltip');
    el.appendChild(tooltip);
  });
});
</script>

<style>
  /* Ensure Tailwind group-hover works */
  .group:hover .group-hover\:block {
    display: block !important;
  }
  
  /* Print-specific styles */
  @media print {
    .no-print {
      display: none !important;
    }
    
    .print-section {
      padding: 0;
      box-shadow: none;
    }
    
    .print-container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }
    
    /* Ensure proper page breaks */
    .break-after-page {
      page-break-after: always;
      break-after: page;
    }
    
    /* Ensure tables don't break across pages */
    table {
      page-break-inside: auto;
    }
    
    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
    
    /* Ensure cards don't break across pages */
    [class*='grid-cols-'] > * {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }
</style>
{% endblock %}
{% endblock %}