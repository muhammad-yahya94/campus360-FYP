{% extends 'faculty_staff/base_dashboard.html' %}

{% block title %}My Timetable - {{ teacher.user.first_name }} {{ teacher.user.last_name }}{% endblock %}

{% block extra_css %}
<style>
  @media print {
    body {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      font-size: 13px;
      line-height: 1.4;
    }
    .bg-blue-100, .bg-purple-100, .bg-green-100, .bg-yellow-100 {
      -webkit-print-color-adjust: exact;
      break-inside: avoid;
      page-break-inside: avoid;
    }
    .print-header {
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .bg-white, .print-tooltip, .bg-opacity-50 {
      background-color: #fff !important;
      border: 1px solid #f3f4f6 !important;
    }
    [class*='from-'], [class*='to-'] {
      background-image: none !important;
    }
    .text-gray-600, .text-gray-700, .text-gray-900 {
      color: #1f2937 !important;
    }
    .print-tooltip {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
      position: static !important;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      background-color: #f9fafb !important;
      border: 1px solid #e5e7eb !important;
      font-size: 12px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-xl shadow-lg mb-6">
    <div class="text-center py-8">
      <h1 class="text-4xl font-bold mb-2">My Timetable</h1>
      <p class="text-lg opacity-90">{{ teacher.user.first_name }} {{ teacher.user.last_name }} - <span class="academic-session">{{ academic_session.name|default:'No Active Session' }}</span></p>
    </div>
  </div>

  <!-- Controls Row -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
    <a href="{% url 'faculty_staff:course_offerings' %}" class="inline-flex items-center px-4 py-2 border border-indigo-500 text-indigo-500 bg-white hover:bg-indigo-50 rounded-lg shadow-sm">
      <i class="fas fa-arrow-left mr-2"></i>
      Back to Course Offerings
    </a>
    <div class="flex flex-wrap items-center gap-4">
      <div class="flex items-center gap-2">
        <label for="session-filter" class="text-sm font-medium text-gray-700">Session:</label>
        <select id="session-filter" onchange="window.location.href='?session_id=' + this.value + '&shift=' + document.getElementById('shift-filter').value + '&include_inactive={{ include_inactive|yesno:'1,0' }}'" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for session in academic_sessions %}
            <option value="{{ session.id }}" {% if request.GET.session_id|default:'' == session.id|stringformat:'s' %}selected{% endif %}>
              {{ session.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-center gap-2">
        <label for="shift-filter" class="text-sm font-medium text-gray-700">Shift:</label>
        <select id="shift-filter" onchange="window.location.href='?session_id=' + document.getElementById('session-filter').value + '&shift=' + this.value + '&include_inactive={{ include_inactive|yesno:'1,0' }}'" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
          {% for value, label in shift_options %}
            <option value="{{ value }}" {% if shift_filter == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Timetable -->
  <div class="bg-white shadow-xl rounded-lg p-6 print-section">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">
        <i class="fas fa-calendar-week mr-2"></i>
        My Schedule
      </h2>
      <span class="text-sm font-medium bg-gray-100 px-3 py-1 rounded-full">{{ academic_session.name|default:'No Active Session' }}</span>
    </div>
    
    {% if timetable_data %}   
      <div class="space-y-4">
        {% for day in timetable_data %}
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <button class="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition duration-200" onclick="toggleDay('{{ day.day_value }}')">
              <span class="text-lg font-semibold text-gray-800">{{ day.day_label }}</span>
              <i id="toggle-icon-{{ day.day_value }}" class="fas fa-chevron-down text-gray-600"></i>
            </button>
            <div id="slots-{{ day.day_value }}" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for slot in day.slots %}
                <div class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 transform hover:scale-[1.02] 
                  {% if slot.is_replacement and slot.replacement_type == 'temporary' %}bg-gradient-to-br from-yellow-50 to-yellow-100 border-l-4 border-yellow-400
                  {% elif slot.is_replacement and slot.replacement_type == 'permanent' %}bg-gradient-to-br from-orange-50 to-orange-100 border-l-4 border-orange-400
                  {% elif slot.shift == 'Morning' %}bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-400
                  {% elif slot.shift == 'Evening' %}bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-400
                  {% else %}bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-400{% endif %}
                  hover:shadow-xl">
                  <div class="p-5">
                    <!-- Course Header -->
                    <div class="flex items-start justify-between mb-3">
                      <div>
                        <div class="flex items-center gap-2 mb-2">
                          <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full 
                            {% if slot.is_replacement and slot.replacement_type == 'temporary' %}bg-yellow-100 text-yellow-800
                            {% elif slot.is_replacement and slot.replacement_type == 'permanent' %}bg-orange-100 text-orange-800
                            {% elif slot.shift == 'Morning' %}bg-blue-100 text-blue-800
                            {% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ slot.shift }}
                            {% if slot.is_replacement %}
                              ({{ slot.replacement_type|title }} Replacement)
                            {% endif %}
                          </span>
                          {% if slot.is_replacement and slot.replacement_type == 'temporary' and slot.replacement_end_date %}
                            <span class="text-xs text-gray-500">Until: {{ slot.replacement_end_date|date:"M d, Y" }}</span>
                          {% endif %}
                        </div>
                        <h3 class="text-lg font-bold 
                          {% if slot.is_replacement and slot.replacement_type == 'temporary' %}text-yellow-900
                          {% elif slot.is_replacement and slot.replacement_type == 'permanent' %}text-orange-900
                          {% elif slot.shift == 'Morning' %}text-blue-900
                          {% elif slot.shift == 'Evening' %}text-purple-900
                          {% else %}text-green-900{% endif %} mb-1">
                          {{ slot.course_code }}
                        </h3>
                        <p class="text-sm font-medium text-gray-600">{{ slot.course_name }}</p>
                      </div>
                      <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                          {% if slot.is_replacement and slot.replacement_type == 'temporary' %}bg-yellow-100 text-yellow-800
                          {% elif slot.is_replacement and slot.replacement_type == 'permanent' %}bg-orange-100 text-orange-800
                          {% elif slot.shift == 'Morning' %}bg-blue-100 text-blue-800
                          {% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-800
                          {% else %}bg-green-100 text-green-800{% endif %}">
                          <i class="fas fa-clock mr-1"></i>{{ slot.start_time }}–{{ slot.end_time }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Teacher and Program Info -->
                    <div class="mt-4 p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                      <div class="flex items-start">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center 
                          {% if slot.is_replacement and slot.replacement_type == 'temporary' %}bg-yellow-100 text-yellow-600
                          {% elif slot.is_replacement and slot.replacement_type == 'permanent' %}bg-orange-100 text-orange-600
                          {% elif slot.shift == 'Morning' %}bg-blue-100 text-blue-600
                          {% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-600
                          {% else %}bg-green-100 text-green-600{% endif %}">
                          <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm font-medium text-gray-900">{{ slot.teacher|default:'Not Assigned' }}</p>
                          <p class="text-xs text-gray-500 flex items-center">
                            <i class="fas fa-graduation-cap mr-1"></i>{{ slot.program|default:'No Program' }}
                          </p>
                          {% if slot.is_replacement %}
                            <p class="text-xs text-gray-500 mt-1">
                              Originally taught by: {{ slot.original_teacher|default:'Unknown' }}
                            </p>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Location Info -->
                    <div class="mt-3 flex items-center text-xs text-gray-600">
                      <span class="inline-flex items-center">
                        <i class="fas fa-map-marker-alt mr-1.5"></i>
                        {{ slot.venue }}
                        <span class="mx-1">•</span>
                        Room {{ slot.room_no }}
                      </span>
                    </div>
                  </div>
                </div>
              {% empty %}
                <p class="col-span-full text-center text-gray-500">No slots scheduled for {{ day.day_label }}.</p>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center text-gray-500">No timetable slots available for the selected session.</p>
    {% endif %}
  </div>
</div>

{% block extra_js %}
<script>
function toggleDay(dayId) {
  const slots = document.getElementById(`slots-${dayId}`);
  const icon = document.getElementById(`toggle-icon-${dayId}`);
  if (slots.classList.contains('hidden')) {
    slots.classList.remove('hidden');
    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
  } else {
    slots.classList.add('hidden');
    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
  }
}

function reorderDays() {
  const daysContainer = document.querySelector('.space-y-4');
  if (!daysContainer) return;
  
  const days = Array.from(daysContainer.children);
  if (days.length === 0) return;
  
  const currentDay = new Date().getDay();
  const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const currentDayName = dayNames[currentDay];
  
  const currentDayElement = days.find(day => {
    const dayLabel = day.querySelector('.text-lg')?.textContent.toLowerCase();
    return dayLabel === currentDayName;
  });
  
  if (currentDayElement) {
    daysContainer.insertBefore(currentDayElement, daysContainer.firstChild);
    days.forEach(day => {
      const dayLabel = day.querySelector('.text-lg')?.textContent.toLowerCase();
      const slots = day.querySelector('[id^="slots-"]');
      const icon = day.querySelector('i.fa-chevron-down, i.fa-chevron-up');
      
      if (dayLabel === currentDayName) {
        if (slots) slots.classList.remove('hidden');
        if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      } else {
        if (slots) slots.classList.add('hidden');
        if (icon) icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  reorderDays();
  document.querySelectorAll('[id^="toggle-icon-"]').forEach(icon => {
    const dayId = icon.id.replace('toggle-icon-', '');
    const dayElement = document.querySelector(`[onclick="toggleDay('${dayId}')"]`);
    if (dayElement) {
      dayElement.addEventListener('click', () => toggleDay(dayId));
    }
  });
});
</script>

<style>
  [id^="slots-"] {
    transition: all 0.3s ease;
  }
  @media print {
    .no-print {
      display: none !important;
    }
    .print-section {
      padding: 0;
      box-shadow: none;
    }
    .print-container {
      max-width: 100%;
      margin: 0;
      padding: 0;
    }
    .break-after-page {
      page-break-after: always;
      break-after: page;
    }
    table {
      page-break-inside: auto;
    }
    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
    [class*='grid-cols-'] > * {
      page-break-inside: avoid;
      break-inside: avoid;
    }
  }
</style>
{% endblock %}
{% endblock %}