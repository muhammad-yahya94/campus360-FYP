{% extends 'faculty_staff/base_dashboard.html' %}
{% load static %}

{% block title %}Notice Board - Faculty Dashboard{% endblock %}

{% block extra_css %}
<style>
    .notice-table th, .notice-table td {
        vertical-align: middle;
        text-align: left;
        padding: 0.75rem 1rem;
    }
    .notice-table .high { border-left: 4px solid #ef4444; }
    .notice-table .medium { border-left: 4px solid #f59e0b; }
    .notice-table .low { border-left: 4px solid #10b981; }
    .notice-table tbody tr:hover {
        background-color: #f5f5f5; /* Matches DaisyUI's base-200 */
    }
    .notice-table th {
        position: sticky;
        top: 0;
        background-color: #fff; /* Matches DaisyUI's base-100 */
        z-index: 10;
    }
    .action-links a, .action-links button {
        margin-right: 0.5rem;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-lg shadow-md mb-6">
            <div class="text-center py-4">
                <h1 class="text-2xl sm:text-3xl font-bold">Notice Board</h1>
                <p class="text-sm sm:text-base text-white/80 mt-1">Manage Notice {{ request.user.teacher_profile.department.name }}</p>
            </div>
        </div>

    <!-- Header with Add Notice Button -->
    <div class="flex justify-end mb-6">
        <button onclick="document.getElementById('create-notice-modal').showModal()" 
                class="btn btn-primary">
            Add Notice
        </button>
    </div>

    <!-- Notices Table -->
    <div class="bg-base-100 shadow-md rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="notice-table table table-pin-rows table-sm w-full">
                <thead>
                    <tr>
                        <th class="w-1/6">Title</th>
                        <th class="w-1/8">Type</th>
                        <th class="w-1/8">Priority</th>
                        <th class="w-1/6">Sessions</th>
                        <th class="w-1/6">Programs</th>
                        <th class="w-1/6 hidden md:table-cell">Created At</th>
                        <th class="w-1/6 hidden md:table-cell">Valid Until</th>
                        <th class="w-1/6">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if notices %}
                        {% for notice in notices %}
                            <tr class="{{ notice.priority }}">
                                <td>{{ notice.title }}</td>
                                <td>{{ notice.get_notice_type_display }}</td>
                                <td>{{ notice.get_priority_display }}</td>
                                <td>
                                    {% if notice.sessions.all %}
                                        {% for session in notice.sessions.all %}
                                            <span class="badge badge-outline">{{ session.name }}</span>
                                        {% empty %}
                                            <span class="text-gray-400">All Sessions</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-gray-400">All Sessions</span>
                                    {% endif %}
                                </td>
                                <td>{{ notice.get_target_audience }}</td>
                                <td class="hidden md:table-cell">{{ notice.created_at|date:"M d, Y" }}</td>
                                <td class="hidden md:table-cell">
                                    {% if notice.valid_until %}
                                        {{ notice.valid_until|date:"M d, Y" }}
                                    {% else %}
                                        <span class="text-gray-400">No expiry</span>
                                    {% endif %}
                                </td>
                                <td class="flex items-center gap-x-2">
                                    {% if request.user.teacher_profile %}
                                        <label for="edit-modal-{{ notice.id }}" class="btn btn-sm btn-ghost">Edit</label>
                                        <form method="post" class="inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_notice" value="1">
                                            <input type="hidden" name="notice_id" value="{{ notice.id }}">
                                            <button type="submit" class="btn btn-sm btn-error"
                                                    onclick="return confirm('Are you sure you want to delete this notice?');">
                                                Delete
                                            </button>
                                        </form>
                                        <form method="post" class="inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="toggle_active" value="1">
                                            <input type="hidden" name="notice_id" value="{{ notice.id }}">
                                            <button type="submit" class="btn btn-sm {% if notice.is_active %}btn-secondary{% else %}btn-success{% endif %}">
                                                {{ notice.is_active|yesno:"Deactivate,Activate" }}
                                            </button>
                                        </form>
                                        <!-- Collapsible Edit Form -->
                                        <input type="checkbox" id="edit-modal-{{ notice.id }}" class="modal-toggle" />
                                        <div class="modal">
                                            <div class="modal-box">
                                                <h3 class="font-bold text-lg mb-4">Edit Notice</h3>
                                                <form method="post" enctype="multipart/form-data">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="edit_notice" value="1">
                                                    <input type="hidden" name="notice_id" value="{{ notice.id }}">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Title <span class="text-error">*</span></span>
                                                            </label>
                                                            <input type="text" name="title" class="input input-bordered w-full" value="{{ notice.title }}" required>
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Notice Type <span class="text-error">*</span></span>
                                                            </label>
                                                            <select name="notice_type" class="select select-bordered w-full" required>
                                                                {% for value, label in notice_types.items %}
                                                                    <option value="{{ value }}" {% if notice.notice_type == value %}selected{% endif %}>{{ label }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Priority</span>
                                                            </label>
                                                            <select name="priority" class="select select-bordered w-full">
                                                                {% for value, label in priorities.items %}
                                                                    <option value="{{ value }}" {% if notice.priority == value %}selected{% endif %}>{{ label }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Programs</span>
                                                                <span class="label-text-alt">(Leave empty for all programs)</span>
                                                            </label>
                                                            <select name="programs" multiple class="select select-bordered w-full">
                                                                {% for program in programs %}
                                                                    <option value="{{ program.id }}" {% if program in notice.programs.all %}selected{% endif %}>{{ program.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Sessions</span>
                                                                <span class="label-text-alt">(Leave empty for all sessions)</span>
                                                            </label>
                                                            <select name="sessions" multiple class="select select-bordered w-full">
                                                                {% for session in sessions %}
                                                                    <option value="{{ session.id }}" {% if session in notice.sessions.all %}selected{% endif %}>{{ session.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Valid From</span>
                                                            </label>
                                                            <input type="datetime-local" name="valid_from" class="input input-bordered w-full" 
                                                                   value="{{ notice.valid_from|date:'Y-m-d\TH:i' }}">
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Valid Until (Optional)</span>
                                                            </label>
                                                            <input type="datetime-local" name="valid_until" class="input input-bordered w-full" 
                                                                   value="{{ notice.valid_until|default_if_none:''|date:'Y-m-d\TH:i' }}">
                                                        </div>
                                                        <div class="form-control">
                                                            <label class="label">
                                                                <span class="label-text">Attachment (Optional)</span>
                                                            </label>
                                                            <input type="file" name="attachment" class="file-input file-input-bordered w-full">
                                                            {% if notice.attachment %}
                                                                <p class="text-sm mt-2">Current: <a href="{{ notice.attachment.url }}" target="_blank">{{ notice.filename }}</a></p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="form-control mt-4">
                                                        <label class="label">
                                                            <span class="label-text">Content <span class="text-error">*</span></span>
                                                        </label>
                                                        <textarea name="content" class="textarea textarea-bordered h-40" required>{{ notice.content }}</textarea>
                                                    </div>
                                                    <div class="modal-action">
                                                        <button type="button" class="btn btn-ghost" onclick="document.getElementById('edit-modal-{{ notice.id }}').checked = false;">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">
                                                            Save Changes
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    {% endif %}
                                
                            </tr>   
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-8">
                                <div class="text-gray-400 mb-4">
                                    No notices found
                                </div>
                                <p class="mt-1 text-sm text-gray-400">
                                    <button onclick="document.getElementById('create-notice-modal').showModal()" 
                                            class="text-primary hover:underline">
                                        Create a new notice
                                    </button>
                                </p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if notices.has_other_pages %}
        <div class="flex justify-center mt-8">
            <div class="join">
                {% if notices.has_previous %}
                    <a href="?page={{ notices.previous_page_number }}" class="join-item btn">«</a>
                {% endif %}
                {% for i in notices.paginator.page_range %}
                    {% if notices.number == i %}
                        <button class="join-item btn btn-active">{{ i }}</button>
                    {% else %}
                        <a href="?page={{ i }}" class="join-item btn">{{ i }}</a>
                    {% endif %}
                {% endfor %}
                {% if notices.has_next %}
                    <a href="?page={{ notices.next_page_number }}" class="join-item btn">»</a>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Create Notice Modal -->
    <dialog id="create-notice-modal" class="modal">
        <div class="modal-box max-w-3xl">
            <h3 class="font-bold text-lg mb-4">Add New Notice</h3>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="create_notice" value="1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Title <span class="text-error">*</span></span>
                        </label>
                        <input type="text" name="title" class="input input-bordered w-full" required>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Notice Type <span class="text-error">*</span></span>
                        </label>
                        <select name="notice_type" class="select select-bordered w-full" required>
                            {% for value, label in notice_types.items %}
                                <option value="{{ value }}" {% if value == 'general' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Priority</span>
                        </label>
                        <select name="priority" class="select select-bordered w-full">
                            {% for value, label in priorities.items %}
                                <option value="{{ value }}" {% if value == 'medium' %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Programs</span>
                            <span class="label-text-alt">(Leave empty for all programs)</span>
                        </label>
                        <select name="programs" multiple class="select select-bordered w-full">
                            {% for program in programs %}
                                <option value="{{ program.id }}">{{ program.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Sessions</span>
                            <span class="label-text-alt">(Leave empty for all sessions)</span>
                        </label>
                        <select name="sessions" multiple class="select select-bordered w-full">
                            {% for session in sessions %}
                                <option value="{{ session.id }}">{{ session.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Valid From</span>
                        </label>
                        <input type="datetime-local" name="valid_from" class="input input-bordered w-full" 
                               value="{{ timezone.now|date:'Y-m-d\TH:i' }}">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Valid Until (Optional)</span>
                        </label>
                        <input type="datetime-local" name="valid_until" class="input input-bordered w-full">
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Attachment (Optional)</span>
                        </label>
                        <input type="file" name="attachment" class="file-input file-input-bordered w-full">
                        <label class="label">
                            <span class="label-text-alt">Allowed: PDF, DOC, DOCX, JPG, JPEG, PNG (Max 5MB)</span>
                        </label>
                    </div>
                </div>
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text">Content <span class="text-error">*</span></span>
                    </label>
                    <textarea name="content" class="textarea textarea-bordered h-40" placeholder="Enter notice content..." required></textarea>
                </div>
                <div class="modal-action">
                    <button type="button" onclick="document.getElementById('create-notice-modal').close()" class="btn btn-ghost">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Publish Notice
                    </button>
                </div>
            </form>   
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</div>
{% endblock %}