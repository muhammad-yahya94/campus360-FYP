{% extends 'faculty_staff/base_dashboard.html' %}
{% load static %}

{% block title %}Session Students{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

{% endblock %}

{% block content %}
<style>
    .selecter_form{
            border: 2px solid #000;
            padding: 10px;
    }
</style>
<div class="">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Header -->
        <div class="hero bg-primary text-primary-content rounded-lg shadow-lg mb-6">
            <div class="hero-content text-center py-6">
                <div class="max-w-md">
                    <h1 class="text-3xl sm:text-4xl font-bold mb-2">Session Students</h1>
                    <p class="text-base sm:text-lg text-primary-content/90">View and manage students by academic session</p>
                </div>
            </div>
        </div>

        <!-- Session Selector -->
        <div class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-xl text-base-content mb-4">
                    <i class="fas fa-calendar-alt mr-2"></i>
                    Select Academic Session
                </h2>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <div class="form-control   selecter_form">
                            <select id="session-selector" class="select select-bordered w-full " style="width: 70% !important">
                                <option value="">Select a session...</option>
                                {% for session in academic_sessions %}
                                    <option value="{{ session.id }}" {% if session.id == session.id %}selected{% endif %}>
                                        {{ session.name }} ({{ session.start_year }} - {{ session.end_year }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <div class="form-control">
                            <select id="program-selector" class="select select-bordered w-full">
                                <option value="all">All Programs</option>
                                {% for program in programs %}
                                    <option value="{{ program.id }}" {% if forloop.first %}selected{% endif %}>{{ program.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% comment %} <!-- Session and Program Filters -->
        <div id="filter-container" class="card bg-base-100 shadow-lg mb-6">
            <div class="card-body">
                <h2 class="card-title text-xl text-base-content mb-4">
                    <i class="fas fa-filter mr-2"></i>
                    Filter Students
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Session</span>
                        </label>
                        <select id="session-selector" class="select select-bordered w-full">
                            {% for session in academic_sessions %}
                                <option value="{{ session.id }}" {% if session.id == session.id %}selected{% endif %}>
                                    {{ session.name }} ({{ session.start_year }}-{{ session.end_year }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Program</span>
                        </label>
                        <select id="program-selector" class="select select-bordered w-full">
                            <option value="all">All Programs</option>
                            {% for program in programs %}
                                <option value="{{ program.id }}" {% if forloop.first %}selected{% endif %}>{{ program.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div> {% endcomment %}

        <!-- Students Container -->
        <div id="students-container" class="space-y-6">



            {% if students_by_program %}
                {% include 'faculty_staff/includes/student_list.html' %}
            {% else %}
                <div class="alert alert-info shadow-lg">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Please select an academic session to view students.</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2
        $('#session-selector').select2({
            placeholder: 'Select a session...',
            allowClear: true,
            width: '100%'
        });

        // Handle session selection change
        $('#session-selector').on('change', function() {
            const sessionId = $(this).val();
            
            if (sessionId) {
                $('#program-filter').removeClass('hidden');
                loadStudents(sessionId);
            } else {
                $('#students-container').html(`
                    <div class="alert alert-info shadow-lg">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Please select an academic session to view students.</span>
                        </div>
                    </div>
                `);
                $('#program-filter').addClass('hidden');
            }
        });

        // Initialize session and program selection on page load
        $(document).ready(function() {
            const sessionId = $('#session-selector').val();
            if (sessionId) {
                // Load students with first program selected
                const firstProgram = $('#program-selector option[value!="all"]:first').val();
                if (firstProgram) {
                    $('#program-selector').val(firstProgram);
                    loadStudents(sessionId);
                }
            }
            
            // Initialize Select2 only for session selector
            $('#session-selector').select2({
                width: '100%',
                theme: 'bootstrap-5',
                placeholder: 'Select Session'
            });
        });

        // Handle program selection change
        $('#program-selector').on('change', function() {
            const sessionId = $('#session-selector').val();
            if (sessionId) {
                loadStudents(sessionId);
            }
        });
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        };

        // Handle search input
        let searchTimeout;
        $('#search-input').on('input', function() {
            clearTimeout(searchTimeout);
            const sessionId = $('#session-selector').val();
            const programId = $('#program-selector').val();
            const searchQuery = $(this).val();
            
            if (sessionId) {
                searchTimeout = setTimeout(() => {
                    $.ajax({
                        url: `/faculty/students/${sessionId}/`,
                        type: 'GET',
                        data: {
                            program_id: programId,
                            search: searchQuery,
                            session_id: sessionId
                        },
                        success: function(response) {
                            if (response.html) {
                                $('#students-container').html(response.html);
                            }
                        }
                    });
                }, 300);
            }
        });

        // Function to load students via AJAX
        function loadStudents(sessionId) {
            const programId = $('#program-selector').val();
            // Use the correct URL pattern that matches our URL configuration
            const url = `/faculty/students/${sessionId}/`;
            
            console.log('AJAX Request:', {
                url: url,
                program_id: programId,
                session_id: sessionId
            });
            
            // Show loading state
            $('#students-container').html(`
                <div class="flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
                    <span class="ml-4">Loading students...</span>
                </div>
            `);
            
            $.ajax({
                url: url,
                type: 'GET',
                data: {
                    program_id: programId,
                    session_id: sessionId  // Make sure session_id is included in the request
                },
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                beforeSend: function() {
                    $('#students-container').html(`
                        <div class="flex justify-center items-center py-8">
                            <span class="loading loading-spinner loading-lg"></span>
                        </div>
                    `);
                },
                success: function(response) {
                    console.log('AJAX Response:', response);
                    
                    if (response.html) {
                        console.log('HTML Content:', response.html);
                        $('#students-container').html(response.html);
                        
                        // Check if there are any table rows with student data
                        const $studentRows = $('#students-container').find('tbody tr');
                        console.log('Number of student rows:', $studentRows.length);
                        
                        // If no student rows found
                        if ($studentRows.length === 0) {
                            console.log('No student data rows found in the response');
                            const noStudentsHtml = `
                                <div class="alert alert-info shadow-lg">
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div>
                                            <p>No students found for the selected criteria.</p>
                                            <p class="text-sm opacity-75 mt-1">Please try different filters.</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#students-container').html(noStudentsHtml);
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', {
                        status: status,
                        error: error,
                        response: xhr.responseText,
                        statusCode: xhr.status
                    });
                    
                    let errorMessage = 'An error occurred while loading students.';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    } else if (xhr.status === 0) {
                        errorMessage = 'Network error. Please check your connection.';
                    } else if (xhr.status === 404) {
                        errorMessage = 'The requested resource was not found.';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'Server error. Please try again later.';
                    }
                    
                    const errorHtml = `
                        <div class="alert alert-error shadow-lg">
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <div>
                                    <p>${errorMessage}</p>
                                    <p class="text-sm opacity-75 mt-1">Status: ${xhr.status} ${status}</p>
                                    <p class="text-xs opacity-50 mt-1">Check browser console for details</p>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#students-container').html(errorHtml);
                }
            });
        }

        // If a session is pre-selected (from URL), trigger the change event
        if ($('#session-selector').val()) {
            $('#session-selector').trigger('change');
        }
    });
</script>
{% endblock %}