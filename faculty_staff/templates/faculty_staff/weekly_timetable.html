{% extends 'faculty_staff/base_dashboard.html' %}
{% load timetable_filters %}
{% block title %}Weekly Timetable - {{ department.name }}{% endblock %}

{% block extra_css %}
<style>
  @media print {
    body * { visibility: hidden; }
    .print-section, .print-section * { visibility: visible; }
    .print-section { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
    .no-print { display: none !important; }
    @page { size: A4 landscape; margin: 0.5cm; }
    .timetable-day { page-break-inside: avoid; margin-bottom: 20px; }
    .timetable-slot { page-break-inside: avoid; }
  }
  .group:hover .group-hover\:block { display: block !important; }
</style>  
{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Header -->
  <div class="bg-gradient-to-r from-indigo-600 to-teal-600 text-white rounded-xl shadow-lg mb-6">
    <div class="text-center py-8">
      <h1 class="text-4xl font-bold mb-2">Weekly Timetable</h1>
      <p class="text-lg opacity-90">{{ department.name }} - <span class="academic-session">{{ academic_session.name|default:'No Active Session' }}</span></p>
    </div>
  </div>

  <!-- Controls -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
    <a href="{% url 'faculty_staff:course_offerings' %}" class="inline-flex items-center px-4 py-2 border border-indigo-500 text-indigo-500 bg-white hover:bg-indigo-50 rounded-lg shadow-sm">
      <i class="fas fa-arrow-left mr-2"></i>Back to Course Offerings
    </a>
    <div class="flex items-center gap-4">
      <label for="session-filter" class="text-sm font-medium text-gray-700">Select Session:</label>
      <select id="session-filter" onchange="window.location.href='?session_id=' + this.value + '&shift=' + document.getElementById('shift-filter').value" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
        {% for session in academic_sessions %}
          <option value="{{ session.id }}" {% if request.GET.session_id|default:'' == session.id|stringformat:"s" %}selected{% endif %}>
            {{ session.name }}
          </option>
        {% endfor %}
      </select>
      <label for="shift-filter" class="text-sm font-medium text-gray-700">Filter by Shift:</label>
      <select id="shift-filter" onchange="window.location.href='?session_id=' + document.getElementById('session-filter').value + '&shift=' + this.value" class="border border-gray-300 rounded-lg p-2 focus:ring-indigo-500 focus:border-indigo-500">
        {% for value, label in shift_options %}
          <option value="{{ value }}" {% if shift_filter == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Timetable -->
  <div class="bg-white shadow-xl rounded-lg p-6 print-section">
    <h2 class="text-2xl font-semibold mb-4">
      <i class="fas fa-calendar-week mr-2"></i>Timetable Overview
    </h2>
    {% if timetable_data %}
      <div class="space-y-4">
        {% for day in timetable_data %}
          <div class="border border-gray-200 rounded-lg timetable-day">
            <button class="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition duration-200" onclick="toggleDay('{{ day.day_value }}')">
              <span class="text-lg font-semibold text-gray-800">{{ day.day_label }}</span>
              <i id="toggle-icon-{{ day.day_value }}" class="fas fa-chevron-down text-gray-600"></i>
            </button>
            <div id="slots-{{ day.day_value }}" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {% for slot in day.slots %}
                {% with replacements=slot.course_offering_id|lookup_replacements %}
                <div 
                  class="relative overflow-hidden rounded-xl shadow-lg transition-all duration-300 transform hover:scale-[1.02] timetable-slot {% if slot.shift == 'Morning' %}bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-400{% elif slot.shift == 'Evening' %}bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-400{% else %}bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-400{% endif %} hover:shadow-xl" 
                  data-tooltip="Teacher: {{ slot.teacher|addslashes }}<br>Program: {{ slot.program|addslashes }}{% if replacements %}<br>Replacements: {% for r in replacements %}{{ r.replacement_teacher|addslashes }} ({{ r.replacement_type|capfirst }} {% if r.replacement_date %}on {{ r.replacement_date }}{% endif %}, Original: {{ r.original_teacher|addslashes }}){% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}"
                  data-teacher="{{ slot.teacher|addslashes }}"
                  data-course-code="{{ slot.course_code|addslashes }}"
                  data-course-name="{{ slot.course_name|addslashes }}"
                  data-program="{{ slot.program|addslashes }}"
                >
                  <div class="p-5">
                    <!-- Course Header -->
                    <div class="flex items-start justify-between mb-3">
                      <div>
                        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full {% if slot.shift == 'Morning' %}bg-blue-100 text-blue-800{% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-800{% else %}bg-green-100 text-green-800{% endif %} mb-2">
                          {{ slot.shift }}
                        </span>
                        <h3 class="text-lg font-bold {% if slot.shift == 'Morning' %}text-blue-900{% elif slot.shift == 'Evening' %}text-purple-900{% else %}text-green-900{% endif %} mb-1">
                          {{ slot.course_code }}
                        </h3>
                        <p class="text-sm font-medium text-gray-600">{{ slot.course_name }}</p>
                      </div>
                      <div class="text-right">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if slot.shift == 'Morning' %}bg-blue-100 text-blue-800{% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-800{% else %}bg-green-100 text-green-800{% endif %}">
                          <i class="fas fa-clock mr-1"></i>{{ slot.start_time }}–{{ slot.end_time }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Teacher and Program Info -->
                    <div class="mt-4 p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                      <div class="flex items-start">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center {% if slot.shift == 'Morning' %}bg-blue-100 text-blue-600{% elif slot.shift == 'Evening' %}bg-purple-100 text-purple-600{% else %}bg-green-100 text-green-600{% endif %}">
                          <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm font-medium text-gray-900">{{ slot.teacher|default:'Not Assigned' }}</p>
                          <p class="text-xs text-gray-500 flex items-center">
                            <i class="fas fa-graduation-cap mr-1"></i>{{ slot.program|default:'No Program' }}
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Location and Additional Info -->
                    <div class="mt-3 flex items-center justify-between text-xs text-gray-600">
                      <span class="inline-flex items-center">
                        <i class="fas fa-map-marker-alt mr-1.5"></i>
                        {{ slot.venue }}
                        <span class="mx-1">•</span>
                        Room {{ slot.room_no }}
                      </span>
                    </div>
                    <!-- Display Existing Replacements -->
                    {% if replacements %}
                      <div class="mt-2 text-xs text-gray-600 replacement-info">
                        <p><strong>Replacements:</strong></p>
                        <ul class="list-disc ml-4">
                          {% for r in replacements %}
                            <li>
                              {{ r.replacement_teacher }} ({{ r.replacement_type|capfirst }}
                              {% if r.replacement_date %}on {{ r.replacement_date }}{% endif %},
                              Original: {{ r.original_teacher }}
                              {% if r.is_active %} - Active{% endif %})
                            </li>
                          {% endfor %}
                        </ul>
                      </div>
                    {% endif %}
                  </div>
                </div>
                {% endwith %}
              {% empty %}
                <p class="col-span-full text-center text-gray-500">No slots scheduled for {{ day.day_label }}.</p>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center p-8">
        <i class="fas fa-calendar-alt text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Timetable Slots Scheduled</h3>
        <p class="text-gray-500">Schedule timetable slots for courses in this department.</p>
      </div>
    {% endif %}
  </div>

  <!-- Replacement Modal -->
  <div id="replacementModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-900">Create Lecture Replacement</h2>
        <button onclick="closeReplacementModal()" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">×</button>
      </div>
      <form method="post" action="{% url 'faculty_staff:lecture_replacement_create' %}">
        {% csrf_token %}
        <input type="hidden" name="course_offering" id="modal_course_offering">
        <input type="hidden" name="original_teacher" id="modal_original_teacher">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Course</label>
          <p id="modal_course_code" class="text-sm text-gray-600"></p>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Original Teacher</label>
          <p id="modal_teacher_name" class="text-sm text-gray-600"></p>
        </div>
        <div class="mb-4">
          <label for="replacement_teacher" class="block text-sm font-medium text-gray-700">Replacement Teacher</label>
          <select name="replacement_teacher" id="replacement_teacher" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" required>
            <option value="">Select a teacher</option>
            {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.user.first_name }} {{ teacher.user.last_name }} ({{ teacher.designation }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-4">
          <label for="replacement_type" class="block text-sm font-medium text-gray-700">Replacement Type</label>
          <select name="replacement_type" id="replacement_type" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="toggleReplacementDate()" required>
            <option value="temporary">Temporary</option>
            <option value="permanent">Permanent</option>
          </select>
        </div>
        <div class="mb-4 hidden" id="replacement_date_container">
          <label for="replacement_date" class="block text-sm font-medium text-gray-700">Replacement Date</label>
          <input type="date" name="replacement_date" id="replacement_date" class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div class="flex justify-end gap-4">
          <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" onclick="closeReplacementModal()">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save Replacement</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Programs Section -->
  <div class="bg-white shadow-xl rounded-lg p-6 mt-6">
    <h2 class="text-2xl font-semibold mb-4">
      <i class="fas fa-list mr-2"></i>Programs Running in {{ academic_session.name|default:'No Active Session' }}
    </h2>
    {% if programs %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for program in programs %}
          <div class="p-4 bg-gray-50 rounded-lg shadow-md hover:shadow-lg transition duration-200">
            <p class="text-lg font-semibold text-gray-800">{{ program.course_offering__program__name }}</p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center p-8">
        <i class="fas fa-info-circle text-6xl text-gray-300 mb-4"></i>
        <p class="text-gray-500">No programs are currently running in this session.</p>
      </div>
    {% endif %}
  </div>

  <!-- JavaScript -->
  <script>
    console.log('Timetable script loaded');
    function sanitize(str) {
      return String(str || '').replace(/['"\\]/g, '\\$&').replace(/</g, '<').replace(/>/g, '>');
    }
    function toggleDay(dayId) {
      console.log('toggleDay called with:', dayId);
      const slots = document.getElementById(`slots-${dayId}`);
      const icon = document.getElementById(`toggle-icon-${dayId}`);
      if (!slots || !icon) {
        console.error(`Element not found: slots-${dayId} or toggle-icon-${dayId}`);
        return;
      }
      if (slots.classList.contains('hidden')) {
        slots.classList.remove('hidden');
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      } else {
        slots.classList.add('hidden');
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      }
    }
    function openReplacementModal(courseOfferingId, teacherId, courseCode, teacherName) {
      console.log('openReplacementModal called with:', { courseOfferingId, teacherId, courseCode, teacherName });
      const modal = document.getElementById('replacementModal');
      const courseInput = document.getElementById('modal_course_offering');
      const teacherInput = document.getElementById('modal_original_teacher');
      const courseCodeEl = document.getElementById('modal_course_code');
      const teacherNameEl = document.getElementById('modal_teacher_name');
      if (!modal || !courseInput || !teacherInput || !courseCodeEl || !teacherNameEl) {
        console.error('Modal or form elements not found');
        return;
      }
      courseInput.value = sanitize(courseOfferingId) || '';
      teacherInput.value = sanitize(teacherId) || '';
      courseCodeEl.textContent = sanitize(courseCode) || 'N/A';
      teacherNameEl.textContent = sanitize(teacherName) || 'N/A';
      console.log('Setting modal to visible');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      toggleReplacementDate();
    }
    function closeReplacementModal() {
      console.log('closeReplacementModal called');
      const modal = document.getElementById('replacementModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        console.log('Modal closed');
      }
      const replacementTeacher = document.getElementById('replacement_teacher');
      const replacementType = document.getElementById('replacement_type');
      const replacementDate = document.getElementById('replacement_date');
      if (replacementTeacher) replacementTeacher.value = '';
      if (replacementType) replacementType.value = 'temporary';
      if (replacementDate) replacementDate.value = '';
    }
    function toggleReplacementDate() {
      console.log('toggleReplacementDate called');
      const replacementType = document.getElementById('replacement_type');
      const dateContainer = document.getElementById('replacement_date_container');
      const replacementDate = document.getElementById('replacement_date');
      if (!replacementType || !dateContainer || !replacementDate) {
        console.error('Replacement type or date elements not found');
        return;
      }
      if (replacementType.value === 'temporary') {
        dateContainer.classList.remove('hidden');
        replacementDate.required = true;
      } else {
        dateContainer.classList.add('hidden');
        replacementDate.required = false;
        replacementDate.value = '';
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded fired');
      document.querySelectorAll('[id^="slots-"]').forEach(el => {
        if (el) el.classList.remove('hidden');
      });
      document.querySelectorAll('[data-tooltip]').forEach(el => {
        const tooltip = document.createElement('div');
        tooltip.innerHTML = sanitize(el.dataset.tooltip);
        tooltip.className = 'absolute hidden group-hover:block bg-gray-800 text-white text-xs rounded p-2 -top-10 left-1/2 transform -translate-x-1/2 z-10';
        el.classList.add('group', 'relative');
        el.appendChild(tooltip);
      });
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('replacementModal');
        if (event.target === modal) {
          closeReplacementModal();
        }
      });
    });
  </script>
</div>
{% endblock %}