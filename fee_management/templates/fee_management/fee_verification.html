{% extends 'fee_management/office_base.html' %}
{% block title %}Fee Verification{% endblock %}
{% block content %}
<div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
  <div class="hero-content text-center">
    <div class="max-w-md">
      <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Fee Verification</h1>
      <p class="text-base sm:text-lg text-base-content/90">Verify and record fee payments using voucher ID.</p>
    </div>
  </div>
</div>

<div class="max-w-4xl mx-auto bg-base-100 rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Search Voucher</h2>
    <form id="voucher-search-form" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="search">
        <div class="form-control">
            <div class="join w-full">
                <input type="text" name="voucher_id" id="voucher-id" placeholder="Enter Voucher ID" 
                       class="input input-bordered join-item w-full" 
                       value="{{ voucher.voucher_id|default:'' }}"
                       required>
                <button type="submit" class="btn btn-primary join-item">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </form>
</div>

<div id="voucher-details" class="max-w-4xl mx-auto bg-base-100 rounded-lg shadow p-6 mb-6 hidden">
    <h2 class="text-xl font-semibold mb-4">Voucher Details</h2>
    <div id="voucher-content"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('voucher-search-form');
    const voucherDetails = document.getElementById('voucher-details');
    const voucherContent = document.getElementById('voucher-content');

    // Handle form submission for voucher search
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const voucherId = formData.get('voucher_id');

        fetch('{% url "fee_management:fee_verification" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast(data.error, 'error');
                voucherDetails.classList.add('hidden');
            } else {
                voucherContent.innerHTML = data.html;
                voucherDetails.classList.remove('hidden');
                bindVerifyButton();
            }
        })
        .catch(error => {
            showToast('An error occurred. Please try again.', 'error');
            console.error('Error:', error);
        });
    });

    // Function to bind click event to verify buttons
    function bindVerifyButton() {
        const verifyButtons = document.querySelectorAll('.verify-payment');
        verifyButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const voucherId = this.dataset.voucherId;
                const formData = new FormData();
                formData.append('action', 'verify');
                formData.append('voucher_id', voucherId);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                fetch('{% url "fee_management:fee_verification" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, 'error');
                    } else {
                        voucherContent.innerHTML = data.html;
                        showToast(data.message, 'success');
                        bindVerifyButton(); // Rebind buttons for any new content
                    }
                })
                .catch(error => {
                    showToast('An error occurred while verifying payment.', 'error');
                    console.error('Error:', error);
                });
            });
        });
    }

    // Toast notification function
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast toast-top toast-end`;
        toast.innerHTML = `
            <div class="alert alert-${type === 'success' ? 'success' : 'error'}">
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
});
</script>
{% endblock %}