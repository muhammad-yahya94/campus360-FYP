{% extends 'fee_management/office_base.html' %}
{% block title %}Generate Fee Voucher{% endblock %}
{% block content %}
<style>
  @page {
    size: A4 landscape;
    margin: 10mm;
    orphans: 0;
    widows: 0;
  }

  dialog {
    width: 95%;
    max-width: 1200px;
    border: 2px solid #000;
    background: #fff;
    padding: 0;
    margin: auto;
    overflow: hidden;
    box-sizing: border-box;
  }

  @media print {
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    dialog {
      border: none;
      width: 297mm;
      height: 187mm;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      display: block;
      page-break-before: auto;
      page-break-after: auto;
      page-break-inside: avoid;
    }

    .modal-box {
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
      border: none;
      background: #fff;
    }

    .voucher-container {
      display: flex !important;
      flex-direction: row !important;
      justify-content: space-between !important;
      width: 100% !important;
      height: 100% !important;
      gap: 3mm !important;
      margin: 0 !important;
      padding: 5mm !important;
      box-sizing: border-box;
      page-break-inside: avoid !important;
      break-inside: avoid !important;
      transform: scale(0.95);
      transform-origin: top left;
    }

    .voucher-copy {
      page-break-inside: avoid !important;
      break-inside: avoid !important;
      height: 100% !important;
      width: 32% !important;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 3mm !important;
      border: 1px solid #000 !important;
      background: #fff !important;
      font-size: 0.75em !important;
      overflow: hidden !important;
      box-sizing: border-box;
    }

    .office-details {
      display: block !important;
      visibility: visible !important;
      font-size: 0.65em !important;
      margin-top: 5px !important;
      padding-top: 3px !important;
      border-top: 1px dashed #000;
    }

    .modal-actions {
      display: none !important;
    }

    .font-bold.text-lg.mb-4 {
      display: none !important;
    }

    table {
      font-size: 0.75em !important;
      line-height: 1.2 !important;
    }

    th, td {
      padding: 2px !important;
    }
  }

  .voucher-container {
    display: flex;
    justify-content: space-between;
    gap: 5mm;
    height: 187mm;
    padding: 10px;
    box-sizing: border-box;
  }

  .voucher-copy {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    padding: 10px;
    border: 1px solid #000;
    position: relative;
    page-break-inside: avoid;
    box-sizing: border-box;
  }

  .office-details {
    margin-top: 10px;
    padding-top: 5px;
    border-top: 1px dashed #000;
    font-size: 0.75em;
    position: relative;
    bottom: 0;
    width: 100%;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85em;
    line-height: 1.4;
  }

  th, td {
    padding: 4px;
    border: 1px solid #000;
    text-align: left;
  }

  th {
    font-weight: bold;
  }

  .modal-box {
    display: flex;
    flex-direction: column;
    max-height: 90vh; /* Limit modal height to viewport */
  }

  .modal-content {
    flex: 1 1 auto;
    overflow-y: auto; /* Scrollable content area */
    padding: 20px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 10px;
    border-top: 1px solid #000;
    background: #f9f9f9;
    flex-shrink: 0; /* Prevent buttons from shrinking */
  }

  .modal-actions button {
    padding: 8px 16px;
    border: 1px solid #000;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .modal-actions button:hover {
    background: #e0e0e0;
  }

  .modal-actions .btn-primary {
    background: #2563eb;
    color: #fff;
    border: none;
  }

  .modal-actions .btn-primary:hover {
    background: #1e40af;
  }
</style>

<!-- Hero Section -->
<div class="mb-6">
  <div id="hero-section" class="hero bg-base-200 rounded-lg shadow-lg py-8 section-content">
    <div class="hero-content text-center">
      <div class="max-w-md">
        <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Fee Voucher Generator</h1>
        <p class="text-base sm:text-lg text-base-content/90">Enter a student's university roll number and semester to generate a fee voucher.</p>
      </div>
    </div>
  </div>
</div>

<!-- Voucher Form Section -->
<div class="mb-6">
  <div class="flex justify-between items-center mb-2">
    <h2 class="text-xl font-semibold text-base-content">Enter Voucher Details</h2>
  </div>
  <div id="voucher-form-section" class="max-w-full mx-auto bg-base-100 rounded-xl shadow-xl p-8 mb-8 section-content">
    <form id="voucher-form" method="post" class="space-y-6">
      {% csrf_token %}
      {% if errors %}
      <div class="bg-error/10 border border-error rounded-lg p-4 text-error">
        {% for error in errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <label class="block mb-2 font-semibold text-base-content" for="university_roll_no">University Roll Number</label>
          <div class="flex gap-2">
            <input type="number" id="university_roll_no" name="university_roll_no" class="input input-bordered w-full rounded-lg" min="0" required>
            <button type="button" id="search-btn" class="btn btn-primary rounded-lg">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Search
            </button>
          </div>
        </div>
        <div>
          <label class="block mb-2 font-semibold text-base-content" for="semester">Semester</label>
          <select id="semester" name="semester" class="select select-bordered w-full rounded-lg" required>
            <option value="">Select Semester</option>
          </select>
        </div>
      </div>
      
      <!-- Student Information -->
      <div id="student-info" class="hidden"></div>
      
      <button type="submit" class="btn btn-primary w-full rounded-lg mt-4" id="generate-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 29" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Generate Voucher
      </button>
    </form>
  </div>
</div>

<!-- Voucher Modal -->
<dialog id="voucherModal" class="modal">
  <div class="modal-box w-11/12 max-w-6xl">
    <h3 class="font-bold text-lg mb-4">Your Fee Voucher</h3>
    <div class="modal-content">
      <div id="voucherContent" class="w-full">
        <!-- Voucher content will be loaded here -->
      </div>
    </div>
    <div class="modal-actions">
      <button onclick="initiatePrint()" class="btn btn-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Print Voucher
      </button>
      <form method="dialog">
        <button class="btn">Cancel</button>
      </form>
    </div>
  </div>
</dialog>

<script>
function setLoading(isLoading) {
  const searchBtn = document.getElementById('search-btn');
  if (!searchBtn) return;
  
  if (isLoading) {
    searchBtn.disabled = true;
    searchBtn.innerHTML = `
      <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Searching...
    `;
  } else {
    searchBtn.disabled = false;
    searchBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      Search
    `;
  }
}

function initiatePrint() {
  if (window.isPrinting) return;
  
  window.isPrinting = true;
  const modal = document.getElementById('voucherModal');
  const voucherContent = document.getElementById('voucherContent');
  
  // Create a temporary print container
  const printContainer = document.createElement('div');
  printContainer.id = 'printContainer';
  printContainer.style.position = 'absolute';
  printContainer.style.top = '0';
  printContainer.style.left = '0';
  printContainer.style.width = '100%';
  printContainer.style.height = '100%';
  printContainer.style.background = '#fff';
  printContainer.style.zIndex = '10000';
  printContainer.innerHTML = voucherContent.innerHTML;
  document.body.appendChild(printContainer);
  
  // Ensure modal is hidden during print
  modal.style.display = 'none';
  
  // Trigger print
  window.print();
  
  // Handle print cleanup
  window.onafterprint = () => {
    // Remove print container
    if (document.getElementById('printContainer')) {
      document.body.removeChild(printContainer);
    }
    // Ensure modal is closed
    modal.close();
    modal.style.display = '';
    window.isPrinting = false;
    window.onafterprint = null;
  };

  // Fallback for browsers that don't support onafterprint
  setTimeout(() => {
    if (document.getElementById('printContainer')) {
      document.body.removeChild(printContainer);
    }
    modal.close();
    modal.style.display = '';
    window.isPrinting = false;
  }, 1000);
}

async function fetchSemesters() {
  const rollNo = document.getElementById('university_roll_no').value.trim();
  const semesterSelect = document.getElementById('semester');
  const studentInfo = document.getElementById('student-info');
  
  if (!rollNo) {
    alert('Please enter a roll number');
    return;
  }

  try {
    setLoading(true);
    semesterSelect.innerHTML = '<option value="">Loading semesters...</option>';
    
    const response = await fetch(`/fees/get_semesters_by_roll/?roll_no=${rollNo}`);
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    if (data.student) {
      studentInfo.innerHTML = `
        <div class="bg-base-200 p-4 rounded-lg mb-4">
          <h3 class="font-semibold">Student Information</h3>
          <p>Name: ${data.student.name}</p>
          <p>Roll No: ${data.student.roll_no || 'N/A'}</p>
          <p>Program: ${data.student.program}</p>
          <p>Session: ${data.student.session}</p>
        </div>
      `;
      studentInfo.classList.remove('hidden');
    }
    
    if (data.available_semesters && data.available_semesters.length > 0) {
      semesterSelect.innerHTML = '<option value="">Select Semester</option>';
      
      data.available_semesters.forEach(semester => {
        const option = document.createElement('option');
        option.value = semester.id;
        option.textContent = `${semester.name} - ${semester.program_name} (${semester.session})`;
        semesterSelect.appendChild(option);
      });
    } else {
      semesterSelect.innerHTML = '<option value="">No semesters available</option>';
    }
  } catch (error) {
    console.error('Error:', error);
    alert(error.message || 'An error occurred while fetching data');
    semesterSelect.innerHTML = '<option value="">Error loading semesters</option>';
    document.getElementById('student-info').classList.add('hidden');
  } finally {
    setLoading(false);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('voucher-form');
  const modal = document.getElementById('voucherModal');
  const voucherContent = document.getElementById('voucherContent');
  window.isPrinting = false;

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(form);
    const generateBtn = document.getElementById('generate-btn');
    
    generateBtn.disabled = true;
    generateBtn.innerHTML = `
      <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Generating...
    `;
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      const data = await response.json();
      
      if (data.errors) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'bg-error/10 border border-error rounded-lg p-4 text-error';
        errorDiv.innerHTML = data.errors.map(error => `<p>${error}</p>`).join('');
        form.querySelector('.bg-error')?.remove();
        form.prepend(errorDiv);
        return;
      }
      
      voucherContent.innerHTML = data.voucher_html;
      modal.showModal();
      
    } catch (error) {
      console.error('Error:', error);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'bg-error/10 border border-error rounded-lg p-4 text-error';
      errorDiv.innerHTML = '<p>An error occurred while generating the voucher.</p>';
      form.querySelector('.bg-error')?.remove();
      form.prepend(errorDiv);
    } finally {
      generateBtn.disabled = false;
      generateBtn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Generate Voucher
      `;
    }
  });
  
  const searchBtn = document.getElementById('search-btn');
  if (searchBtn) {
    searchBtn.addEventListener('click', fetchSemesters);
  }
  
  const rollNoInput = document.getElementById('university_roll_no');
  if (rollNoInput) {
    rollNoInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        fetchSemesters();
      }
    });
  }
});
</script>
{% endblock %}