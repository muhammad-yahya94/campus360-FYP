{% extends 'fee_management/office_base.html' %}

{% block title %}Manual Course Enrollment{% endblock %}

{% block content %}
<div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
    <div class="hero-content text-center">
        <div class="max-w-md">
            <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Repeat Courses Enrollment</h1>    
            <p class="text-base sm:text-lg text-base-content/90">Select Student and enroll in courses</p>
        </div>
    </div>
</div>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <!-- Step 1: Student Roll Number Input -->
        <form method="POST" class="space-y-6" id="student-lookup-form">
            {% csrf_token %}
            <input type="hidden" name="step" value="lookup">
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Enter University Roll Number</span>
                </label>
                <div class="flex gap-2">
                    <input type="number" name="university_roll_no" class="input input-bordered w-full" placeholder="Enter student's university roll number" min="1" required>
                    <button type="submit" class="btn btn-primary">Find Student</button>
                </div>
            </div>
        </form>

        <!-- Step 2: Display Student Details and Enrollment Form -->
        {% if student %}
        <div class="mt-6">
            <h2 class="text-xl font-semibold mb-4">Student Details</h2>
            <div class="bg-base-200 p-4 rounded-lg">
                <p><strong>Name:</strong> {{ student.applicant.full_name }}</p>
                <p><strong>University Roll No:</strong> {{ student.university_roll_no }}</p>
                <p><strong>Registration No:</strong> {{ student.Registration_number|default:"Not set" }}</p>
                <p><strong>Program:</strong> {{ student.program }}</p>
                <p><strong>Current Status:</strong> {{ student.get_current_status_display }}</p>
                <p><strong>Enrollment Date:</strong> {{ student.enrollment_date }}</p>
                {% if student.graduation_date %}
                <p><strong>Graduation Date:</strong> {{ student.graduation_date }}</p>
                {% endif %}
            </div>

            <form method="POST" class="space-y-6 mt-6" id="enrollment-form">
                {% csrf_token %}
                <input type="hidden" name="step" value="enroll">
                <input type="hidden" name="student_id" value="{{ student.pk }}">

                <!-- Semester Selection (Hidden) -->
                <input type="hidden" name="semester" id="semester-input" required>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Selected Semester</span>
                    </label>
                    <div class="p-2 border rounded-lg bg-base-200">
                        <span id="selected-semester-display">Select courses to automatically detect semester</span>
                    </div>
                </div>

                <!-- Course Search -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Search Courses</span>
                    </label>
                    <input type="text" id="course-search" class="input input-bordered w-full" placeholder="Search by course name or code">
                </div>

                <!-- Course Selection -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Select Courses</span>
                    </label>
                    <div class="max-h-64 overflow-y-auto border rounded-lg p-2" id="course-container">
                        {% for item in course_data %}
                        {% with course=item.course %}
                        <div class="form-control course-item" data-semester="{{ course.semester.id }}" data-course-name="{{ course.course.name|lower }}" data-course-code="{{ course.course.code|lower }}">
                            <label class="label cursor-pointer justify-start gap-2 hover:bg-base-200 p-2 rounded {% if item.is_repeat %}bg-warning/10{% endif %}">
                                <input type="checkbox" 
                                       name="courses" 
                                       value="{{ course.pk }}" 
                                       class="checkbox {% if item.is_repeat %}checkbox-warning{% else %}checkbox-primary{% endif %}" 
                                       data-semester="{{ course.semester.id }}" 
                                       {% if item.is_repeat %}data-repeat="true"{% endif %} />
                                <div class="flex flex-col">
                                    <div class="flex items-center">
                                        <span class="label-text ml-2">{{ course.course.code }} - {{ course.course.name }}</span>
                                        {% if item.is_repeat %}
                                        <span class="badge badge-warning ml-2">Repeat</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500 ml-2">
                                        <span class="semester-name">{{ course.semester }}</span>
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-control mt-6">
                    <button type="submit" class="btn btn-primary w-full">Enroll Student</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent form submission on Enter key for lookup form
    document.getElementById('student-lookup-form')?.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            this.querySelector('button[type="submit"]').click();
        }
    });

    // Ensure at least one course is selected before submitting enrollment form
    document.getElementById('enrollment-form')?.addEventListener('submit', function(event) {
        const coursesChecked = this.querySelectorAll('input[name="courses"]:checked').length;
        if (coursesChecked === 0) {
            event.preventDefault();
            alert('Please select at least one course.');
        }
    });

    // Auto-select semester when a course is selected
    const courseCheckboxes = document.querySelectorAll('input[name="courses"]');
    
    // Create a map of course IDs to their semester IDs and names
    const courseSemesterMap = {
        {% for item in course_data %}
            '{{ item.course.id }}': {
                id: '{{ item.course.semester.id }}',
                name: '{{ item.course.semester }}'
            },
        {% endfor %}
    };

    // Filter courses based on search query
    function filterCoursesBySearch() {
        const searchQuery = document.getElementById('course-search').value.toLowerCase().trim();
        const courseItems = document.querySelectorAll('.course-item');
        
        courseItems.forEach(item => {
            const courseName = item.dataset.courseName;
            const courseCode = item.dataset.courseCode;
            const matchesSearch = searchQuery === '' || 
                                 courseName.includes(searchQuery) || 
                                 courseCode.includes(searchQuery);
            
            if (matchesSearch) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Update semester selection based on selected courses
    function updateSemesterSelection() {
        const checkedCourses = Array.from(document.querySelectorAll('input[name="courses"]:checked'));
        const semesterInput = document.getElementById('semester-input');
        const semesterDisplay = document.getElementById('selected-semester-display');
        
        if (checkedCourses.length === 0) {
            semesterInput.value = '';
            semesterDisplay.textContent = 'Select courses to automatically detect semester';
            return;
        }
        
        const semesterIds = checkedCourses
            .map(checkbox => checkbox.dataset.semester)
            .filter((v, i, a) => a.indexOf(v) === i); // Get unique semester IDs
            
        if (semesterIds.length === 1) {
            // All selected courses are from the same semester
            const semesterId = semesterIds[0];
            const semesterName = checkedCourses[0].closest('.course-item').querySelector('.semester-name')?.textContent || 'Selected Semester';
            
            semesterInput.value = semesterId;
            semesterDisplay.textContent = semesterName;
        } else if (semesterIds.length > 1) {
            // Courses from multiple semesters selected
            console.warn('Courses from multiple semesters selected');
            semesterInput.value = '';
            semesterDisplay.textContent = 'Multiple semesters selected';
            alert('Please select courses from only one semester.');
            checkedCourses.forEach(checkbox => checkbox.checked = false); // Uncheck all
        }
    }
    
    // Handle course selection changes
    function handleCourseSelection(event) {
        const checkbox = event.target;
        
        if (checkbox.checked) {
            const semesterData = courseSemesterMap[checkbox.value];
            const semesterInput = document.getElementById('semester-input');
            if (semesterInput.value && semesterInput.value !== semesterData.id) {
                // If a different semester is already selected, prevent checking
                checkbox.checked = false;
                alert('Please select courses from only one semester.');
                return;
            }
        }
        
        updateSemesterSelection();
    }
    
    // Add event listeners
    document.getElementById('course-search').addEventListener('input', filterCoursesBySearch);
    
    // Use event delegation for course checkboxes
    document.getElementById('course-container').addEventListener('change', function(event) {
        if (event.target.matches('input[type="checkbox"]')) {
            handleCourseSelection(event);
        }
    });
    
    // Initial filter on page load
    filterCoursesBySearch();
});
</script>
{% endblock %}