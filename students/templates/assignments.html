{% extends 'base_student.html' %}

{% block title %}Assignments - {{ selected_course_offering.course.name }}{% endblock %}

{% block extra_head %}
<!-- Prism.js for syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

<style>
  .prose {
    max-width: 100%;
    word-wrap: break-word;
  }
  .prose img {
    max-width: 100%;
    height: auto;
    margin: 1rem 0;
    border-radius: 0.5rem;
  }
  .prose p {
    margin: 0.5rem 0;
  }
  .prose ul, .prose ol {
    margin: 0.5rem 0 0.5rem 1.5rem;
  }
  .modal-box {
    max-height: 80vh;
    overflow-y: auto;
  }
  .code-container {
    background: #2d3748;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    overflow-x: auto;
  }
  .code-container pre {
    margin: 0;
    background: transparent;
  }
  .code-container code {
    color: #e2e8f0;
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
    font-size: 14px;
    line-height: 1.5;
  }
  .submission-type-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 8px;
  }
  .submission-type-text {
    background: #dbeafe;
    color: #1e40af;
  }
  .submission-type-code {
    background: #dcfce7;
    color: #166534;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Header Section -->
  <div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
    <div class="hero-content text-center">
      <div class="max-w-md">
        <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Assignments</h1>
        <p class="text-base sm:text-lg text-base-content/90"> {{ selected_course_offering.course.name }} ({{ selected_course_offering.course.code }})</p>
      </div>
    </div>
  </div>

  <!-- All Assignments Table -->
  <div>
    <h3 class="text-2xl font-semibold text-base-content mb-4">All Assignments</h3>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="table w-full">
            <thead>
              <tr class="bg-base-200">
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Title</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Resources File</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Due Date</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Marks</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Submission</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-base-content/70 uppercase tracking-wider">Feedback/Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in all_assignments %}
              <tr class="{% if item.is_pending %}bg-primary/10{% else %}hover:bg-base-200/50{% endif %}">
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    {{ item.assignment_data.assignment.title }}
                  {% else %}
                    {{ item.assignment_data.submission.assignment.title }}
                  {% endif %}
                </td>
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    {% if item.assignment_data.assignment.resource_file %}
                      <a href="{{ item.assignment_data.assignment.resource_file.url }}" class="link link-primary" target="_blank">View Resource</a>
                    {% else %}
                      N/A
                    {% endif %}
                  {% else %}
                    {% if item.assignment_data.submission.assignment.resource_file %}
                      <a href="{{ item.assignment_data.submission.assignment.resource_file.url }}" class="link link-primary" target="_blank">View Resource</a>
                    {% else %}
                      N/A
                    {% endif %}
                  {% endif %}
                </td>
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    {{ item.assignment_data.assignment.due_date|date:"Y-m-d H:i" }}
                  {% else %}
                    {{ item.assignment_data.submission.assignment.due_date|date:"Y-m-d H:i" }}
                  {% endif %}
                </td>
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    {{ item.assignment_data.marks_obtained|default:"N/A" }} / {{ item.assignment_data.assignment.max_points }}
                  {% else %}
                    {{ item.assignment_data.submission.marks_obtained|default:"N/A" }} / {{ item.assignment_data.submission.assignment.max_points }}
                  {% endif %}
                </td>
                <td class="px-4 py-4">
                  {% if item.status == "Submitted" %}
                    <span class="badge badge-success badge-sm">Submitted</span>
                  {% elif item.status == "Pending" %}
                    <span class="badge badge-warning badge-sm">Pending</span>
                  {% else %}
                    <span class="badge badge-error badge-sm">Overdue</span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    <button 
                      class="btn btn-ghost btn-xs view-submission-btn"
                      data-assignment-number="{{ forloop.counter }}"
                      data-assignment-title="{% if item.status == 'Submitted' %}{{ item.assignment_data.assignment.title }}{% else %}{{ item.assignment_data.submission.assignment.title }}{% endif %}"
                      data-text-content="{% if item.status == 'Submitted' %}{{ item.assignment_data.text_content|escapejs }}{% else %}{{ item.assignment_data.submission.text_content|escapejs }}{% endif %}"
                      data-code-content="{% if item.status == 'Submitted' %}{{ item.assignment_data.code_content|escapejs }}{% else %}{{ item.assignment_data.submission.code_content|escapejs }}{% endif %}"
                      data-file-url="{% if item.status == 'Submitted' and item.assignment_data.file and item.assignment_data.file.url %}{{ item.assignment_data.file.url }}{% elif item.assignment_data.submission.file and item.assignment_data.submission.file.url %}{{ item.assignment_data.submission.file.url }}{% else %}{% endif %}"
                      data-file-name="{% if item.status == 'Submitted' and item.assignment_data.file and item.assignment_data.file.name %}{{ item.assignment_data.file.name }}{% elif item.assignment_data.submission.file and item.assignment_data.submission.file.name %}{{ item.assignment_data.submission.file.name }}{% else %}No file{% endif %}"
                      data-code-language="{% if item.status == 'Submitted' %}{{ item.assignment_data.code_language|default:'none' }}{% else %}{{ item.assignment_data.submission.code_language|default:'none' }}{% endif %}">
                      View Submission
                    </button>
                  {% else %}
                    <span class="text-gray-400">Not submitted</span>
                  {% endif %}
                </td>
                <td class="px-4 py-4 text-sm text-base-content">
                  {% if item.status == "Submitted" %}
                    {{ item.assignment_data.feedback|default:"No feedback yet" }}
                  {% elif item.status == "Pending" %}
                    <a href="{% url 'students:submit_assignment' assignment_id=item.assignment_data.submission.assignment.id %}" class="btn btn-primary btn-xs">Submit</a>
                  {% else %}
                    <span class="text-error">Overdue</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="px-4 py-4 text-sm text-base-content/70 text-center">No assignments found.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Submission Content Modal -->
<dialog id="submissionModal" class="modal">
  <div class="modal-box max-w-4xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-lg" id="modalAssignmentTitle">Assignment # - Title</h3>
      <button onclick="document.getElementById('submissionModal').close()" class="btn btn-sm btn-circle">
        &times;
      </button>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold mb-2">Text Content</h4>
      <div id="modalTextContent" class="prose max-w-none" style="white-space: pre-wrap;">
        <!-- Text content will be inserted here -->
      </div>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold mb-2">Code Content</h4>
      <pre id="modalCodeContent" class="bg-gray-100 p-3 rounded overflow-x-auto"><code></code></pre>
    </div>
    
    <div class="mb-4">
      <h4 class="font-semibold mb-2">Uploaded Files</h4>
      <div id="modalFileContent" class="space-y-4">
        <!-- Uploaded files will be inserted here -->
      </div>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
  // Add event listeners for view submission buttons
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.view-submission-btn').forEach(button => {
      button.addEventListener('click', function() {
        const assignmentNumber = this.dataset.assignmentNumber;
        const assignmentTitle = this.dataset.assignmentTitle;
        const textContent = this.dataset.textContent;
        const codeContent = this.dataset.codeContent;
        const fileUrl = this.dataset.fileUrl;
        const fileName = this.dataset.fileName;
        const codeLanguage = this.dataset.codeLanguage;
        
        openSubmissionModal(assignmentNumber, assignmentTitle, textContent, codeContent, fileUrl, fileName, codeLanguage);
      });
    });
  });

  function openSubmissionModal(assignmentNumber, assignmentTitle, textContent, codeContent, fileUrl, fileName, codeLanguage) {
    const modal = document.getElementById('submissionModal');
    const modalTitle = document.getElementById('modalAssignmentTitle');
    const modalText = document.getElementById('modalTextContent');
    const modalCode = document.getElementById('modalCodeContent').querySelector('code');
    const modalFile = document.getElementById('modalFileContent');

    // Set assignment title
    modalTitle.textContent = `Assignment ${assignmentNumber} - ${assignmentTitle}`;

    // Set text content
    if (textContent && textContent.trim() !== '') {
      // Decode unicode escape sequences in text content
      function decodeUnicodeEscape(str) {
        return str.replace(/\\u[\dA-Fa-f]{4}/g, function(match) {
          return String.fromCharCode(parseInt(match.replace('\\u', ''), 16));
        });
      }
      const decodedText = decodeUnicodeEscape(textContent);

      try {
        // Try to parse JSON encoded content (if stored as JSON string)
        const parsedContent = JSON.parse(decodedText);
        modalText.innerHTML = parsedContent;
      } catch (e) {
        // If not JSON, treat as raw HTML
        modalText.innerHTML = decodedText;
      }
    } else {
      modalText.innerHTML = '<p class="text-gray-500 italic">No text content available.</p>';
    }

    // Set code content
    if (codeContent && codeContent.trim() !== '') {
      // Decode unicode escape sequences
      function decodeUnicodeEscape(str) {
        return str.replace(/\\u[\dA-Fa-f]{4}/g, function(match) {
          return String.fromCharCode(parseInt(match.replace('\\u', ''), 16));
        });
      }
      const decodedCode = decodeUnicodeEscape(codeContent);

      // Escape HTML special characters in code content
      const escapedCode = decodedCode.replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#039;');
      modalCode.innerHTML = escapedCode;

      // Remove existing language classes
      modalCode.className = '';

      // Map codeLanguage to Prism language class
      const languageMap = {
        'python': 'language-python',
        'javascript': 'language-javascript',
        'html': 'language-markup',
        'css': 'language-css',
        'c': 'language-c',
        'cpp': 'language-cpp',
        'java': 'language-java',
        'php': 'language-php',
        'sql': 'language-sql',
        'none': ''
      };
      const prismClass = languageMap[codeLanguage.toLowerCase()] || '';
      if (prismClass) {
        modalCode.classList.add(prismClass);
      }

      // Apply syntax highlighting if Prism is available
      if (typeof Prism !== 'undefined') {
        Prism.highlightElement(modalCode);
      }
    } else {
      modalCode.textContent = 'No code content available.';
      modalCode.className = '';
    }

    // Set file content
    if (fileUrl && fileUrl.trim() !== '') {
      let fileHtml = '';
      const lowerUrl = fileUrl.toLowerCase();
      if (lowerUrl.endsWith('.jpg') || lowerUrl.endsWith('.jpeg') || lowerUrl.endsWith('.png') || lowerUrl.endsWith('.gif')) {
        fileHtml = `<img src="${fileUrl}" alt="Uploaded Image" class="max-w-full h-auto rounded" />`;
      } else {
        fileHtml = `<a href="${fileUrl}" target="_blank" class="text-primary underline">${fileName || 'Download File'}</a>`;
      }
      modalFile.innerHTML = fileHtml;
    } else {
      modalFile.innerHTML = '<p class="text-gray-500 italic">No files uploaded.</p>';
    }

    modal.showModal();
  }

  // Close modal when clicking outside
  document.getElementById('submissionModal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.close();
    }
  });
</script>
{% endblock %}
