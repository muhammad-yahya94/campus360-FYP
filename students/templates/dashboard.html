{% extends 'base_student.html' %}

{% block title %}Student Dashboard - {{ student.applicant.full_name }}{% endblock %}

{% block extra_head %}
<!-- Canvas for fireworks -->
<canvas id="fireworks-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: none;"></canvas>

<!-- Graduation Celebration Modal -->
<div id="graduation-modal" class="modal modal-bottom sm:modal-middle" style="display: none;">
  <div class="modal-box bg-gradient-to-br from-primary to-secondary text-primary-content">
    <h3 class="font-bold text-3xl text-center mb-4">ðŸŽ“ Congratulations! ðŸŽ“</h3>
    <p class="py-4 text-center text-xl">You've successfully graduated! We're so proud of your achievement!</p>
    <div class="flex justify-center mt-6">
      <button onclick="stopCelebration()" class="btn btn-accent">Continue to Dashboard</button>
    </div>
  </div>
</div>

<!-- Audio for celebration -->
<audio id="celebration-audio" loop>
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mp3">
</audio>
{% endblock %}

{% block content %}
{% if is_graduated %}
  {% include 'students/includes/graduation_celebration.html' %}
{% endif %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Hero Section -->
  <div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
    <div class="hero-content text-center">
      <div class="max-w-md">
        <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Student Dashboard</h1>
        <p class="text-base sm:text-lg text-base-content/90">Welcome, {{ student.applicant.full_name }}! Explore your courses for {{ active_semester.name|default:"current semester" }}.</p>
      </div>
    </div>
  </div>

  <!-- Notices Section -->
  <div class="card bg-base-100 shadow-lg rounded-lg mb-6">
    <div class="card-body">
      <h2 class="card-title text-2xl text-base-content mb-4">Recent Notices</h2>
      <div class="space-y-3">
        {% for notice in notices %}
        <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
          <div class="flex-1">
            <p class="text-base-content font-medium truncate">{{ notice.title }}</p>
            <p class="text-sm text-base-content/70 truncate">{{ notice.content|truncatewords:10 }}</p>
          </div>
          <div class="text-sm text-base-content/70">
            {{ notice.created_at|timesince }} ago
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Enrolled Courses by Semester -->
  {% if semester_courses %}
    {% for semester_id, semester_data in semester_courses.items %}
    <div class="card bg-base-100 shadow-lg rounded-lg overflow-hidden mb-6">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title text-2xl text-base-content">
            {{ semester_data.semester.name }}
            {% if semester_data.is_active %}
              <span class="badge badge-primary ml-2">Active</span>
            {% endif %}
          </h2>
          <span class="text-sm text-base-content/70">
            {{ semester_data.session.name }} ({{ semester_data.session.start_year }}-{{ semester_data.session.end_year }})
          </span>
        </div>
        
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Course Code</th>
                <th>Course Name</th>
                <th>Instructor</th>
                <th>Type</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for enrollment in semester_data.courses %}
              <tr class="{% if enrollment.is_repeat %}bg-warning/10{% endif %}">
                <td>{{ enrollment.course_offering.course.code }}</td>
                <td>
                  <div class="flex items-center gap-2">
                    {{ enrollment.course_offering.course.name }}
                    {% if enrollment.is_repeat %}
                    <span class="badge badge-warning badge-sm">Repeat</span>
                    {% endif %}
                  </div>
                </td>
                <td>{{ enrollment.course_offering.teacher.user.get_full_name|default:"TBA" }}</td>
                <td>{{ enrollment.course_offering.get_offering_type_display }}</td>
                <td>
                  <span class="badge {% if enrollment.status == 'enrolled' %}badge-success{% else %}badge-warning{% endif %}">
                    {{ enrollment.get_status_display }}
                  </span>
                </td>
                <td>
                  <div class="flex gap-2">
                    <a href="{% url 'students:study_materials' enrollment.course_offering.id %}"
                       class="btn btn-xs btn-ghost" title="Course Content">
                      <i class="fas fa-book"></i>
                    </a>
                    <a href="{% url 'students:assignments' enrollment.course_offering.id %}"
                       class="btn btn-xs btn-ghost" title="Assignments">
                      <i class="fas fa-tasks"></i>
                    </a>
                    <a href="{% url 'students:attendance' enrollment.course_offering.id %}"
                       class="btn btn-xs btn-ghost" title="Attendance">
                      <i class="fas fa-calendar-check"></i>
                    </a>
                    <a href="{% url 'students:solve_quiz' enrollment.course_offering.id %}"
                       class="btn btn-xs btn-ghost" title="Quizzes">
                      <i class="fas fa-question-circle"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-info shadow-lg mb-6">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>You have no enrolled courses yet.</span>
    </div>
  {% endif %}

  <!-- Repeat Courses Section -->
  {% if repeat_courses %}
  <div class="card bg-base-100 shadow-lg rounded-lg overflow-hidden mb-6">
    <div class="card-body">
      <h2 class="card-title text-2xl text-base-content mb-4">
        Repeat Courses
        <span class="badge badge-warning ml-2">{{ repeat_courses|length }} course(s)</span>
      </h2>
      
      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              <th>Course Code</th>
              <th>Course Name</th>
              <th>Instructor</th>
              <th>Type</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for enrollment in repeat_courses %}
            <tr class="bg-warning/10">
              <td>{{ enrollment.course_offering.course.code }}</td>
              <td>
                <div class="flex items-center gap-2">
                  {{ enrollment.course_offering.course.name }}
                  <span class="badge badge-warning badge-sm">Repeat</span>
                </div>
              </td>
              <td>{{ enrollment.course_offering.teacher.user.get_full_name|default:"TBA" }}</td>
              <td>{{ enrollment.course_offering.get_offering_type_display }}</td>
              <td>
                <span class="badge {% if enrollment.status == 'enrolled' %}badge-success{% else %}badge-warning{% endif %}">
                  {{ enrollment.get_status_display }}
                </span>
              </td>
              <td>
                <div class="flex gap-2">
                  <a href="{% url 'students:study_materials' enrollment.course_offering.id %}"
                     class="btn btn-xs btn-ghost" title="Course Content">
                    <i class="fas fa-book"></i>
                  </a>
                  <a href="{% url 'students:assignments' enrollment.course_offering.id %}"
                     class="btn btn-xs btn-ghost" title="Assignments">
                    <i class="fas fa-tasks"></i>
                  </a>
                  <a href="{% url 'students:attendance' enrollment.course_offering.id %}"
                     class="btn btn-xs btn-ghost" title="Attendance">
                    <i class="fas fa-calendar-check"></i>
                  </a>
                  <a href="{% url 'students:solve_quiz' enrollment.course_offering.id %}"
                     class="btn btn-xs btn-ghost" title="Quizzes">
                    <i class="fas fa-question-circle"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Quick Actions -->
  <div class="card bg-base-100 shadow-lg rounded-lg">
    <div class="card-body">
      <h2 class="card-title text-2xl text-base-content mb-4">Quick Actions</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="{% url "students:settings" %}" class="btn btn-primary">View Settings</a>
        <a href="{% url 'students:my_courses' %}" class="btn btn-success">My Courses</a>
        <a href="{% url 'students:attendance_stats' %}" class="btn btn-accent">Attendance Stats</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}