{% extends 'base_student.html' %}
{% load static %}

{% block title %}Campus360 - Online IDE{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-code mr-2"></i> Online Code Editor
    </h2>

    <!-- Editor Card -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <!-- Toolbar -->
        <div class="bg-blue-600 text-white px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <select id="language" class="bg-blue-700 text-white text-sm rounded px-3 py-1 border border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-300">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                </select>
                <button id="run-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex items-center">
                    <i class="fas fa-play mr-1"></i> Run
                </button>
                <button id="clear-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm flex items-center">
                    <i class="fas fa-eraser mr-1"></i> Clear
                </button>
            </div>
            <div>
                <button id="save-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded text-sm flex items-center">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="h-96">
            <!-- HTML/CSS/JS Editors (Hidden by Default) -->
            <div id="web-editors" class="hidden">
                <div class="flex gap-4 h-full">
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">HTML</label>
                        <textarea id="html-editor" class="h-[calc(100%-2rem)] w-full"></textarea>
                    </div>
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">CSS</label>
                        <textarea id="css-editor" class="h-[calc(100%-2rem)] w-full"></textarea>
                    </div>
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">JavaScript</label>
                        <textarea id="js-editor" class="h-[calc(100%-2rem)] w-full"></textarea>
                    </div>
                </div>
            </div>
            <!-- Single Editor for Python/C/C++ -->
            <div id="code-editor" class="h-full">
                <textarea id="editor" class="w-full h-full"># Write your code here
# Example Python code
print("Hello, Campus360!")</textarea>
            </div>
        </div>
    </div>

    <!-- Output Panel -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gray-800 text-white px-4 py-2 font-mono text-sm flex items-center">
            <i class="fas fa-terminal mr-2"></i> Output
        </div>
        <div class="h-48 overflow-auto bg-gray-900 text-gray-100 p-4 font-mono text-sm">
            <!-- Iframe for HTML/CSS/JS Output -->
            <iframe id="web-output" class="w-full h-full hidden"></iframe>
            <!-- Pre for Python/C/C++ Output -->
            <pre id="output" class="whitespace-pre-wrap"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
<!-- Language Modes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/clike/clike.min.js"></script>
<!-- Theme -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">

<script>
// Initialize CodeMirror Editors
const codeEditor = CodeMirror.fromTextArea(document.getElementById('editor'), {
    mode: 'python',
    theme: 'monokai',
    lineNumbers: true,
    tabSize: 4,
    indentWithTabs: false,
    lineWrapping: true
});

const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
    mode: 'htmlmixed',
    theme: 'monokai',
    lineNumbers: true,
    tabSize: 4,
    indentWithTabs: false,
    lineWrapping: true
});

const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
    mode: 'css',
    theme: 'monokai',
    lineNumbers: true,
    tabSize: 4,
    indentWithTabs: false,
    lineWrapping: true
});

const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
    mode: 'javascript',
    theme: 'monokai',
    lineNumbers: true,
    tabSize: 4,
    indentWithTabs: false,
    lineWrapping: true
});

// Toggle Editors and Output Based on Language
const languageSelect = document.getElementById('language');
const webEditors = document.getElementById('web-editors');
const codeEditorDiv = document.getElementById('code-editor');
const webOutput = document.getElementById('web-output');
const textOutput = document.getElementById('output');

languageSelect.addEventListener('change', function() {
    const lang = this.value;
    const modes = {
        python: 'python',
        c: 'text/x-csrc',
        cpp: 'text/x-c++src',
        html: 'htmlmixed',
        css: 'css',
        javascript: 'javascript'
    };
    const examples = {
        python: '# Example Python code\nprint("Hello, Campus360!")',
        c: '#include <stdio.h>\nint main() {\n    printf("Hello, Campus360!\\n");\n    return 0;\n}',
        cpp: '#include <iostream>\nusing namespace std;\nint main() {\n    cout << "Hello, Campus360!" << endl;\n    return 0;\n}',
        html: '<h1>Hello, Campus360!</h1>',
        css: 'h1 { color: blue; }',
        javascript: 'console.log("Hello, Campus360!");'
    };
    if (['html', 'css', 'javascript'].includes(lang)) {
        webEditors.classList.remove('hidden');
        codeEditorDiv.classList.add('hidden');
        webOutput.classList.remove('hidden');
        textOutput.classList.add('hidden');
        htmlEditor.setValue(examples.html || '');
        cssEditor.setValue(examples.css || '');
        jsEditor.setValue(examples.javascript || '');
        updateWebOutput();
    } else {
        webEditors.classList.add('hidden');
        codeEditorDiv.classList.remove('hidden');
        webOutput.classList.add('hidden');
        textOutput.classList.remove('hidden');
        codeEditor.setOption('mode', modes[lang]);
        codeEditor.setValue(examples[lang] || '');
        textOutput.textContent = '';
    }
});

// Debounce for Live Preview
function debounce(func, wait) {
    let timeout;
    return function() {
        clearTimeout(timeout);
        timeout = setTimeout(func, wait);
    };
}

const updateWebOutput = debounce(function() {
    if (['html', 'css', 'javascript'].includes(languageSelect.value)) {
        const htmlCode = htmlEditor.getValue();
        const cssCode = `<style>${cssEditor.getValue()}</style>`;
        const jsCode = `<script>${jsEditor.getValue()}<\/script>`;
        const outputFrame = webOutput.contentWindow.document;
        outputFrame.open();
        outputFrame.write(htmlCode + cssCode + jsCode);
        outputFrame.close();
    }
}, 300);

// Attach live preview to web editors
htmlEditor.on('change', updateWebOutput);
cssEditor.on('change', updateWebOutput);
jsEditor.on('change', updateWebOutput);

// Run Button Handler
document.getElementById('run-btn').addEventListener('click', function() {
    const language = languageSelect.value;
    const runBtn = this;
    runBtn.disabled = true;
    runBtn.classList.add('opacity-50', 'cursor-not-allowed');

    if (['html', 'css', 'javascript'].includes(language)) {
        updateWebOutput();
        runBtn.disabled = false;
        runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        const code = codeEditor.getValue();
        textOutput.textContent = 'Running...';
        textOutput.classList.remove('error');
        fetch('{% url 'students:run_code' %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                code: code,
                language: language
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                textOutput.textContent = 'Error: ' + data.error;
                textOutput.classList.add('error');
            } else {
                textOutput.textContent = data.output || 'No output';
                textOutput.classList.remove('error');
            }
            runBtn.disabled = false;
            runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        })
        .catch(error => {
            textOutput.textContent = 'Error: ' + error.message;
            textOutput.classList.add('error');
            runBtn.disabled = false;
            runBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }
});

// Clear Button Handler
document.getElementById('clear-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to clear the editor?')) {
        if (['html', 'css', 'javascript'].includes(languageSelect.value)) {
            htmlEditor.setValue('');
            cssEditor.setValue('');
            jsEditor.setValue('');
            webOutput.contentWindow.document.body.innerHTML = '';
        } else {
            codeEditor.setValue('');
            textOutput.textContent = '';
            textOutput.classList.remove('error');
        }
    }
});

// Save Button Handler (Updated for Separate Files)
document.getElementById('save-btn').addEventListener('click', function() {
    const language = languageSelect.value;
    const defaultExt = {
        python: 'py',
        javascript: 'js',
        html: 'html',
        css: 'css',
        c: 'c',
        cpp: 'cpp'
    }[language] || 'txt';

    let code = '';
    if (language === 'html') {
        code = htmlEditor.getValue();
    } else if (language === 'css') {
        code = cssEditor.getValue();
    } else if (language === 'javascript') {
        code = jsEditor.getValue();
    } else {
        code = codeEditor.getValue();
    }

    const filename = prompt('Enter filename:', `code.${defaultExt}`);
    if (filename) {
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom scrollbar for output panel */
    #output::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    #output::-webkit-scrollbar-track {
        background: #1a202c;
    }
    #output::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
    }
    #output::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* CodeMirror custom styles */
    .CodeMirror {
        width: 100%;
        height: 100%;
        font-family: 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 14px;
    }

    /* Iframe for web output */
    #web-output {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Error styling */
    #output.error {
        color: #f87171;
    }

    /* Custom select dropdown */
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1em;
        padding-right: 2.5rem;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .flex.gap-4 {
            flex-direction: column;
        }
        .w-1/3 {
            width: 100%;
        }
        .h-96 {
            height: 50vh;
       凉
        .h-48 {
            height: 30vh;
        }
    }
</style>
{% endblock %}