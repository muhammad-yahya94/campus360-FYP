{% extends 'base_student.html' %}
{% load static %}

{% block title %}Campus360 - Online IDE{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6 max-w-6xl">
  <!-- Header Section -->
  <div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
    <div class="hero-content text-center">
      <div class="max-w-md">
        <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Online Code Editor</h1>
        <p class="text-base sm:text-lg text-base-content/90"> Practice web development </p>
      </div>
    </div>
  </div>

    <!-- Editor Card -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <!-- Toolbar -->
        <div class="bg-base-200 px-4 py-3 flex flex-wrap gap-2 justify-between items-center border-b border-base-300">
            <div class="flex flex-wrap gap-2">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm font-medium">Theme</span>
                    </label>
                    <select id="theme" class="select select-bordered select-sm w-full max-w-xs">
                        <option value="monokai">Monokai</option>
                        <option value="dracula">Dracula</option>
                        <option value="solarized light">Solarized Light</option>
                        <option value="nord">Nord</option>
                        <option value="material">Material</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-sm font-medium">Font Size</span>
                    </label>
                    <select id="font-size" class="select select-bordered select-sm">
                        <option value="12px">Small</option>
                        <option value="14px" selected>Medium</option>
                        <option value="16px">Large</option>
                    </select>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="clear-btn" class="btn btn-sm btn-warning">
                    <i class="fas fa-eraser mr-1"></i> Clear
                </button>
                <button id="save-btn" class="btn btn-sm btn-primary">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
            </div>
        </div>

        <!-- Editor Area -->
        <div class="h-96">
            <!-- HTML/CSS/JS Editors -->
            <div id="web-editors">
                <div class="flex gap-4 h-full">
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">HTML</label>
                        <textarea id="html-editor" class="h-[calc(100%-2rem)] w-full"><!DOCTYPE html>
<html>
<head>
    <title>My Web Page</title>
</head>
<body>
    <h1>Welcome to Campus360 IDE</h1>
    <p>Start coding here!</p>
    <div id="output"></div>
</body>
</html></textarea>
                    </div>
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">CSS</label>
                        <textarea id="css-editor" class="h-[calc(100%-2rem)] w-full">body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
}

h1 {
    color: #2c3e50;
    text-align: center;
}

#output {
    margin-top: 20px;
    padding: 15px;
    background: white;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}</textarea>
                    </div>
                    <div class="w-1/3">
                        <label class="block bg-gray-800 text-white px-2 py-1 font-mono">JavaScript</label>
                        <textarea id="js-editor" class="h-[calc(100%-2rem)] w-full">// JavaScript code goes here
document.addEventListener('DOMContentLoaded', function() {
    const output = document.getElementById('output');
    output.innerHTML = 'JavaScript is working! ðŸŽ‰';
    
    // Example: Change background color on click
    document.body.addEventListener('click', function() {
        const colors = ['#f0f9ff', '#f0fff4', '#fff7ed'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        document.body.style.backgroundColor = randomColor;
    });
});</textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Output Panel -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gray-800 text-white px-4 py-2 font-mono text-sm flex items-center">
            <i class="fas fa-terminal mr-2"></i> Preview
        </div>
        <div class="h-64 overflow-auto bg-white text-gray-900 p-4 font-mono text-sm">
            <iframe id="web-output" class="w-full h-full"></iframe>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
<!-- Language Modes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
<!-- Themes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/solarized.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/nord.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material.min.css">

<script>
// Initialize CodeMirror editors with default theme from localStorage
const savedTheme = localStorage.getItem('selectedTheme') || 'light';
const defaultTheme = savedTheme === 'dark' ? 'monokai' : 'default';

const editorOptions = {
    theme: defaultTheme,
    lineNumbers: true,
    lineWrapping: true,
    autoCloseBrackets: true,
    extraKeys: {"Ctrl-Space": "autocomplete"},
    indentUnit: 4,
    tabSize: 4,
    indentWithTabs: false
};

const htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
    ...editorOptions,
    mode: 'htmlmixed'
});

const cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
    ...editorOptions,
    mode: 'css'
});

const jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
    ...editorOptions,
    mode: 'javascript'
});

// Set initial font size
const savedFontSize = localStorage.getItem('editorFontSize') || '14px';
document.documentElement.style.setProperty('--editor-font-size', savedFontSize);
document.getElementById('font-size').value = savedFontSize;

// Apply font size to all editors
const updateFontSize = (size) => {
    document.documentElement.style.setProperty('--editor-font-size', size);
    document.querySelectorAll('.CodeMirror').forEach(editor => {
        editor.CodeMirror.refresh();
    });
    localStorage.setItem('editorFontSize', size);
};

// Apply theme to all editors
const updateEditorTheme = (theme) => {
    [htmlEditor, cssEditor, jsEditor].forEach(editor => {
        editor.setOption('theme', theme);
    });
}

// Theme selector
document.getElementById('theme').addEventListener('change', function() {
    const theme = this.value;
    updateEditorTheme(theme);
});

// Font size selector
document.getElementById('font-size').addEventListener('change', function() {
    updateFontSize(this.value);
});

// Set initial theme from saved preference
const savedEditorTheme = localStorage.getItem('editorTheme') || defaultTheme;
document.getElementById('theme').value = savedEditorTheme;
updateEditorTheme(savedEditorTheme);

// Listen for theme changes from the main app
document.addEventListener('themeChanged', (e) => {
    const newTheme = e.detail.theme === 'dark' ? 'monokai' : 'default';
    updateEditorTheme(newTheme);
    document.getElementById('theme').value = newTheme;
});

// Debounce for Live Preview
function debounce(func, wait) {
    let timeout;
    return function() {
        clearTimeout(timeout);
        timeout = setTimeout(func, wait);
    };
}

const updateWebOutput = debounce(function() {
    const htmlCode = htmlEditor.getValue();
    const cssCode = `<style>${cssEditor.getValue()}</style>`;
    const jsCode = `<script>${jsEditor.getValue()}<\/script>`;
    const outputFrame = document.getElementById('web-output').contentWindow.document;
    outputFrame.open();
    outputFrame.write(htmlCode + cssCode + jsCode);
    outputFrame.close();
}, 300);

// Initial render and attach live preview
updateWebOutput();
htmlEditor.on('change', updateWebOutput);
cssEditor.on('change', updateWebOutput);
jsEditor.on('change', updateWebOutput);

// Clear Button Handler
document.getElementById('clear-btn').addEventListener('click', function() {
    if (confirm('Are you sure you want to clear the editor?')) {
        htmlEditor.setValue(`<!DOCTYPE html>
<html>
<head>
    <title>My Web Page</title>
</head>
<body>
    <h1>Welcome to Campus360 IDE</h1>
    <p>Start coding here!</p>
    <div id="output"></div>
</body>
</html>`);
        cssEditor.setValue(`body {
    font-family: Arial, sans-serif;
    line-height: 1.6;
    margin: 0;
    padding: 20px;
    background-color: #f5f5f5;
}

h1 {
    color: #2c3e50;
    text-align: center;
}

#output {
    margin-top: 20px;
    padding: 15px;
    background: white;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}`);
        jsEditor.setValue(`// JavaScript code goes here
document.addEventListener('DOMContentLoaded', function() {
    const output = document.getElementById('output');
    output.innerHTML = 'JavaScript is working! ðŸŽ‰';
    
    // Example: Change background color on click
    document.body.addEventListener('click', function() {
        const colors = ['#f0f9ff', '#f0fff4', '#fff7ed'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        document.body.style.backgroundColor = randomColor;
    });
});`);
        updateWebOutput();
    }
});

// Save Button Handler
document.getElementById('save-btn').addEventListener('click', function() {
    const filename = prompt('Enter filename:', `code.html`);
    if (filename) {
        const htmlCode = htmlEditor.getValue();
        const cssCode = `<style>${cssEditor.getValue()}</style>`;
        const jsCode = `<script>${jsEditor.getValue()}<\/script>`;
        const fullCode = htmlCode + cssCode + jsCode;
        const blob = new Blob([fullCode], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    #web-output {
        width: 100%;
        height: 100%;
        border: none;
    }
    :root {
        --editor-font-size: 14px;
    }
    
    /* Custom styles for the IDE */
    .CodeMirror {
        height: 100%;
        font-family: 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: var(--editor-font-size);
        line-height: 1.5;
        transition: background-color 0.3s ease;
    }
    
    .CodeMirror-gutters {
        background-color: var(--fallback-b1, oklch(var(--b1)));
        border-right: 1px solid var(--fallback-b2, oklch(var(--b2)));
    }
    
    .CodeMirror-linenumber {
        color: var(--fallback-bc, oklch(var(--bc) / 0.7));
        padding: 0 8px;
    }
    
    /* Theme-aware styles */
    [data-theme="dark"] .CodeMirror {
        --fallback-b1: #1e1e1e;
        --fallback-b2: #2d2d2d;
        --fallback-bc: #d1d5db;
    }
    
    [data-theme="light"] .CodeMirror {
        --fallback-b1: #ffffff;
        --fallback-b2: #e5e7eb;
        --fallback-bc: #4b5563;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .CodeMirror {
            font-size: calc(var(--editor-font-size) * 0.9);
        }
    }
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1em;
        padding-right: 2.5rem;
    }
    @media (max-width: 768px) {
        .flex.gap-4 {
            flex-direction: column;
        }
        .w-1/3 {
            width: 100%;
        }
        .h-96 {
            height: 50vh;
        }
        .h-64 {
            height: 40vh;
        }
    }
</style>
{% endblock %}