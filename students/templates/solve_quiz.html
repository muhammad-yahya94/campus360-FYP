{% extends 'base_student.html' %}

{% block title %}Solve Quiz - {{ course_offering.course.name }}{% endblock %}

{% block content %}
<style>
    .select2-container {
        @apply w-full;
    }
</style>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Hero Section -->
    <div class="hero bg-base-200 text-base-content rounded-lg shadow-lg mb-6">
        <div class="hero-content text-center py-6">
            <div class="max-w-md">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">Solve Quiz</h1>
                <p class="text-base sm:text-lg text-base-content/90">
                    For {{ course_offering.course.code }} - {{ course_offering.course.name }}
                </p>
            </div>
        </div>
    </div>

    <!-- Quizzes Table -->
    <div class="card bg-base-100 shadow-lg rounded-lg mb-6">
        <div class="card-body">
            <h5 class="card-title text-xl text-base-content mb-4">Available Quizzes</h5>
            <form id="course-selection-form">
                <div class="mb-4">
                    <label for="course_offering_id" class="label text-sm font-medium text-base-content">Course Offering</label>
                    <p id="course-offering-text" class="text-base-content/70">
                        {{ course_offering.course.code }} - {{ course_offering.course.name }} - {{ course_offering.program.name }} ({{ course_offering.semester.name }}, {{ course_offering.academic_session.name }})
                    </p>
                    <input type="hidden" name="course_offering_id" id="course_offering_id" value="{{ course_offering.id }}">
                    <span id="course-offering-error" class="text-error text-sm mt-1"></span>
                </div>
            </form>

            {% if quizzes %}
                <div class="mt-6">
                    <h6 class="text-lg font-semibold text-base-content mb-3">Published Quizzes</h6>
                    <div class="overflow-x-auto">
                        <table class="table w-full bg-base-100">
                            <thead class="bg-base-200">
                                <tr>
                                    <th class="text-sm font-semibold text-base-content/80">Title</th>
                                    <th class="text-sm font-semibold text-base-content/80">Timer (Seconds)</th>
                                    <th class="text-sm font-semibold text-base-content/80">Questions</th>
                                    <th class="text-sm font-semibold text-base-content/80">Created at</th>
                                    <th class="text-sm font-semibold text-base-content/80">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for quiz_data in quizzes %}
                                    <tr class="hover:bg-base-200/50">
                                        <td class="text-sm text-base-content">{{ quiz_data.quiz.title }}</td>
                                        <td class="text-sm text-base-content">{{ quiz_data.quiz.timer_seconds }}</td>
                                        <td class="text-sm text-base-content">{{ quiz_data.quiz.questions.count }}</td>
                                        <td class="text-sm text-base-content">{{ quiz_data.quiz.created_at }}</td>
                                        <td>
                                            {% if quiz_data.has_taken %}
                                                <a href="{% url 'students:submit_quiz' quiz_data.quiz.id %}" class="btn btn-sm btn-success hover:scale-105 transition-transform">View Result</a>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-primary solve-quiz hover:scale-105 transition-transform" data-quiz-id="{{ quiz_data.quiz.id }}">Solve</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info shadow-lg mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>No published quizzes available for this course offering.</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Solve Quiz Modal -->
<div class="modal" id="solveQuizModal" tabindex="-1" aria-labelledby="solveQuizModalLabel" aria-hidden="true">
    <div class="modal-box max-w-2xl w-[95%] sm:w-full mx-auto my-6">
        <h5 class="text-xl font-semibold text-base-content mb-4" id="solveQuizModalLabel">Solve Quiz</h5>
        <form id="solve-quiz-form" method="post" action="">
            {% csrf_token %}
            <input type="hidden" id="quiz-id" name="quiz_id" value="">
            <div class="mb-4">
                <h6 class="text-lg font-semibold text-base-content">
                    Time Remaining: <span id="timer" class="text-primary font-semibold">0</span> seconds
                </h6>
                <p id="timer-expired-message" class="text-error text-sm font-medium mt-2 hidden animate-pulse">
                    Time's up! Question marked incorrect.
                </p>
            </div>
            <div id="question-blocks"></div>
            <div class="modal-action mt-4">
                <button type="button" class="btn btn-sm btn-ghost" id="modal-close">Close</button>
                <div class="space-x-2">
                    <button type="button" class="btn btn-sm btn-secondary" id="prev-question">Previous</button>
                    <button type="button" class="btn btn-sm btn-secondary" id="next-question">Next</button>
                    <button type="submit" class="btn btn-sm btn-primary">Submit Quiz</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// XSS protection
function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
}

// Modal handling
const modal = document.getElementById('solveQuizModal');
const modalClose = document.getElementById('modal-close');

function openModal() {
    modal.classList.add('modal-open');
}
function closeModal() {
    modal.classList.remove('modal-open');
}

modalClose.addEventListener('click', closeModal);

// Quiz solving logic
let currentQuestionIndex = 0;
let questions = [];
let timerSeconds = 0;
let timerInterval = null;

function startTimer(seconds) {
    clearInterval(timerInterval);
    timerSeconds = seconds;
    $('#timer').text(timerSeconds);
    $('#timer-expired-message').addClass('hidden');
    timerInterval = setInterval(() => {
        timerSeconds--;
        $('#timer').text(timerSeconds);
        if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            questions[currentQuestionIndex].selected_option = null;
            console.log(`Timer expired for question ${currentQuestionIndex + 1}, marked as incorrect`);
            $('#timer-expired-message').removeClass('hidden');
            setTimeout(() => {
                if (currentQuestionIndex < questions.length - 1) {
                    showQuestion(currentQuestionIndex + 1);
                } else {
                    $('#solve-quiz-form').submit();
                }
            }, 1000);
        }
    }, 1000);
}

function showQuestion(index) {
    if (index < 0 || index >= questions.length) return;
    currentQuestionIndex = index;
    const question = questions[index];
    $('#question-blocks').html(`
        <div class="card bg-base-100 shadow-md border border-base-200">
            <div class="card-body">
                <label class="label text-sm font-medium text-base-content">
                    Question ${index + 1}: ${escapeHtml(question.text)}
                </label>
                <div class="space-y-2">
                    ${question.options.map((option, j) => `
                        <div class="flex items-center">
                            <input type="radio" name="answers[${index}]" value="${option.id}" class="radio radio-primary mr-2" id="option-${index}-${j}" ${question.selected_option == option.id ? 'checked' : ''}>
                            <label for="option-${index}-${j}" class="text-sm text-base-content">${escapeHtml(option.text)}</label>
                        </div>
                    `).join('')}
                </div>
                <span id="question-${index}-error" class="text-error text-sm mt-1"></span>
            </div>
        </div>
    `);
    $('#prev-question').prop('disabled', index === 0);
    $('#next-question').prop('disabled', index === questions.length - 1);
    startTimer(question.timer_seconds);
    $('.modal-box').animate({ scrollTop: 0 }, 300);
}

$(document).on('click', '.solve-quiz', function() {
    const quizId = $(this).data('quiz-id');
    console.log('Fetching quiz data for ID:', quizId);
    $.ajax({
        url: `/student/get-quiz/${quizId}/`,
        type: 'GET',
        success: function(response) {
            console.log('Quiz data received:', response);
            if (!response.questions || response.questions.length === 0) {
                console.error('Invalid quiz data: No questions found.');
                alert('Invalid quiz data: No questions available.');
                return;
            }
            questions = response.questions.map(q => ({
                ...q,
                timer_seconds: response.timer_seconds,
                selected_option: null
            }));
            $('#quiz-id').val(quizId);
            $('#solveQuizModalLabel').text(`Solve Quiz: ${escapeHtml(response.title)}`);
            $('#solve-quiz-form').attr('action', `{% url 'students:submit_quiz' 0 %}`.replace('0', quizId));
            currentQuestionIndex = 0;
            openModal();
            showQuestion(currentQuestionIndex);
        },
        error: function(xhr, status, error) {
            console.error('Error fetching quiz:', xhr.responseText, status, error);
            alert('Failed to load quiz data: ' + (xhr.responseJSON?.message || error));
        }
    });
});

$(document).on('click', '#prev-question', function() {
    if (currentQuestionIndex > 0) {
        const selected = $(`input[name="answers[${currentQuestionIndex}]"]:checked`).val();
        questions[currentQuestionIndex].selected_option = selected ? parseInt(selected) : null;
        showQuestion(currentQuestionIndex - 1);
    }
});

$(document).on('click', '#next-question', function() {
    if (currentQuestionIndex < questions.length - 1) {
        const selected = $(`input[name="answers[${currentQuestionIndex}]"]:checked`).val();
        questions[currentQuestionIndex].selected_option = selected ? parseInt(selected) : null;
        showQuestion(currentQuestionIndex + 1);
    }
});

$('#solve-quiz-form').on('submit', function(e) {
    e.preventDefault();
    const selected = $(`input[name="answers[${currentQuestionIndex}]"]:checked`).val();
    questions[currentQuestionIndex].selected_option = selected ? parseInt(selected) : null;
    console.log('Submitting quiz with answers:', questions);

    let formData = new FormData(this);
    questions.forEach((q, index) => {
        if (q.selected_option) {
            formData.set(`answers[${q.id}]`, q.selected_option);
        } else {
            formData.set(`answers[${q.id}]`, '');
        }
    });

    $.ajax({
        url: $(this).attr('action'),
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            console.log('Quiz submission response received');
            document.open();
            document.write(response);
            document.close();
            clearInterval(timerInterval);
            closeModal();
        },
        error: function(xhr, status, error) {
            console.error('AJAX error:', status, error, xhr.responseText);
            alert('An error occurred: ' + (xhr.responseJSON?.message || error));
        }
    });
});
</script>
{% endblock %}