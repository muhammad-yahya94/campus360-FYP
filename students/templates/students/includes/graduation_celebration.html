{% load static %}

<!-- Canvas for fireworks -->
<canvas id="fireworks-canvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: none;"></canvas>

<!-- Graduation Celebration Modal -->
<div id="graduation-modal" class="modal modal-bottom sm:modal-middle" style="display: none;">
  <div class="modal-box bg-gradient-to-br from-primary to-secondary text-primary-content">
    <h3 class="font-bold text-3xl text-center mb-4">ðŸŽ“ Congratulations! ðŸŽ“</h3>
    <p class="py-4 text-center text-xl">You've successfully graduated! We're so proud of your achievement!</p>
    <div class="flex justify-center mt-6">
      <button onclick="stopCelebration()" class="btn btn-accent">Continue to Dashboard</button>
    </div>
  </div>
</div>

<!-- Audio for celebration -->
<audio id="celebration-audio" preload="auto">
  <source src="{% static 'audio/graduation.mp3' %}" type="audio/mp3">
  Your browser does not support the audio element.
</audio>

{% if is_graduated %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
// Celebration functions
function startCelebration() {
    // Show fireworks canvas
    const canvas = document.getElementById('fireworks-canvas');
    canvas.style.display = 'block';
    
    // Show modal
    const modal = document.getElementById('graduation-modal');
    modal.style.display = 'block';
    modal.classList.add('modal-open');
    
    // Play audio with user interaction
    const audio = document.getElementById('celebration-audio');
    audio.volume = 0.5;
    audio.loop = true;
    
    // First, ensure audio is loaded
    audio.load();
    
    // Try to play the audio
    const playAudio = () => {
      const playPromise = audio.play();
      
      // Handle any errors
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log('Audio play was prevented:', error);
          // Show a message to the user that they need to interact to hear sound
          const modal = document.getElementById('graduation-modal');
          const message = document.createElement('p');
          message.className = 'text-sm text-center mt-2 text-warning';
          message.textContent = 'Click anywhere to enable sound';
          modal.querySelector('.modal-box').appendChild(message);
          
          // Add click handler to play audio on user interaction
          const playOnInteraction = () => {
            audio.play().catch(e => console.log('Audio still failed:', e));
            document.removeEventListener('click', playOnInteraction);
            if (message.parentNode) {
              message.remove();
            }
          };
          
          document.addEventListener('click', playOnInteraction, { once: true });
        });
      }
    };
    
    // Initial play attempt
    playAudio();
    
    // Start confetti
    const duration = 15 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 1000 };
    
    function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
    }
    
    const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();
        
        if (timeLeft <= 0) {
            return clearInterval(interval);
        }
        
        const particleCount = 50 * (timeLeft / duration);
        confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
        });
        confetti({
            ...defaults,
            particleCount,
            origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
        });
    }, 250);
    
    // Stop after duration
    setTimeout(stopCelebration, duration);
}

function stopCelebration() {
    const canvas = document.getElementById('fireworks-canvas');
    const modal = document.getElementById('graduation-modal');
    const audio = document.getElementById('celebration-audio');
    
    canvas.style.display = 'none';
    modal.style.display = 'none';
    modal.classList.remove('modal-open');
    audio.pause();
    audio.currentTime = 0;
}

// Start celebration when page loads
window.addEventListener('load', function() {
    // Small delay to ensure everything is loaded
    setTimeout(startCelebration, 1000);
});
</script>

<style>
/* Add some animations */
@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
    100% { transform: translateY(0px); }
}

.graduation-cap {
    animation: float 3s ease-in-out infinite;
    display: inline-block;
    margin: 0 5px;
}

/* Modal styles */
.modal {
    transition: opacity 0.25s ease;
}

.modal-box {
    transition: transform 0.3s ease-out;
    transform: translateY(100%);
}

.modal.modal-open .modal-box {
    transform: translateY(0);
}
</style>
{% endif %}
