{% extends 'base_student.html' %}

{% block title %}Submit Assignment - {{ assignment.title }}{% endblock %}

{% block content %}
<!-- Quill CDN -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<style>
    #submissionText .ql-container {
        min-height: 384px; /* Matches h-96 (24rem) */
        height: 100%;
        overflow-y: auto;
        border: 1px solid theme('colors.base-300');
        border-radius: 0.375rem; /* Matches rounded-md */
    }
    #submissionText .ql-editor {
        min-height: 340px; /* Accounts for toolbar height (~44px) */
        padding: 0.75rem; /* Matches input-bordered padding */
    }
</style>
<style>
    p > img {
       width: 200px;
       height: auto;
       cursor: pointer;
       transition: transform 0.2s;
   }
   p > img:hover {
       transform: scale(1.05);
       box-shadow: 0 4px 8px rgba(0,0,0,0.1);
   }
   </style>
   <script>
   document.addEventListener('DOMContentLoaded', function() {
       // Make images clickable to open in new tab
       document.querySelectorAll('.ql-editor img').forEach(img => {
           img.style.cursor = 'pointer';
           img.addEventListener('click', function() {
               window.open(this.src, '_blank');
           });
       });
   });
   </script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var quill = new Quill('#submissionText', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    ['image', 'link', 'blockquote'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        // Handle image uploads with resizing
        quill.getModule('toolbar').addHandler('image', function() {
            var input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            input.onchange = async function() {
                var file = input.files[0];
                if (!file) return;

                // Resize image
                const maxDimension = 800; // Max width or height in pixels
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                try {
                    // Load image
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = URL.createObjectURL(file);
                    });

                    // Calculate new dimensions
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxDimension) {
                            height = Math.round((height * maxDimension) / width);
                            width = maxDimension;
                        }
                    } else {
                        if (height > maxDimension) {
                            width = Math.round((width * maxDimension) / height);
                            height = maxDimension;
                        }
                    }

                    // Resize image on canvas
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to Blob
                    const resizedBlob = await new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/jpeg', 0.8); // JPEG, 80% quality
                    });
                    URL.revokeObjectURL(img.src); // Clean up

                    // Prepare FormData with resized image
                    var formData = new FormData();
                    formData.append('file', resizedBlob, file.name.replace(/\.[^/.]+$/, '.jpg'));

                    // Send to server
                    const response = await fetch('{% url "students:upload_image" %}', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    const data = await response.json();
                    if (data.url) {
                        var range = quill.getSelection();
                        if (range) {
                            quill.insertEmbed(range.index, 'image', data.url);
                        } else {
                            quill.insertEmbed(quill.getLength(), 'image', data.url);
                        }
                    } else {
                        console.error('Image upload failed:', data.error);
                        alert('Failed to upload image: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error processing image:', error);
                    alert('Failed to process image: ' + (error.message || 'Unknown error'));
                }
            };
        });

        // Populate form content on submit
        document.querySelector('form').onsubmit = function() {
            document.querySelector('#submissionContent').value = quill.root.innerHTML;
        };
    });
</script>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <!-- Header Section -->

  <div class="hero bg-base-200 rounded-lg shadow-lg mb-6">
    <div class="hero-content text-center">
      <div class="max-w-md">
        <h1 class="text-3xl sm:text-4xl font-bold text-base-content mb-2">Submit Assignment</h1>
        <p class="text-base sm:text-lg text-base-content/90">        {{ assignment.title }} - {{ assignment.course_offering.course.name }} ({{ assignment.course_offering.course.code }})</p>
      </div>
    </div>
  </div>

  <!-- Submission Form -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <h4 class="text-xl font-semibold text-base-content mb-4">
        Course: {{ assignment.course_offering.course.name }} ({{ assignment.course_offering.course.code }})
      </h4>
      <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        <div>
          <label for="submissionText" class="block text-sm font-medium text-base-content">Submission Content</label>
          <div id="submissionText" class="mt-2 rounded-md"></div>
          <input type="hidden" id="submissionContent" name="content">
        </div>
        <div>
          <label for="fileUpload" class="block text-sm font-medium text-base-content">Upload File</label>
          <input type="file" class="file-input file-input-bordered w-full mt-2" id="fileUpload" name="files">
        </div>
        <button type="submit" class="btn btn-primary">Submit Assignment</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}