{% extends 'base_student.html' %}
{% load static %}

{% block title %}Submit Assignment - {{ assignment.title }}{% endblock %}

{% block content %}
<!-- Quill -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/clike/clike.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/monokai.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">

<style>
    .CodeMirror {
        height: 400px;
        font-family: monospace;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .ql-container {
        height: 500px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .ql-toolbar {
        border-radius: 8px 8px 0 0;
    }
    .hidden {
        display: none !important;
    }
    .btn-primary {
        background-color: #2563eb;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }
    .btn-primary:hover {
        background-color: #1e40af;
    }
    .btn-outline {
        border: 1px solid #64748b;
        color: #64748b;
        padding: 6px 12px;
        border-radius: 8px;
        transition: all 0.3s;
    }
    .btn-outline:hover {
        color: #1e40af;
    }
    .select-bordered {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
    }
    .file-input-bordered {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="container mx-auto py-6">
    <h1 class="text-3xl font-bold mb-4 text-gray-800">Submit Assignment</h1>
    <h2 class="text-lg text-gray-500 mb-6">{{ assignment.title }} - {{ assignment.course_offering.course.name }}</h2>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mb-6 flex justify-between items-center">
            <label class="font-semibold text-gray-700">Submission Content:</label>
            <button type="button" id="toggleCodeEditor" class="btn btn-sm btn-outline">
                <i class="fas fa-code mr-1"></i> Code Editor
            </button>
        </div>

        <!-- Quill -->
        <div id="submissionText"></div>

        <!-- CodeMirror -->
        <div id="code-editor-container" class="hidden">
            <div class="mb-3 flex gap-3">
                <select id="language" class="select select-bordered select-sm">
                    <option value="none">Select Language</option>
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                </select>
                <select id="theme" class="select select-bordered select-sm">
                    <option value="monokai">Monokai</option>
                    <option value="dracula">Dracula</option>
                </select>
            </div>
            <textarea id="code-editor"></textarea>
        </div>

        <input type="hidden" id="submissionContent" name="content">
        <input type="hidden" id="submissionType" name="submission_type" value="text">
        <input type="hidden" id="codeLanguage" name="code_language" value="none">

        <div class="mb-6">
            <label for="fileUpload" class="block mb-2 font-semibold text-gray-700">Upload File</label>
            <input type="file" id="fileUpload" name="files" class="file-input file-input-bordered w-full">
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Quill with disabled copy-paste
    const quill = new Quill('#submissionText', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ header: [1, 2, false] }],
                ['bold', 'italic', 'underline'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['link', 'image'],
                ['clean']
            ],
            keyboard: {
                bindings: {
                    // Disable Ctrl+C, Ctrl+V, Ctrl+X
                    copy: { key: 'c', ctrlKey: true, handler: () => false },
                    paste: { key: 'v', ctrlKey: true, handler: () => false },
                    cut: { key: 'x', ctrlKey: true, handler: () => false }
                }
            }
        }
    });

    // Initialize CodeMirror
    const codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
        mode: 'text',
        theme: 'monokai',
        lineNumbers: true,
        tabSize: 4,
        lineWrapping: true
    });

    // Elements
    const toggleButton = document.getElementById('toggleCodeEditor');
    const submissionText = document.getElementById('submissionText');
    const codeEditorContainer = document.getElementById('code-editor-container');
    const submissionType = document.getElementById('submissionType');
    const submissionContent = document.getElementById('submissionContent');
    const codeLanguage = document.getElementById('codeLanguage');

    // Ensure only one editor is visible at a time
    function toggleEditors(showCode) {
        if (showCode) {
            codeEditorContainer.classList.remove('hidden');
            submissionText.classList.add('hidden');
            submissionType.value = 'code';
            toggleButton.innerHTML = `<i class="fas fa-font mr-1"></i> Rich Text`;
            setTimeout(() => codeEditor.refresh(), 0);
        } else {
            codeEditorContainer.classList.add('hidden');
            submissionText.classList.remove('hidden');
            submissionType.value = 'text';
            toggleButton.innerHTML = `<i class="fas fa-code mr-1"></i> Code Editor`;
        }
    }

    // Initialize with rich text editor visible
    toggleEditors(false);

    // Prevent copy, cut, paste, and context menu in Quill
    const quillEditor = document.querySelector('.ql-editor');
    if (quillEditor) {
        ['copy', 'cut', 'paste', 'contextmenu'].forEach(event => {
            quillEditor.addEventListener(event, e => {
                e.preventDefault();
                e.stopPropagation();
            }, true);
        });

        // Disable keyboard shortcuts for copy/paste/cut
        quillEditor.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && [67, 86, 88].includes(e.keyCode)) {
                e.preventDefault();
                e.stopPropagation();
            }
            if (e.keyCode === 93) { // Context menu key
                e.preventDefault();
            }
        }, true);
    }

    // Prevent copy, cut, paste, and context menu in CodeMirror
    const codeMirror = document.querySelector('.CodeMirror');
    if (codeMirror) {
        ['copy', 'cut', 'paste', 'contextmenu'].forEach(event => {
            codeMirror.addEventListener(event, e => {
                e.preventDefault();
                e.stopPropagation();
            }, true);
        });

        // Disable keyboard shortcuts in CodeMirror
        codeEditor.on('keydown', (cm, e) => {
            if ((e.ctrlKey || e.metaKey) && [67, 86, 88].includes(e.keyCode)) {
                e.preventDefault();
                e.stopPropagation();
            }
            if (e.keyCode === 93) { // Context menu key
                e.preventDefault();
            }
        });
    }

    // Toggle Editors
    toggleButton.addEventListener('click', function () {
        const showCode = !codeEditorContainer.classList.contains('hidden');
        toggleEditors(!showCode);
    });

    // Language + Theme
    document.getElementById('language').addEventListener('change', function () {
        const modes = {
            python: 'python',
            javascript: 'javascript',
            html: 'htmlmixed',
            css: 'css',
            c: 'text/x-csrc',
            cpp: 'text/x-c++src',
            none: 'text'
        };
        codeEditor.setOption('mode', modes[this.value] || 'text');
        codeLanguage.value = this.value;
    });

    document.getElementById('theme').addEventListener('change', function () {
        codeEditor.setOption('theme', this.value);
    });

    // Form submit
    document.querySelector('form').addEventListener('submit', function () {
        if (submissionType.value === 'text') {
            submissionContent.value = quill.root.innerHTML;
            codeLanguage.value = 'none';
        } else {
            submissionContent.value = codeEditor.getValue();
        }
    });

    // Add code toggle button in toolbar using requestAnimationFrame
    const toolbar = quill.getModule('toolbar');
    if (toolbar) {
        requestAnimationFrame(() => {
            const codeButton = document.createElement('button');
            codeButton.type = 'button';
            codeButton.className = 'ql-code-toggle';
            codeButton.innerHTML = '<i class="fas fa-code"></i>';
            codeButton.title = 'Toggle Code Editor';

            const toolbarEl = toolbar.container;
            const cleanBtn = toolbarEl.querySelector('.ql-clean');
            if (cleanBtn && toolbarEl.contains(cleanBtn)) {
                toolbarEl.insertBefore(codeButton, cleanBtn);
            } else {
                toolbarEl.appendChild(codeButton);
            }

            codeButton.addEventListener('click', () => {
                toggleButton.click();
            });
        });
    }
});
</script>
{% endblock %}